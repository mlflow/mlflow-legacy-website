
  

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>mlflow.pyfunc</title>
  
   
  <link rel="canonical" href="https://www.mlflow.org/docs/latest/_modules/mlflow/pyfunc.html">
  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    

    

  
    
        <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','GTM-WXWDBL');</script>
      

  

  
  
    

  

  
  
    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600" rel="stylesheet">
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
    
    <link rel="stylesheet" href="../../_static/css/algolia.css" type="text/css" />
    
  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="MLflow 1.21.0 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  

  
  <nav class="wy-nav-top header" role="navigation" aria-label="top navigation">
    <ul>
  <li class="menu-toggle">
    <i data-toggle="wy-nav-top" class="wy-nav-top-menu-button db-icon db-icon-menu pull-left"></i>
    <a href="../../index.html" class="wy-nav-top-logo"
      ><img src="../../_static/MLflow-logo-final-black.png" alt="MLflow"
    /></a>
    <span class="version">1.21.0</span>
  </li>
</ul>
  </nav>
  <page>
    

    <nav data-toggle="wy-nav-shift" class="wy-nav-side relative">
      <div class="wy-side-scroll">
  <div class="wy-side-nav-search">
    

    

    
<div role="search">
  
  <input id="algolia-search" type="text" name="q" placeholder="Search" />
  
</div>


    
  </div>

  <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
    
      <a href="../../index.html" class="main-navigation-home"><img src="../../_static/icons/nav-home.svg"> MLflow</a>
    

    
      

      
        <ul>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials-and-examples/index.html">Tutorials and Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../concepts.html">Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tracking.html">MLflow Tracking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../projects.html">MLflow Projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../models.html">MLflow Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model-registry.html">MLflow Model Registry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plugins.html">MLflow Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cli.html">Command-Line Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../search-syntax.html">Search</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python_api/index.html">Python API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../R-api.html">R API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../java_api/index.html">Java API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rest-api.html">REST API</a></li>
</ul>

      
    
  </div>

  <div role="contentinfo">
    

    <p>
      <a id='feedbacklink' href="https://github.com/mlflow/mlflow/blob/master/CONTRIBUTING.rst" target="_blank">Contribute</a>
    </p>
  </div>
</div>
    </nav>

    <main class="wy-grid-for-nav">
      <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
        <div class="wy-nav-content">
          <div class="rst-content">
            










<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Documentation</a> <span class="db-icon db-icon-chevron-right"></span></li>
    
        <li><a href="../index.html">Module code</a> <span class="db-icon db-icon-chevron-right"></span></li>
    
    
      <li>mlflow.pyfunc</li>
    
    
    <li class="wy-breadcrumbs-aside">
      <a href="https://github.com/mlflow/mlflow/blob/master/docs/source/_modules/mlflow/pyfunc" class="fa fa-github"> Edit on GitHub</a>
    </li>
    
  </ul>
</div>
            <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
              <div itemprop="articleBody">
                
  <h1>Source code for mlflow.pyfunc</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The ``python_function`` model flavor serves as a default model interface for MLflow Python models.</span>
<span class="sd">Any MLflow Python model is expected to be loadable as a ``python_function`` model.</span>

<span class="sd">In addition, the ``mlflow.pyfunc`` module defines a generic :ref:`filesystem format</span>
<span class="sd">&lt;pyfunc-filesystem-format&gt;` for Python models and provides utilities for saving to and loading from</span>
<span class="sd">this format. The format is self contained in the sense that it includes all necessary information</span>
<span class="sd">for anyone to load it and use it. Dependencies are either stored directly with the model or</span>
<span class="sd">referenced via a Conda environment.</span>

<span class="sd">The ``mlflow.pyfunc`` module also defines utilities for creating custom ``pyfunc`` models</span>
<span class="sd">using frameworks and inference logic that may not be natively included in MLflow. See</span>
<span class="sd">:ref:`pyfunc-create-custom`.</span>

<span class="sd">.. _pyfunc-inference-api:</span>

<span class="sd">*************</span>
<span class="sd">Inference API</span>
<span class="sd">*************</span>

<span class="sd">Python function models are loaded as an instance of :py:class:`PyFuncModel</span>
<span class="sd">&lt;mlflow.pyfunc.PyFuncModel&gt;`, which is an MLflow wrapper around the model implementation and model</span>
<span class="sd">metadata (MLmodel file). You can score the model by calling the :py:func:`predict()</span>
<span class="sd">&lt;mlflow.pyfunc.PyFuncModel.predict&gt;` method, which has the following signature::</span>

<span class="sd">  predict(</span>
<span class="sd">    model_input: [pandas.DataFrame, Dict[str, numpy.ndarray], numpy.ndarray]</span>
<span class="sd">  ) -&gt; [numpy.ndarray | pandas.(Series | DataFrame)]</span>

<span class="sd">All PyFunc models will support `pandas.DataFrame` as input and DL PyFunc models will also support</span>
<span class="sd">tensor inputs in the form of Dict[str, numpy.ndarray] (named tensors) and `numpy.ndarrays`</span>
<span class="sd">(unnamed tensors).</span>


<span class="sd">.. _pyfunc-filesystem-format:</span>

<span class="sd">*****************</span>
<span class="sd">Filesystem format</span>
<span class="sd">*****************</span>

<span class="sd">The Pyfunc format is defined as a directory structure containing all required data, code, and</span>
<span class="sd">configuration::</span>

<span class="sd">    ./dst-path/</span>
<span class="sd">        ./MLmodel: configuration</span>
<span class="sd">        &lt;code&gt;: code packaged with the model (specified in the MLmodel file)</span>
<span class="sd">        &lt;data&gt;: data packaged with the model (specified in the MLmodel file)</span>
<span class="sd">        &lt;env&gt;: Conda environment definition (specified in the MLmodel file)</span>

<span class="sd">The directory structure may contain additional contents that can be referenced by the ``MLmodel``</span>
<span class="sd">configuration.</span>

<span class="sd">.. _pyfunc-model-config:</span>

<span class="sd">MLModel configuration</span>
<span class="sd">#####################</span>

<span class="sd">A Python model contains an ``MLmodel`` file in **python_function** format in its root with the</span>
<span class="sd">following parameters:</span>

<span class="sd">- loader_module [required]:</span>
<span class="sd">         Python module that can load the model. Expected as module identifier</span>
<span class="sd">         e.g. ``mlflow.sklearn``, it will be imported using ``importlib.import_module``.</span>
<span class="sd">         The imported module must contain a function with the following signature::</span>

<span class="sd">          _load_pyfunc(path: string) -&gt; &lt;pyfunc model implementation&gt;</span>

<span class="sd">         The path argument is specified by the ``data`` parameter and may refer to a file or</span>
<span class="sd">         directory. The model implementation is expected to be an object with a</span>
<span class="sd">         ``predict`` method with the following signature::</span>

<span class="sd">          predict(</span>
<span class="sd">              model_input: [pandas.DataFrame, Dict[str, numpy.ndarray], numpy.ndarray]</span>
<span class="sd">          ) -&gt; [numpy.ndarray | pandas.(Series | DataFrame)]</span>

<span class="sd">- code [optional]:</span>
<span class="sd">        Relative path to a directory containing the code packaged with this model.</span>
<span class="sd">        All files and directories inside this directory are added to the Python path</span>
<span class="sd">        prior to importing the model loader.</span>

<span class="sd">- data [optional]:</span>
<span class="sd">         Relative path to a file or directory containing model data.</span>
<span class="sd">         The path is passed to the model loader.</span>

<span class="sd">- env [optional]:</span>
<span class="sd">         Relative path to an exported Conda environment. If present this environment</span>
<span class="sd">         should be activated prior to running the model.</span>

<span class="sd">- Optionally, any additional parameters necessary for interpreting the serialized model in</span>
<span class="sd">  ``pyfunc`` format.</span>

<span class="sd">.. rubric:: Example</span>

<span class="sd">::</span>

<span class="sd">    tree example/sklearn_iris/mlruns/run1/outputs/linear-lr</span>

<span class="sd">::</span>

<span class="sd">  ├── MLmodel</span>
<span class="sd">  ├── code</span>
<span class="sd">  │   ├── sklearn_iris.py</span>
<span class="sd">  │</span>
<span class="sd">  ├── data</span>
<span class="sd">  │   └── model.pkl</span>
<span class="sd">  └── mlflow_env.yml</span>

<span class="sd">::</span>

<span class="sd">    cat example/sklearn_iris/mlruns/run1/outputs/linear-lr/MLmodel</span>

<span class="sd">::</span>

<span class="sd">  python_function:</span>
<span class="sd">    code: code</span>
<span class="sd">    data: data/model.pkl</span>
<span class="sd">    loader_module: mlflow.sklearn</span>
<span class="sd">    env: mlflow_env.yml</span>
<span class="sd">    main: sklearn_iris</span>

<span class="sd">.. _pyfunc-create-custom:</span>

<span class="sd">******************************</span>
<span class="sd">Creating custom Pyfunc models</span>
<span class="sd">******************************</span>

<span class="sd">MLflow&#39;s persistence modules provide convenience functions for creating models with the</span>
<span class="sd">``pyfunc`` flavor in a variety of machine learning frameworks (scikit-learn, Keras, Pytorch, and</span>
<span class="sd">more); however, they do not cover every use case. For example, you may want to create an MLflow</span>
<span class="sd">model with the ``pyfunc`` flavor using a framework that MLflow does not natively support.</span>
<span class="sd">Alternatively, you may want to build an MLflow model that executes custom logic when evaluating</span>
<span class="sd">queries, such as preprocessing and postprocessing routines. Therefore, ``mlflow.pyfunc``</span>
<span class="sd">provides utilities for creating ``pyfunc`` models from arbitrary code and model data.</span>

<span class="sd">The :meth:`save_model()` and :meth:`log_model()` methods are designed to support multiple workflows</span>
<span class="sd">for creating custom ``pyfunc`` models that incorporate custom inference logic and artifacts</span>
<span class="sd">that the logic may require.</span>

<span class="sd">An `artifact` is a file or directory, such as a serialized model or a CSV. For example, a</span>
<span class="sd">serialized TensorFlow graph is an artifact. An MLflow model directory is also an artifact.</span>

<span class="sd">.. _pyfunc-create-custom-workflows:</span>

<span class="sd">Workflows</span>
<span class="sd">#########</span>

<span class="sd">:meth:`save_model()` and :meth:`log_model()` support the following workflows:</span>

<span class="sd">1. Programmatically defining a new MLflow model, including its attributes and artifacts.</span>

<span class="sd">   Given a set of artifact URIs, :meth:`save_model()` and :meth:`log_model()` can</span>
<span class="sd">   automatically download artifacts from their URIs and create an MLflow model directory.</span>

<span class="sd">   In this case, you must define a Python class which inherits from :class:`~PythonModel`,</span>
<span class="sd">   defining ``predict()`` and, optionally, ``load_context()``. An instance of this class is</span>
<span class="sd">   specified via the ``python_model`` parameter; it is automatically serialized and deserialized</span>
<span class="sd">   as a Python class, including all of its attributes.</span>

<span class="sd">2. Interpreting pre-existing data as an MLflow model.</span>

<span class="sd">   If you already have a directory containing model data, :meth:`save_model()` and</span>
<span class="sd">   :meth:`log_model()` can import the data as an MLflow model. The ``data_path`` parameter</span>
<span class="sd">   specifies the local filesystem path to the directory containing model data.</span>

<span class="sd">   In this case, you must provide a Python module, called a `loader module`. The</span>
<span class="sd">   loader module defines a ``_load_pyfunc()`` method that performs the following tasks:</span>

<span class="sd">   - Load data from the specified ``data_path``. For example, this process may include</span>
<span class="sd">     deserializing pickled Python objects or models or parsing CSV files.</span>

<span class="sd">   - Construct and return a pyfunc-compatible model wrapper. As in the first</span>
<span class="sd">     use case, this wrapper must define a ``predict()`` method that is used to evaluate</span>
<span class="sd">     queries. ``predict()`` must adhere to the :ref:`pyfunc-inference-api`.</span>

<span class="sd">   The ``loader_module`` parameter specifies the name of your loader module.</span>

<span class="sd">   For an example loader module implementation, refer to the `loader module</span>
<span class="sd">   implementation in mlflow.keras &lt;https://github.com/mlflow/mlflow/blob/</span>
<span class="sd">   74d75109aaf2975f5026104d6125bb30f4e3f744/mlflow/keras.py#L157-L187&gt;`_.</span>

<span class="sd">.. _pyfunc-create-custom-selecting-workflow:</span>

<span class="sd">Which workflow is right for my use case?</span>
<span class="sd">########################################</span>

<span class="sd">We consider the first workflow to be more user-friendly and generally recommend it for the</span>
<span class="sd">following reasons:</span>

<span class="sd">- It automatically resolves and collects specified model artifacts.</span>

<span class="sd">- It automatically serializes and deserializes the ``python_model`` instance and all of</span>
<span class="sd">  its attributes, reducing the amount of user logic that is required to load the model</span>

<span class="sd">- You can create Models using logic that is defined in the ``__main__`` scope. This allows</span>
<span class="sd">  custom models to be constructed in interactive environments, such as notebooks and the Python</span>
<span class="sd">  REPL.</span>

<span class="sd">You may prefer the second, lower-level workflow for the following reasons:</span>

<span class="sd">- Inference logic is always persisted as code, rather than a Python object. This makes logic</span>
<span class="sd">  easier to inspect and modify later.</span>

<span class="sd">- If you have already collected all of your model data in a single location, the second</span>
<span class="sd">  workflow allows it to be saved in MLflow format directly, without enumerating constituent</span>
<span class="sd">  artifacts.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">importlib</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span>
<span class="kn">import</span> <span class="nn">mlflow</span>
<span class="kn">import</span> <span class="nn">mlflow.pyfunc.model</span>
<span class="kn">import</span> <span class="nn">mlflow.pyfunc.utils</span>
<span class="kn">from</span> <span class="nn">mlflow.models</span> <span class="kn">import</span> <span class="n">Model</span><span class="p">,</span> <span class="n">ModelSignature</span><span class="p">,</span> <span class="n">ModelInputExample</span>
<span class="kn">from</span> <span class="nn">mlflow.models.model</span> <span class="kn">import</span> <span class="n">MLMODEL_FILE_NAME</span>
<span class="kn">from</span> <span class="nn">mlflow.models.utils</span> <span class="kn">import</span> <span class="n">_save_example</span>
<span class="kn">from</span> <span class="nn">mlflow.pyfunc.model</span> <span class="kn">import</span> <span class="p">(</span>  <span class="c1"># pylint: disable=unused-import</span>
    <span class="n">PythonModel</span><span class="p">,</span>
    <span class="n">PythonModelContext</span><span class="p">,</span>
    <span class="n">get_default_conda_env</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">mlflow.pyfunc.model</span> <span class="kn">import</span> <span class="n">get_default_pip_requirements</span>
<span class="kn">from</span> <span class="nn">mlflow.tracking.artifact_utils</span> <span class="kn">import</span> <span class="n">_download_artifact_from_uri</span>
<span class="kn">from</span> <span class="nn">mlflow.types</span> <span class="kn">import</span> <span class="n">DataType</span><span class="p">,</span> <span class="n">Schema</span><span class="p">,</span> <span class="n">TensorSpec</span>
<span class="kn">from</span> <span class="nn">mlflow.types.utils</span> <span class="kn">import</span> <span class="n">clean_tensor_type</span>
<span class="kn">from</span> <span class="nn">mlflow.utils</span> <span class="kn">import</span> <span class="n">PYTHON_VERSION</span><span class="p">,</span> <span class="n">get_major_minor_py_version</span>
<span class="kn">from</span> <span class="nn">mlflow.utils.annotations</span> <span class="kn">import</span> <span class="n">deprecated</span>
<span class="kn">from</span> <span class="nn">mlflow.utils.file_utils</span> <span class="kn">import</span> <span class="n">TempDir</span><span class="p">,</span> <span class="n">_copy_file_or_tree</span><span class="p">,</span> <span class="n">write_to</span>
<span class="kn">from</span> <span class="nn">mlflow.utils.model_utils</span> <span class="kn">import</span> <span class="n">_get_flavor_configuration</span>
<span class="kn">from</span> <span class="nn">mlflow.utils.environment</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">_validate_env_arguments</span><span class="p">,</span>
    <span class="n">_process_pip_requirements</span><span class="p">,</span>
    <span class="n">_process_conda_env</span><span class="p">,</span>
    <span class="n">_CONDA_ENV_FILE_NAME</span><span class="p">,</span>
    <span class="n">_REQUIREMENTS_FILE_NAME</span><span class="p">,</span>
    <span class="n">_CONSTRAINTS_FILE_NAME</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">mlflow.utils.docstring_utils</span> <span class="kn">import</span> <span class="n">format_docstring</span><span class="p">,</span> <span class="n">LOG_MODEL_PARAM_DOCS</span>
<span class="kn">from</span> <span class="nn">mlflow.exceptions</span> <span class="kn">import</span> <span class="n">MlflowException</span>
<span class="kn">from</span> <span class="nn">mlflow.tracking._model_registry</span> <span class="kn">import</span> <span class="n">DEFAULT_AWAIT_MAX_SLEEP_SECONDS</span>
<span class="kn">from</span> <span class="nn">mlflow.protos.databricks_pb2</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">INVALID_PARAMETER_VALUE</span><span class="p">,</span>
    <span class="n">RESOURCE_ALREADY_EXISTS</span><span class="p">,</span>
    <span class="n">RESOURCE_DOES_NOT_EXIST</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">FLAVOR_NAME</span> <span class="o">=</span> <span class="s2">&quot;python_function&quot;</span>
<span class="n">MAIN</span> <span class="o">=</span> <span class="s2">&quot;loader_module&quot;</span>
<span class="n">CODE</span> <span class="o">=</span> <span class="s2">&quot;code&quot;</span>
<span class="n">DATA</span> <span class="o">=</span> <span class="s2">&quot;data&quot;</span>
<span class="n">ENV</span> <span class="o">=</span> <span class="s2">&quot;env&quot;</span>
<span class="n">PY_VERSION</span> <span class="o">=</span> <span class="s2">&quot;python_version&quot;</span>

<span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">PyFuncInput</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>
<span class="n">PyFuncOutput</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span>


<div class="viewcode-block" id="add_to_model"><a class="viewcode-back" href="../../python_api/mlflow.pyfunc.html#mlflow.pyfunc.add_to_model">[docs]</a><span class="k">def</span> <span class="nf">add_to_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">loader_module</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add a ``pyfunc`` spec to the model configuration.</span>

<span class="sd">    Defines ``pyfunc`` configuration schema. Caller can use this to create a valid ``pyfunc`` model</span>
<span class="sd">    flavor out of an existing directory structure. For example, other model flavors can use this to</span>
<span class="sd">    specify how to use their output as a ``pyfunc``.</span>

<span class="sd">    NOTE:</span>

<span class="sd">        All paths are relative to the exported model root directory.</span>

<span class="sd">    :param model: Existing model.</span>
<span class="sd">    :param loader_module: The module to be used to load the model.</span>
<span class="sd">    :param data: Path to the model data.</span>
<span class="sd">    :param code: Path to the code dependencies.</span>
<span class="sd">    :param env: Conda environment.</span>
<span class="sd">    :param req: pip requirements file.</span>
<span class="sd">    :param kwargs: Additional key-value pairs to include in the ``pyfunc`` flavor specification.</span>
<span class="sd">                   Values must be YAML-serializable.</span>
<span class="sd">    :return: Updated model configuration.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">params</span><span class="p">[</span><span class="n">MAIN</span><span class="p">]</span> <span class="o">=</span> <span class="n">loader_module</span>
    <span class="n">params</span><span class="p">[</span><span class="n">PY_VERSION</span><span class="p">]</span> <span class="o">=</span> <span class="n">PYTHON_VERSION</span>
    <span class="k">if</span> <span class="n">code</span><span class="p">:</span>
        <span class="n">params</span><span class="p">[</span><span class="n">CODE</span><span class="p">]</span> <span class="o">=</span> <span class="n">code</span>
    <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">params</span><span class="p">[</span><span class="n">DATA</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
    <span class="k">if</span> <span class="n">env</span><span class="p">:</span>
        <span class="n">params</span><span class="p">[</span><span class="n">ENV</span><span class="p">]</span> <span class="o">=</span> <span class="n">env</span>

    <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">add_flavor</span><span class="p">(</span><span class="n">FLAVOR_NAME</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_load_model_env</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get ENV file string from a model configuration stored in Python Function format.</span>
<span class="sd">    Returned value is a model-relative path to a Conda Environment file,</span>
<span class="sd">    or None if none was specified at model save time</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_get_flavor_configuration</span><span class="p">(</span><span class="n">model_path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">flavor_name</span><span class="o">=</span><span class="n">FLAVOR_NAME</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ENV</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_enforce_mlflow_datatype</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="n">DataType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Enforce the input column type matches the declared in model input schema.</span>

<span class="sd">    The following type conversions are allowed:</span>

<span class="sd">    1. np.object -&gt; string</span>
<span class="sd">    2. int -&gt; long (upcast)</span>
<span class="sd">    3. float -&gt; double (upcast)</span>
<span class="sd">    4. int -&gt; double (safe conversion)</span>
<span class="sd">    5. np.datetime64[x] -&gt; datetime (any precision)</span>
<span class="sd">    6. np.object -&gt; datetime</span>

<span class="sd">    Any other type mismatch will raise error.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">values</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">object</span> <span class="ow">and</span> <span class="n">t</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">DataType</span><span class="o">.</span><span class="n">binary</span><span class="p">,</span> <span class="n">DataType</span><span class="o">.</span><span class="n">string</span><span class="p">):</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">infer_objects</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="n">DataType</span><span class="o">.</span><span class="n">string</span> <span class="ow">and</span> <span class="n">values</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">object</span><span class="p">:</span>
        <span class="c1">#  NB: strings are by default parsed and inferred as objects, but it is</span>
        <span class="c1"># recommended to use StringDtype extension type if available. See</span>
        <span class="c1">#</span>
        <span class="c1"># `https://pandas.pydata.org/pandas-docs/stable/user_guide/text.html`</span>
        <span class="c1">#</span>
        <span class="c1"># for more detail.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">(),</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;raise&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
                <span class="s2">&quot;Failed to convert column </span><span class="si">{0}</span><span class="s2"> from type </span><span class="si">{1}</span><span class="s2"> to </span><span class="si">{2}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">values</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="c1"># NB: Comparison of pandas and numpy data type fails when numpy data type is on the left hand</span>
    <span class="c1"># side of the comparison operator. It works, however, if pandas type is on the left hand side.</span>
    <span class="c1"># That is because pandas is aware of numpy.</span>
    <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span> <span class="o">==</span> <span class="n">values</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">or</span> <span class="n">t</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">==</span> <span class="n">values</span><span class="o">.</span><span class="n">dtype</span><span class="p">:</span>
        <span class="c1"># The types are already compatible =&gt; conversion is not necessary.</span>
        <span class="k">return</span> <span class="n">values</span>

    <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="n">DataType</span><span class="o">.</span><span class="n">binary</span> <span class="ow">and</span> <span class="n">values</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">t</span><span class="o">.</span><span class="n">binary</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">kind</span><span class="p">:</span>
        <span class="c1"># NB: bytes in numpy have variable itemsize depending on the length of the longest</span>
        <span class="c1"># element in the array (column). Since MLflow binary type is length agnostic, we ignore</span>
        <span class="c1"># itemsize when matching binary columns.</span>
        <span class="k">return</span> <span class="n">values</span>

    <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="n">DataType</span><span class="o">.</span><span class="n">datetime</span> <span class="ow">and</span> <span class="n">values</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">t</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">kind</span><span class="p">:</span>
        <span class="c1"># NB: datetime values have variable precision denoted by brackets, e.g. datetime64[ns]</span>
        <span class="c1"># denotes nanosecond precision. Since MLflow datetime type is precision agnostic, we</span>
        <span class="c1"># ignore precision when matching datetime columns.</span>
        <span class="k">return</span> <span class="n">values</span>

    <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="n">DataType</span><span class="o">.</span><span class="n">datetime</span> <span class="ow">and</span> <span class="n">values</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">object</span><span class="p">:</span>
        <span class="c1"># NB: Pyspark date columns get converted to np.object when converted to a pandas</span>
        <span class="c1"># DataFrame. To respect the original typing, we convert the column to datetime.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;raise&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
                <span class="s2">&quot;Failed to convert column </span><span class="si">{0}</span><span class="s2"> from type </span><span class="si">{1}</span><span class="s2"> to </span><span class="si">{2}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">values</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="n">numpy_type</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">values</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">numpy_type</span><span class="o">.</span><span class="n">kind</span><span class="p">:</span>
        <span class="n">is_upcast</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">&lt;=</span> <span class="n">numpy_type</span><span class="o">.</span><span class="n">itemsize</span>
    <span class="k">elif</span> <span class="n">values</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;u&quot;</span> <span class="ow">and</span> <span class="n">numpy_type</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;i&quot;</span><span class="p">:</span>
        <span class="n">is_upcast</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">&lt;</span> <span class="n">numpy_type</span><span class="o">.</span><span class="n">itemsize</span>
    <span class="k">elif</span> <span class="n">values</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="s2">&quot;u&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">numpy_type</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span>
        <span class="c1"># allow (u)int =&gt; double conversion</span>
        <span class="n">is_upcast</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">&lt;=</span> <span class="mi">6</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">is_upcast</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">is_upcast</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy_type</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;raise&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># NB: conversion between incompatible types (e.g. floats -&gt; ints or</span>
        <span class="c1"># double -&gt; float) are not allowed. While supported by pandas and numpy,</span>
        <span class="c1"># these conversions alter the values significantly.</span>
        <span class="k">def</span> <span class="nf">all_ints</span><span class="p">(</span><span class="n">xs</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">all</span><span class="p">([</span><span class="n">pandas</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xs</span><span class="p">])</span>

        <span class="n">hint</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">values</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span>
            <span class="ow">and</span> <span class="n">numpy_type</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="s2">&quot;u&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">values</span><span class="o">.</span><span class="n">hasnans</span>
            <span class="ow">and</span> <span class="n">all_ints</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">hint</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot; Hint: the type mismatch is likely caused by missing values. &quot;</span>
                <span class="s2">&quot;Integer columns in python can not represent missing values and are therefore &quot;</span>
                <span class="s2">&quot;encoded as floats. The best way to avoid this problem is to infer the model &quot;</span>
                <span class="s2">&quot;schema based on a realistic data sample (training dataset) that includes missing &quot;</span>
                <span class="s2">&quot;values. Alternatively, you can declare integer columns as doubles (float64) &quot;</span>
                <span class="s2">&quot;whenever these columns may have missing values. See `Handling Integers With &quot;</span>
                <span class="s2">&quot;Missing Values &lt;https://www.mlflow.org/docs/latest/models.html#&quot;</span>
                <span class="s2">&quot;handling-integers-with-missing-values&gt;`_ for more details.&quot;</span>
            <span class="p">)</span>

        <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
            <span class="s2">&quot;Incompatible input types for column </span><span class="si">{0}</span><span class="s2">. &quot;</span>
            <span class="s2">&quot;Can not safely convert </span><span class="si">{1}</span><span class="s2"> to </span><span class="si">{2}</span><span class="s2">.</span><span class="si">{3}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">values</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">numpy_type</span><span class="p">,</span> <span class="n">hint</span><span class="p">)</span>
        <span class="p">)</span>


<span class="k">def</span> <span class="nf">_enforce_tensor_spec</span><span class="p">(</span><span class="n">values</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">tensor_spec</span><span class="p">:</span> <span class="n">TensorSpec</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Enforce the input tensor shape and type matches the provided tensor spec.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">expected_shape</span> <span class="o">=</span> <span class="n">tensor_spec</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">actual_shape</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">expected_shape</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">actual_shape</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
            <span class="s2">&quot;Shape of input </span><span class="si">{0}</span><span class="s2"> does not match expected shape </span><span class="si">{1}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">actual_shape</span><span class="p">,</span> <span class="n">expected_shape</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">for</span> <span class="n">expected</span><span class="p">,</span> <span class="n">actual</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected_shape</span><span class="p">,</span> <span class="n">actual_shape</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">expected</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">expected</span> <span class="o">!=</span> <span class="n">actual</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
                <span class="s2">&quot;Shape of input </span><span class="si">{0}</span><span class="s2"> does not match expected shape </span><span class="si">{1}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">actual_shape</span><span class="p">,</span> <span class="n">expected_shape</span>
                <span class="p">)</span>
            <span class="p">)</span>
    <span class="k">if</span> <span class="n">clean_tensor_type</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="o">!=</span> <span class="n">tensor_spec</span><span class="o">.</span><span class="n">type</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
            <span class="s2">&quot;dtype of input </span><span class="si">{0}</span><span class="s2"> does not match expected dtype </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">values</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">tensor_spec</span><span class="o">.</span><span class="n">type</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">values</span>


<span class="k">def</span> <span class="nf">_enforce_col_schema</span><span class="p">(</span><span class="n">pfInput</span><span class="p">:</span> <span class="n">PyFuncInput</span><span class="p">,</span> <span class="n">input_schema</span><span class="p">:</span> <span class="n">Schema</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Enforce the input columns conform to the model&#39;s column-based signature.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">input_schema</span><span class="o">.</span><span class="n">has_input_names</span><span class="p">():</span>
        <span class="n">input_names</span> <span class="o">=</span> <span class="n">input_schema</span><span class="o">.</span><span class="n">input_names</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">input_names</span> <span class="o">=</span> <span class="n">pfInput</span><span class="o">.</span><span class="n">columns</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_schema</span><span class="o">.</span><span class="n">inputs</span><span class="p">)]</span>
    <span class="n">input_types</span> <span class="o">=</span> <span class="n">input_schema</span><span class="o">.</span><span class="n">input_types</span><span class="p">()</span>
    <span class="n">new_pfInput</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">input_names</span><span class="p">):</span>
        <span class="n">new_pfInput</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">_enforce_mlflow_datatype</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">pfInput</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">input_types</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">new_pfInput</span>


<span class="k">def</span> <span class="nf">_enforce_tensor_schema</span><span class="p">(</span><span class="n">pfInput</span><span class="p">:</span> <span class="n">PyFuncInput</span><span class="p">,</span> <span class="n">input_schema</span><span class="p">:</span> <span class="n">Schema</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Enforce the input tensor(s) conforms to the model&#39;s tensor-based signature.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">input_schema</span><span class="o">.</span><span class="n">has_input_names</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pfInput</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">new_pfInput</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">col_name</span><span class="p">,</span> <span class="n">tensor_spec</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">input_schema</span><span class="o">.</span><span class="n">input_names</span><span class="p">(),</span> <span class="n">input_schema</span><span class="o">.</span><span class="n">inputs</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pfInput</span><span class="p">[</span><span class="n">col_name</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
                        <span class="s2">&quot;This model contains a tensor-based model signature with input names,&quot;</span>
                        <span class="s2">&quot; which suggests a dictionary input mapping input name to a numpy&quot;</span>
                        <span class="s2">&quot; array, but a dict with value type </span><span class="si">{0}</span><span class="s2"> was found.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="nb">type</span><span class="p">(</span><span class="n">pfInput</span><span class="p">[</span><span class="n">col_name</span><span class="p">])</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="n">new_pfInput</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">_enforce_tensor_spec</span><span class="p">(</span><span class="n">pfInput</span><span class="p">[</span><span class="n">col_name</span><span class="p">],</span> <span class="n">tensor_spec</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pfInput</span><span class="p">,</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">new_pfInput</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">col_name</span><span class="p">,</span> <span class="n">tensor_spec</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">input_schema</span><span class="o">.</span><span class="n">input_names</span><span class="p">(),</span> <span class="n">input_schema</span><span class="o">.</span><span class="n">inputs</span><span class="p">):</span>
                <span class="n">new_pfInput</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">_enforce_tensor_spec</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pfInput</span><span class="p">[</span><span class="n">col_name</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tensor_spec</span><span class="o">.</span><span class="n">type</span><span class="p">),</span> <span class="n">tensor_spec</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
                <span class="s2">&quot;This model contains a tensor-based model signature with input names, which&quot;</span>
                <span class="s2">&quot; suggests a dictionary input mapping input name to tensor, but an input of&quot;</span>
                <span class="s2">&quot; type </span><span class="si">{0}</span><span class="s2"> was found.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">pfInput</span><span class="p">))</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pfInput</span><span class="p">,</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">new_pfInput</span> <span class="o">=</span> <span class="n">_enforce_tensor_spec</span><span class="p">(</span><span class="n">pfInput</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">input_schema</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pfInput</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">new_pfInput</span> <span class="o">=</span> <span class="n">_enforce_tensor_spec</span><span class="p">(</span><span class="n">pfInput</span><span class="p">,</span> <span class="n">input_schema</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
                <span class="s2">&quot;This model contains a tensor-based model signature with no input names,&quot;</span>
                <span class="s2">&quot; which suggests a numpy array input, but an input of type </span><span class="si">{0}</span><span class="s2"> was&quot;</span>
                <span class="s2">&quot; found.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">pfInput</span><span class="p">))</span>
            <span class="p">)</span>
    <span class="k">return</span> <span class="n">new_pfInput</span>


<span class="k">def</span> <span class="nf">_enforce_schema</span><span class="p">(</span><span class="n">pfInput</span><span class="p">:</span> <span class="n">PyFuncInput</span><span class="p">,</span> <span class="n">input_schema</span><span class="p">:</span> <span class="n">Schema</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Enforces the provided input matches the model&#39;s input schema,</span>

<span class="sd">    For signatures with input names, we check there are no missing inputs and reorder the inputs to</span>
<span class="sd">    match the ordering declared in schema if necessary. Any extra columns are ignored.</span>

<span class="sd">    For column-based signatures, we make sure the types of the input match the type specified in</span>
<span class="sd">    the schema or if it can be safely converted to match the input schema.</span>

<span class="sd">    For tensor-based signatures, we make sure the shape and type of the input matches the shape</span>
<span class="sd">    and type specified in model&#39;s input schema.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">input_schema</span><span class="o">.</span><span class="n">is_tensor_spec</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pfInput</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pfInput</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pfInput</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
                    <span class="s2">&quot;This model contains a column-based signature, which suggests a DataFrame&quot;</span>
                    <span class="s2">&quot; input. There was an error casting the input data to a DataFrame:&quot;</span>
                    <span class="s2">&quot; </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pfInput</span><span class="p">,</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
                <span class="s2">&quot;Expected input to be DataFrame or list. Found: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">pfInput</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="n">input_schema</span><span class="o">.</span><span class="n">has_input_names</span><span class="p">():</span>
        <span class="c1"># make sure there are no missing columns</span>
        <span class="n">input_names</span> <span class="o">=</span> <span class="n">input_schema</span><span class="o">.</span><span class="n">input_names</span><span class="p">()</span>
        <span class="n">expected_cols</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">input_names</span><span class="p">)</span>
        <span class="n">actual_cols</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">expected_cols</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pfInput</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="c1"># for schemas with a single column, match input with column</span>
            <span class="n">pfInput</span> <span class="o">=</span> <span class="p">{</span><span class="n">input_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">pfInput</span><span class="p">}</span>
            <span class="n">actual_cols</span> <span class="o">=</span> <span class="n">expected_cols</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pfInput</span><span class="p">,</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">actual_cols</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">pfInput</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pfInput</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">actual_cols</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">pfInput</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">missing_cols</span> <span class="o">=</span> <span class="n">expected_cols</span> <span class="o">-</span> <span class="n">actual_cols</span>
        <span class="n">extra_cols</span> <span class="o">=</span> <span class="n">actual_cols</span> <span class="o">-</span> <span class="n">expected_cols</span>
        <span class="c1"># Preserve order from the original columns, since missing/extra columns are likely to</span>
        <span class="c1"># be in same order.</span>
        <span class="n">missing_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">input_names</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">missing_cols</span><span class="p">]</span>
        <span class="n">extra_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">actual_cols</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">extra_cols</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">missing_cols</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
                <span class="s2">&quot;Model is missing inputs </span><span class="si">{0}</span><span class="s2">.&quot;</span>
                <span class="s2">&quot; Note that there were extra inputs: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">missing_cols</span><span class="p">,</span> <span class="n">extra_cols</span><span class="p">)</span>
            <span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">input_schema</span><span class="o">.</span><span class="n">is_tensor_spec</span><span class="p">():</span>
        <span class="c1"># The model signature does not specify column names =&gt; we can only verify column count.</span>
        <span class="n">num_actual_columns</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pfInput</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_actual_columns</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_schema</span><span class="o">.</span><span class="n">inputs</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
                <span class="s2">&quot;Model inference is missing inputs. The model signature declares &quot;</span>
                <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> inputs  but the provided value only has &quot;</span>
                <span class="s2">&quot;</span><span class="si">{1}</span><span class="s2"> inputs. Note: the inputs were not named in the signature so we can &quot;</span>
                <span class="s2">&quot;only verify their count.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">input_schema</span><span class="o">.</span><span class="n">inputs</span><span class="p">),</span> <span class="n">num_actual_columns</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="n">_enforce_tensor_schema</span><span class="p">(</span><span class="n">pfInput</span><span class="p">,</span> <span class="n">input_schema</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">input_schema</span><span class="o">.</span><span class="n">is_tensor_spec</span><span class="p">()</span>
        <span class="k">else</span> <span class="n">_enforce_col_schema</span><span class="p">(</span><span class="n">pfInput</span><span class="p">,</span> <span class="n">input_schema</span><span class="p">)</span>
    <span class="p">)</span>


<div class="viewcode-block" id="PyFuncModel"><a class="viewcode-back" href="../../python_api/mlflow.pyfunc.html#mlflow.pyfunc.PyFuncModel">[docs]</a><span class="k">class</span> <span class="nc">PyFuncModel</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    MLflow &#39;python function&#39; model.</span>

<span class="sd">    Wrapper around model implementation and metadata. This class is not meant to be constructed</span>
<span class="sd">    directly. Instead, instances of this class are constructed and returned from</span>
<span class="sd">    :py:func:`load_model() &lt;mlflow.pyfunc.load_model&gt;`.</span>

<span class="sd">    ``model_impl`` can be any Python object that implements the `Pyfunc interface</span>
<span class="sd">    &lt;https://mlflow.org/docs/latest/python_api/mlflow.pyfunc.html#pyfunc-inference-api&gt;`_, and is</span>
<span class="sd">    returned by invoking the model&#39;s ``loader_module``.</span>

<span class="sd">    ``model_meta`` contains model metadata loaded from the MLmodel file.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_meta</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span> <span class="n">model_impl</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model_impl</span><span class="p">,</span> <span class="s2">&quot;predict&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span><span class="s2">&quot;Model implementation is missing required predict method.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">model_meta</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span><span class="s2">&quot;Model is missing metadata.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model_meta</span> <span class="o">=</span> <span class="n">model_meta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model_impl</span> <span class="o">=</span> <span class="n">model_impl</span>

<div class="viewcode-block" id="PyFuncModel.predict"><a class="viewcode-back" href="../../python_api/mlflow.pyfunc.html#mlflow.pyfunc.PyFuncModel.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">PyFuncInput</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PyFuncOutput</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate model predictions.</span>

<span class="sd">        If the model contains signature, enforce the input schema first before calling the model</span>
<span class="sd">        implementation with the sanitized input. If the pyfunc model does not include model schema,</span>
<span class="sd">        the input is passed to the model implementation as is. See `Model Signature Enforcement</span>
<span class="sd">        &lt;https://www.mlflow.org/docs/latest/models.html#signature-enforcement&gt;`_ for more details.&quot;</span>

<span class="sd">        :param data: Model input as one of pandas.DataFrame, numpy.ndarray, or</span>
<span class="sd">                     Dict[str, numpy.ndarray]</span>
<span class="sd">        :return: Model predictions as one of pandas.DataFrame, pandas.Series, numpy.ndarray or list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">input_schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get_input_schema</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">input_schema</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">_enforce_schema</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">input_schema</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_impl</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Model metadata.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_meta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span><span class="s2">&quot;Model is missing metadata.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_meta</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_meta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_meta</span><span class="p">,</span> <span class="s2">&quot;run_id&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_meta</span><span class="o">.</span><span class="n">run_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">info</span><span class="p">[</span><span class="s2">&quot;run_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_meta</span><span class="o">.</span><span class="n">run_id</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_meta</span><span class="p">,</span> <span class="s2">&quot;artifact_path&quot;</span><span class="p">)</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_meta</span><span class="o">.</span><span class="n">artifact_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="p">):</span>
                <span class="n">info</span><span class="p">[</span><span class="s2">&quot;artifact_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_meta</span><span class="o">.</span><span class="n">artifact_path</span>
            <span class="n">info</span><span class="p">[</span><span class="s2">&quot;flavor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_meta</span><span class="o">.</span><span class="n">flavors</span><span class="p">[</span><span class="n">FLAVOR_NAME</span><span class="p">][</span><span class="s2">&quot;loader_module&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_dump</span><span class="p">({</span><span class="s2">&quot;mlflow.pyfunc.loaded_model&quot;</span><span class="p">:</span> <span class="n">info</span><span class="p">},</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="load_model"><a class="viewcode-back" href="../../python_api/mlflow.pyfunc.html#mlflow.pyfunc.load_model">[docs]</a><span class="k">def</span> <span class="nf">load_model</span><span class="p">(</span><span class="n">model_uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">suppress_warnings</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PyFuncModel</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load a model stored in Python function format.</span>

<span class="sd">    :param model_uri: The location, in URI format, of the MLflow model. For example:</span>

<span class="sd">                      - ``/Users/me/path/to/local/model``</span>
<span class="sd">                      - ``relative/path/to/local/model``</span>
<span class="sd">                      - ``s3://my_bucket/path/to/model``</span>
<span class="sd">                      - ``runs:/&lt;mlflow_run_id&gt;/run-relative/path/to/model``</span>
<span class="sd">                      - ``models:/&lt;model_name&gt;/&lt;model_version&gt;``</span>
<span class="sd">                      - ``models:/&lt;model_name&gt;/&lt;stage&gt;``</span>

<span class="sd">                      For more information about supported URI schemes, see</span>
<span class="sd">                      `Referencing Artifacts &lt;https://www.mlflow.org/docs/latest/concepts.html#</span>
<span class="sd">                      artifact-locations&gt;`_.</span>
<span class="sd">    :param suppress_warnings: If ``True``, non-fatal warning messages associated with the model</span>
<span class="sd">                              loading process will be suppressed. If ``False``, these warning</span>
<span class="sd">                              messages will be emitted.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">local_path</span> <span class="o">=</span> <span class="n">_download_artifact_from_uri</span><span class="p">(</span><span class="n">artifact_uri</span><span class="o">=</span><span class="n">model_uri</span><span class="p">)</span>
    <span class="n">model_meta</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="n">MLMODEL_FILE_NAME</span><span class="p">))</span>

    <span class="n">conf</span> <span class="o">=</span> <span class="n">model_meta</span><span class="o">.</span><span class="n">flavors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">FLAVOR_NAME</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">conf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
            <span class="s1">&#39;Model does not have the &quot;</span><span class="si">{flavor_name}</span><span class="s1">&quot; flavor&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flavor_name</span><span class="o">=</span><span class="n">FLAVOR_NAME</span><span class="p">),</span>
            <span class="n">RESOURCE_DOES_NOT_EXIST</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="n">model_py_version</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">PY_VERSION</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">suppress_warnings</span><span class="p">:</span>
        <span class="n">_warn_potentially_incompatible_py_version_if_necessary</span><span class="p">(</span><span class="n">model_py_version</span><span class="o">=</span><span class="n">model_py_version</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">CODE</span> <span class="ow">in</span> <span class="n">conf</span> <span class="ow">and</span> <span class="n">conf</span><span class="p">[</span><span class="n">CODE</span><span class="p">]:</span>
        <span class="n">code_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="n">conf</span><span class="p">[</span><span class="n">CODE</span><span class="p">])</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">pyfunc</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">_add_code_to_system_path</span><span class="p">(</span><span class="n">code_path</span><span class="o">=</span><span class="n">code_path</span><span class="p">)</span>
    <span class="n">data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="n">conf</span><span class="p">[</span><span class="n">DATA</span><span class="p">])</span> <span class="k">if</span> <span class="p">(</span><span class="n">DATA</span> <span class="ow">in</span> <span class="n">conf</span><span class="p">)</span> <span class="k">else</span> <span class="n">local_path</span>
    <span class="n">model_impl</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">conf</span><span class="p">[</span><span class="n">MAIN</span><span class="p">])</span><span class="o">.</span><span class="n">_load_pyfunc</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">PyFuncModel</span><span class="p">(</span><span class="n">model_meta</span><span class="o">=</span><span class="n">model_meta</span><span class="p">,</span> <span class="n">model_impl</span><span class="o">=</span><span class="n">model_impl</span><span class="p">)</span></div>


<div class="viewcode-block" id="load_pyfunc"><a class="viewcode-back" href="../../python_api/mlflow.pyfunc.html#mlflow.pyfunc.load_pyfunc">[docs]</a><span class="nd">@deprecated</span><span class="p">(</span><span class="s2">&quot;mlflow.pyfunc.load_model&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">load_pyfunc</span><span class="p">(</span><span class="n">model_uri</span><span class="p">,</span> <span class="n">suppress_warnings</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load a model stored in Python function format.</span>

<span class="sd">    :param model_uri: The location, in URI format, of the MLflow model. For example:</span>

<span class="sd">                      - ``/Users/me/path/to/local/model``</span>
<span class="sd">                      - ``relative/path/to/local/model``</span>
<span class="sd">                      - ``s3://my_bucket/path/to/model``</span>
<span class="sd">                      - ``runs:/&lt;mlflow_run_id&gt;/run-relative/path/to/model``</span>
<span class="sd">                      - ``models:/&lt;model_name&gt;/&lt;model_version&gt;``</span>
<span class="sd">                      - ``models:/&lt;model_name&gt;/&lt;stage&gt;``</span>

<span class="sd">                      For more information about supported URI schemes, see</span>
<span class="sd">                      `Referencing Artifacts &lt;https://www.mlflow.org/docs/latest/concepts.html#</span>
<span class="sd">                      artifact-locations&gt;`_.</span>

<span class="sd">    :param suppress_warnings: If ``True``, non-fatal warning messages associated with the model</span>
<span class="sd">                              loading process will be suppressed. If ``False``, these warning</span>
<span class="sd">                              messages will be emitted.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">load_model</span><span class="p">(</span><span class="n">model_uri</span><span class="p">,</span> <span class="n">suppress_warnings</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_warn_potentially_incompatible_py_version_if_necessary</span><span class="p">(</span><span class="n">model_py_version</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compares the version of Python that was used to save a given model with the version</span>
<span class="sd">    of Python that is currently running. If a major or minor version difference is detected,</span>
<span class="sd">    logs an appropriate warning.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">model_py_version</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;The specified model does not have a specified Python version. It may be&quot;</span>
            <span class="s2">&quot; incompatible with the version of Python that is currently running: Python </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">PYTHON_VERSION</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">get_major_minor_py_version</span><span class="p">(</span><span class="n">model_py_version</span><span class="p">)</span> <span class="o">!=</span> <span class="n">get_major_minor_py_version</span><span class="p">(</span><span class="n">PYTHON_VERSION</span><span class="p">):</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;The version of Python that the model was saved in, `Python </span><span class="si">%s</span><span class="s2">`, differs&quot;</span>
            <span class="s2">&quot; from the version of Python that is currently running, `Python </span><span class="si">%s</span><span class="s2">`,&quot;</span>
            <span class="s2">&quot; and may be incompatible&quot;</span><span class="p">,</span>
            <span class="n">model_py_version</span><span class="p">,</span>
            <span class="n">PYTHON_VERSION</span><span class="p">,</span>
        <span class="p">)</span>


<div class="viewcode-block" id="spark_udf"><a class="viewcode-back" href="../../python_api/mlflow.pyfunc.html#mlflow.pyfunc.spark_udf">[docs]</a><span class="k">def</span> <span class="nf">spark_udf</span><span class="p">(</span><span class="n">spark</span><span class="p">,</span> <span class="n">model_uri</span><span class="p">,</span> <span class="n">result_type</span><span class="o">=</span><span class="s2">&quot;double&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Spark UDF that can be used to invoke the Python function formatted model.</span>

<span class="sd">    Parameters passed to the UDF are forwarded to the model as a DataFrame where the column names</span>
<span class="sd">    are ordinals (0, 1, ...). On some versions of Spark (3.0 and above), it is also possible to</span>
<span class="sd">    wrap the input in a struct. In that case, the data will be passed as a DataFrame with column</span>
<span class="sd">    names given by the struct definition (e.g. when invoked as my_udf(struct(&#39;x&#39;, &#39;y&#39;)), the model</span>
<span class="sd">    will get the data as a pandas DataFrame with 2 columns &#39;x&#39; and &#39;y&#39;).</span>

<span class="sd">    If a model contains a signature, the UDF can be called without specifying column name</span>
<span class="sd">    arguments. In this case, the UDF will be called with column names from signature, so the</span>
<span class="sd">    evaluation dataframe&#39;s column names must match the model signature&#39;s column names.</span>

<span class="sd">    The predictions are filtered to contain only the columns that can be represented as the</span>
<span class="sd">    ``result_type``. If the ``result_type`` is string or array of strings, all predictions are</span>
<span class="sd">    converted to string. If the result type is not an array type, the left most column with</span>
<span class="sd">    matching type is returned.</span>

<span class="sd">    NOTE: Inputs of type ``pyspark.sql.types.DateType`` are not supported on earlier versions of</span>
<span class="sd">    Spark (2.4 and below).</span>

<span class="sd">    .. code-block:: python</span>
<span class="sd">        :caption: Example</span>

<span class="sd">        from pyspark.sql.functions import struct</span>

<span class="sd">        predict = mlflow.pyfunc.spark_udf(spark, &quot;/my/local/model&quot;)</span>
<span class="sd">        df.withColumn(&quot;prediction&quot;, predict(struct(&quot;name&quot;, &quot;age&quot;))).show()</span>

<span class="sd">    :param spark: A SparkSession object.</span>
<span class="sd">    :param model_uri: The location, in URI format, of the MLflow model with the</span>
<span class="sd">                      :py:mod:`mlflow.pyfunc` flavor. For example:</span>

<span class="sd">                      - ``/Users/me/path/to/local/model``</span>
<span class="sd">                      - ``relative/path/to/local/model``</span>
<span class="sd">                      - ``s3://my_bucket/path/to/model``</span>
<span class="sd">                      - ``runs:/&lt;mlflow_run_id&gt;/run-relative/path/to/model``</span>
<span class="sd">                      - ``models:/&lt;model_name&gt;/&lt;model_version&gt;``</span>
<span class="sd">                      - ``models:/&lt;model_name&gt;/&lt;stage&gt;``</span>

<span class="sd">                      For more information about supported URI schemes, see</span>
<span class="sd">                      `Referencing Artifacts &lt;https://www.mlflow.org/docs/latest/concepts.html#</span>
<span class="sd">                      artifact-locations&gt;`_.</span>

<span class="sd">    :param result_type: the return type of the user-defined function. The value can be either a</span>
<span class="sd">        ``pyspark.sql.types.DataType`` object or a DDL-formatted type string. Only a primitive</span>
<span class="sd">        type or an array ``pyspark.sql.types.ArrayType`` of primitive type are allowed.</span>
<span class="sd">        The following classes of result type are supported:</span>

<span class="sd">        - &quot;int&quot; or ``pyspark.sql.types.IntegerType``: The leftmost integer that can fit in an</span>
<span class="sd">          ``int32`` or an exception if there is none.</span>

<span class="sd">        - &quot;long&quot; or ``pyspark.sql.types.LongType``: The leftmost long integer that can fit in an</span>
<span class="sd">          ``int64`` or an exception if there is none.</span>

<span class="sd">        - ``ArrayType(IntegerType|LongType)``: All integer columns that can fit into the requested</span>
<span class="sd">          size.</span>

<span class="sd">        - &quot;float&quot; or ``pyspark.sql.types.FloatType``: The leftmost numeric result cast to</span>
<span class="sd">          ``float32`` or an exception if there is none.</span>

<span class="sd">        - &quot;double&quot; or ``pyspark.sql.types.DoubleType``: The leftmost numeric result cast to</span>
<span class="sd">          ``double`` or an exception if there is none.</span>

<span class="sd">        - ``ArrayType(FloatType|DoubleType)``: All numeric columns cast to the requested type or</span>
<span class="sd">          an exception if there are no numeric columns.</span>

<span class="sd">        - &quot;string&quot; or ``pyspark.sql.types.StringType``: The leftmost column converted to ``string``.</span>

<span class="sd">        - ``ArrayType(StringType)``: All columns converted to ``string``.</span>

<span class="sd">    :return: Spark UDF that applies the model&#39;s ``predict`` method to the data and returns a</span>
<span class="sd">             type specified by ``result_type``, which by default is a double.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Scope Spark import to this method so users don&#39;t need pyspark to use non-Spark-related</span>
    <span class="c1"># functionality.</span>
    <span class="kn">import</span> <span class="nn">functools</span>
    <span class="kn">from</span> <span class="nn">mlflow.pyfunc.spark_model_cache</span> <span class="kn">import</span> <span class="n">SparkModelCache</span>
    <span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">pandas_udf</span>
    <span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">_parse_datatype_string</span>
    <span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">ArrayType</span><span class="p">,</span> <span class="n">DataType</span> <span class="k">as</span> <span class="n">SparkDataType</span>
    <span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">DoubleType</span><span class="p">,</span> <span class="n">IntegerType</span><span class="p">,</span> <span class="n">FloatType</span><span class="p">,</span> <span class="n">LongType</span><span class="p">,</span> <span class="n">StringType</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result_type</span><span class="p">,</span> <span class="n">SparkDataType</span><span class="p">):</span>
        <span class="n">result_type</span> <span class="o">=</span> <span class="n">_parse_datatype_string</span><span class="p">(</span><span class="n">result_type</span><span class="p">)</span>

    <span class="n">elem_type</span> <span class="o">=</span> <span class="n">result_type</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem_type</span><span class="p">,</span> <span class="n">ArrayType</span><span class="p">):</span>
        <span class="n">elem_type</span> <span class="o">=</span> <span class="n">elem_type</span><span class="o">.</span><span class="n">elementType</span>

    <span class="n">supported_types</span> <span class="o">=</span> <span class="p">[</span><span class="n">IntegerType</span><span class="p">,</span> <span class="n">LongType</span><span class="p">,</span> <span class="n">FloatType</span><span class="p">,</span> <span class="n">DoubleType</span><span class="p">,</span> <span class="n">StringType</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">elem_type</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">supported_types</span><span class="p">]):</span>
        <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Invalid result_type &#39;</span><span class="si">{}</span><span class="s2">&#39;. Result type can only be one of or an array of one &quot;</span>
            <span class="s2">&quot;of the following types: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">elem_type</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">supported_types</span><span class="p">)),</span>
            <span class="n">error_code</span><span class="o">=</span><span class="n">INVALID_PARAMETER_VALUE</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">with</span> <span class="n">TempDir</span><span class="p">()</span> <span class="k">as</span> <span class="n">local_tmpdir</span><span class="p">:</span>
        <span class="n">local_model_path</span> <span class="o">=</span> <span class="n">_download_artifact_from_uri</span><span class="p">(</span>
            <span class="n">artifact_uri</span><span class="o">=</span><span class="n">model_uri</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="n">local_tmpdir</span><span class="o">.</span><span class="n">path</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">archive_path</span> <span class="o">=</span> <span class="n">SparkModelCache</span><span class="o">.</span><span class="n">add_local_model</span><span class="p">(</span><span class="n">spark</span><span class="p">,</span> <span class="n">local_model_path</span><span class="p">)</span>
        <span class="n">model_metadata</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_model_path</span><span class="p">,</span> <span class="n">MLMODEL_FILE_NAME</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">SparkModelCache</span><span class="o">.</span><span class="n">get_or_load</span><span class="p">(</span><span class="n">archive_path</span><span class="p">)</span>
        <span class="n">input_schema</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get_input_schema</span><span class="p">()</span>
        <span class="n">pdf</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                        <span class="s2">&quot;If passing a StructType column, there should be only one &quot;</span>
                        <span class="s2">&quot;input column, but got </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="n">pdf</span> <span class="o">=</span> <span class="n">x</span>
        <span class="k">if</span> <span class="n">pdf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">input_schema</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">))]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">names</span> <span class="o">=</span> <span class="n">input_schema</span><span class="o">.</span><span class="n">input_names</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">):</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
                        <span class="s2">&quot;Model input is missing columns. Expected </span><span class="si">{0}</span><span class="s2"> input columns </span><span class="si">{1}</span><span class="s2">,&quot;</span>
                        <span class="s2">&quot; but the model received only </span><span class="si">{2}</span><span class="s2"> unnamed input columns&quot;</span>
                        <span class="s2">&quot; (Since the columns were passed unnamed they are expected to be in&quot;</span>
                        <span class="s2">&quot; the order specified by the schema).&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">),</span> <span class="n">names</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
                    <span class="p">)</span>
            <span class="n">pdf</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="n">x</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">args</span><span class="p">)},</span> <span class="n">columns</span><span class="o">=</span><span class="n">names</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">pdf</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>

        <span class="n">elem_type</span> <span class="o">=</span> <span class="n">result_type</span><span class="o">.</span><span class="n">elementType</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result_type</span><span class="p">,</span> <span class="n">ArrayType</span><span class="p">)</span> <span class="k">else</span> <span class="n">result_type</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">elem_type</span><span class="p">)</span> <span class="o">==</span> <span class="n">IntegerType</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span>
                <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">byte</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ubyte</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">short</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ushort</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">elem_type</span><span class="p">)</span> <span class="o">==</span> <span class="n">LongType</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">byte</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ubyte</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">short</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ushort</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">long</span><span class="p">])</span>

        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">elem_type</span><span class="p">)</span> <span class="o">==</span> <span class="n">FloatType</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">,))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">elem_type</span><span class="p">)</span> <span class="o">==</span> <span class="n">DoubleType</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">,))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;The the model did not produce any values compatible with the requested &quot;</span>
                <span class="s2">&quot;type &#39;</span><span class="si">{}</span><span class="s2">&#39;. Consider requesting udf with StringType or &quot;</span>
                <span class="s2">&quot;Arraytype(StringType).&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">elem_type</span><span class="p">)),</span>
                <span class="n">error_code</span><span class="o">=</span><span class="n">INVALID_PARAMETER_VALUE</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">elem_type</span><span class="p">)</span> <span class="o">==</span> <span class="n">StringType</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">applymap</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">result_type</span><span class="p">)</span> <span class="o">==</span> <span class="n">ArrayType</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

    <span class="n">udf</span> <span class="o">=</span> <span class="n">pandas_udf</span><span class="p">(</span><span class="n">predict</span><span class="p">,</span> <span class="n">result_type</span><span class="p">)</span>
    <span class="n">udf</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">model_metadata</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">udf</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">udf_with_default_cols</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">input_schema</span> <span class="o">=</span> <span class="n">model_metadata</span><span class="o">.</span><span class="n">get_input_schema</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">input_schema</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_schema</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">input_schema</span><span class="o">.</span><span class="n">has_input_names</span><span class="p">():</span>
                    <span class="n">input_names</span> <span class="o">=</span> <span class="n">input_schema</span><span class="o">.</span><span class="n">input_names</span><span class="p">()</span>
                    <span class="k">return</span> <span class="n">udf</span><span class="p">(</span><span class="o">*</span><span class="n">input_names</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
                        <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Cannot apply udf because no column names specified. The udf &quot;</span>
                        <span class="s2">&quot;expects </span><span class="si">{}</span><span class="s2"> columns with types: </span><span class="si">{}</span><span class="s2">. Input column names could not be &quot;</span>
                        <span class="s2">&quot;inferred from the model signature (column names not found).&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="nb">len</span><span class="p">(</span><span class="n">input_schema</span><span class="o">.</span><span class="n">inputs</span><span class="p">),</span> <span class="n">input_schema</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="n">error_code</span><span class="o">=</span><span class="n">INVALID_PARAMETER_VALUE</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Attempting to apply udf on zero columns because no column names were &quot;</span>
                    <span class="s2">&quot;specified as arguments or inferred from the model signature.&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">udf</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">udf</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">udf_with_default_cols</span></div>


<div class="viewcode-block" id="save_model"><a class="viewcode-back" href="../../python_api/mlflow.pyfunc.html#mlflow.pyfunc.save_model">[docs]</a><span class="nd">@format_docstring</span><span class="p">(</span><span class="n">LOG_MODEL_PARAM_DOCS</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">package_name</span><span class="o">=</span><span class="s2">&quot;scikit-learn&quot;</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">save_model</span><span class="p">(</span>
    <span class="n">path</span><span class="p">,</span>
    <span class="n">loader_module</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">data_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">code_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">conda_env</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">mlflow_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">python_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">artifacts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">signature</span><span class="p">:</span> <span class="n">ModelSignature</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">input_example</span><span class="p">:</span> <span class="n">ModelInputExample</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">pip_requirements</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">extra_pip_requirements</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    save_model(path, loader_module=None, data_path=None, code_path=None, conda_env=None,\</span>
<span class="sd">               mlflow_model=Model(), python_model=None, artifacts=None)</span>

<span class="sd">    Save a Pyfunc model with custom inference logic and optional data dependencies to a path on the</span>
<span class="sd">    local filesystem.</span>

<span class="sd">    For information about the workflows that this method supports, please see :ref:`&quot;workflows for</span>
<span class="sd">    creating custom pyfunc models&quot; &lt;pyfunc-create-custom-workflows&gt;` and</span>
<span class="sd">    :ref:`&quot;which workflow is right for my use case?&quot; &lt;pyfunc-create-custom-selecting-workflow&gt;`.</span>
<span class="sd">    Note that the parameters for the second workflow: ``loader_module``, ``data_path`` and the</span>
<span class="sd">    parameters for the first workflow: ``python_model``, ``artifacts``, cannot be</span>
<span class="sd">    specified together.</span>

<span class="sd">    :param path: The path to which to save the Python model.</span>
<span class="sd">    :param loader_module: The name of the Python module that is used to load the model</span>
<span class="sd">                          from ``data_path``. This module must define a method with the prototype</span>
<span class="sd">                          ``_load_pyfunc(data_path)``. If not ``None``, this module and its</span>
<span class="sd">                          dependencies must be included in one of the following locations:</span>

<span class="sd">                          - The MLflow library.</span>
<span class="sd">                          - Package(s) listed in the model&#39;s Conda environment, specified by</span>
<span class="sd">                            the ``conda_env`` parameter.</span>
<span class="sd">                          - One or more of the files specified by the ``code_path`` parameter.</span>

<span class="sd">    :param data_path: Path to a file or directory containing model data.</span>
<span class="sd">    :param code_path: A list of local filesystem paths to Python file dependencies (or directories</span>
<span class="sd">                      containing file dependencies). These files are *prepended* to the system</span>
<span class="sd">                      path before the model is loaded.</span>
<span class="sd">    :param conda_env: {{ conda_env }}</span>
<span class="sd">    :param mlflow_model: :py:mod:`mlflow.models.Model` configuration to which to add the</span>
<span class="sd">                         **python_function** flavor.</span>
<span class="sd">    :param python_model: An instance of a subclass of :class:`~PythonModel`. This class is</span>
<span class="sd">                         serialized using the CloudPickle library. Any dependencies of the class</span>
<span class="sd">                         should be included in one of the following locations:</span>

<span class="sd">                            - The MLflow library.</span>
<span class="sd">                            - Package(s) listed in the model&#39;s Conda environment, specified by</span>
<span class="sd">                              the ``conda_env`` parameter.</span>
<span class="sd">                            - One or more of the files specified by the ``code_path`` parameter.</span>

<span class="sd">                         Note: If the class is imported from another module, as opposed to being</span>
<span class="sd">                         defined in the ``__main__`` scope, the defining module should also be</span>
<span class="sd">                         included in one of the listed locations.</span>
<span class="sd">    :param artifacts: A dictionary containing ``&lt;name, artifact_uri&gt;`` entries. Remote artifact URIs</span>
<span class="sd">                      are resolved to absolute filesystem paths, producing a dictionary of</span>
<span class="sd">                      ``&lt;name, absolute_path&gt;`` entries. ``python_model`` can reference these</span>
<span class="sd">                      resolved entries as the ``artifacts`` property of the ``context`` parameter</span>
<span class="sd">                      in :func:`PythonModel.load_context() &lt;mlflow.pyfunc.PythonModel.load_context&gt;`</span>
<span class="sd">                      and :func:`PythonModel.predict() &lt;mlflow.pyfunc.PythonModel.predict&gt;`.</span>
<span class="sd">                      For example, consider the following ``artifacts`` dictionary::</span>

<span class="sd">                        {</span>
<span class="sd">                            &quot;my_file&quot;: &quot;s3://my-bucket/path/to/my/file&quot;</span>
<span class="sd">                        }</span>

<span class="sd">                      In this case, the ``&quot;my_file&quot;`` artifact is downloaded from S3. The</span>
<span class="sd">                      ``python_model`` can then refer to ``&quot;my_file&quot;`` as an absolute filesystem</span>
<span class="sd">                      path via ``context.artifacts[&quot;my_file&quot;]``.</span>

<span class="sd">                      If ``None``, no artifacts are added to the model.</span>

<span class="sd">    :param signature: :py:class:`ModelSignature &lt;mlflow.models.ModelSignature&gt;`</span>
<span class="sd">                      describes model input and output :py:class:`Schema &lt;mlflow.types.Schema&gt;`.</span>
<span class="sd">                      The model signature can be :py:func:`inferred &lt;mlflow.models.infer_signature&gt;`</span>
<span class="sd">                      from datasets with valid model input (e.g. the training dataset with target</span>
<span class="sd">                      column omitted) and valid model output (e.g. model predictions generated on</span>
<span class="sd">                      the training dataset), for example:</span>

<span class="sd">                      .. code-block:: python</span>

<span class="sd">                        from mlflow.models.signature import infer_signature</span>
<span class="sd">                        train = df.drop_column(&quot;target_label&quot;)</span>
<span class="sd">                        predictions = ... # compute model predictions</span>
<span class="sd">                        signature = infer_signature(train, predictions)</span>
<span class="sd">    :param input_example: Input example provides one or several instances of valid</span>
<span class="sd">                          model input. The example can be used as a hint of what data to feed the</span>
<span class="sd">                          model. The given example can be a Pandas DataFrame where the given</span>
<span class="sd">                          example will be serialized to json using the Pandas split-oriented</span>
<span class="sd">                          format, or a numpy array where the example will be serialized to json</span>
<span class="sd">                          by converting it to a list. Bytes are base64-encoded.</span>
<span class="sd">    :param pip_requirements: {{ pip_requirements }}</span>
<span class="sd">    :param extra_pip_requirements: {{ extra_pip_requirements }}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_validate_env_arguments</span><span class="p">(</span><span class="n">conda_env</span><span class="p">,</span> <span class="n">pip_requirements</span><span class="p">,</span> <span class="n">extra_pip_requirements</span><span class="p">)</span>

    <span class="n">mlflow_model</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">mlflow_model</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;save_model() got unexpected keyword arguments: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">code_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">code_path</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Argument code_path should be a list, not </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">code_path</span><span class="p">)))</span>

    <span class="n">first_argument_set</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;loader_module&quot;</span><span class="p">:</span> <span class="n">loader_module</span><span class="p">,</span>
        <span class="s2">&quot;data_path&quot;</span><span class="p">:</span> <span class="n">data_path</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">second_argument_set</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;artifacts&quot;</span><span class="p">:</span> <span class="n">artifacts</span><span class="p">,</span>
        <span class="s2">&quot;python_model&quot;</span><span class="p">:</span> <span class="n">python_model</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">first_argument_set_specified</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([</span><span class="n">item</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">first_argument_set</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
    <span class="n">second_argument_set_specified</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([</span><span class="n">item</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">second_argument_set</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
    <span class="k">if</span> <span class="n">first_argument_set_specified</span> <span class="ow">and</span> <span class="n">second_argument_set_specified</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="p">(</span>
                <span class="s2">&quot;The following sets of parameters cannot be specified together: </span><span class="si">{first_set_keys}</span><span class="s2">&quot;</span>
                <span class="s2">&quot; and </span><span class="si">{second_set_keys}</span><span class="s2">. All parameters in one set must be `None`. Instead, found&quot;</span>
                <span class="s2">&quot; the following values: </span><span class="si">{first_set_entries}</span><span class="s2"> and </span><span class="si">{second_set_entries}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">first_set_keys</span><span class="o">=</span><span class="n">first_argument_set</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
                    <span class="n">second_set_keys</span><span class="o">=</span><span class="n">second_argument_set</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
                    <span class="n">first_set_entries</span><span class="o">=</span><span class="n">first_argument_set</span><span class="p">,</span>
                    <span class="n">second_set_entries</span><span class="o">=</span><span class="n">second_argument_set</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">),</span>
            <span class="n">error_code</span><span class="o">=</span><span class="n">INVALID_PARAMETER_VALUE</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">loader_module</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">python_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Either `loader_module` or `python_model` must be specified. A `loader_module` &quot;</span>
            <span class="s2">&quot;should be a python module. A `python_model` should be a subclass of PythonModel&quot;</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span> <span class="n">error_code</span><span class="o">=</span><span class="n">INVALID_PARAMETER_VALUE</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Path &#39;</span><span class="si">{}</span><span class="s2">&#39; already exists&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">error_code</span><span class="o">=</span><span class="n">RESOURCE_ALREADY_EXISTS</span>
        <span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mlflow_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mlflow_model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">signature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mlflow_model</span><span class="o">.</span><span class="n">signature</span> <span class="o">=</span> <span class="n">signature</span>
    <span class="k">if</span> <span class="n">input_example</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_save_example</span><span class="p">(</span><span class="n">mlflow_model</span><span class="p">,</span> <span class="n">input_example</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">first_argument_set_specified</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_save_model_with_loader_module_and_data_path</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
            <span class="n">loader_module</span><span class="o">=</span><span class="n">loader_module</span><span class="p">,</span>
            <span class="n">data_path</span><span class="o">=</span><span class="n">data_path</span><span class="p">,</span>
            <span class="n">code_paths</span><span class="o">=</span><span class="n">code_path</span><span class="p">,</span>
            <span class="n">conda_env</span><span class="o">=</span><span class="n">conda_env</span><span class="p">,</span>
            <span class="n">mlflow_model</span><span class="o">=</span><span class="n">mlflow_model</span><span class="p">,</span>
            <span class="n">pip_requirements</span><span class="o">=</span><span class="n">pip_requirements</span><span class="p">,</span>
            <span class="n">extra_pip_requirements</span><span class="o">=</span><span class="n">extra_pip_requirements</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">second_argument_set_specified</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">pyfunc</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_save_model_with_class_artifacts_params</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
            <span class="n">python_model</span><span class="o">=</span><span class="n">python_model</span><span class="p">,</span>
            <span class="n">artifacts</span><span class="o">=</span><span class="n">artifacts</span><span class="p">,</span>
            <span class="n">conda_env</span><span class="o">=</span><span class="n">conda_env</span><span class="p">,</span>
            <span class="n">code_paths</span><span class="o">=</span><span class="n">code_path</span><span class="p">,</span>
            <span class="n">mlflow_model</span><span class="o">=</span><span class="n">mlflow_model</span><span class="p">,</span>
            <span class="n">pip_requirements</span><span class="o">=</span><span class="n">pip_requirements</span><span class="p">,</span>
            <span class="n">extra_pip_requirements</span><span class="o">=</span><span class="n">extra_pip_requirements</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="log_model"><a class="viewcode-back" href="../../python_api/mlflow.pyfunc.html#mlflow.pyfunc.log_model">[docs]</a><span class="nd">@format_docstring</span><span class="p">(</span><span class="n">LOG_MODEL_PARAM_DOCS</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">package_name</span><span class="o">=</span><span class="s2">&quot;scikit-learn&quot;</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">log_model</span><span class="p">(</span>
    <span class="n">artifact_path</span><span class="p">,</span>
    <span class="n">loader_module</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">data_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">code_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">conda_env</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">python_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">artifacts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">registered_model_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">signature</span><span class="p">:</span> <span class="n">ModelSignature</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">input_example</span><span class="p">:</span> <span class="n">ModelInputExample</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">await_registration_for</span><span class="o">=</span><span class="n">DEFAULT_AWAIT_MAX_SLEEP_SECONDS</span><span class="p">,</span>
    <span class="n">pip_requirements</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">extra_pip_requirements</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Log a Pyfunc model with custom inference logic and optional data dependencies as an MLflow</span>
<span class="sd">    artifact for the current run.</span>

<span class="sd">    For information about the workflows that this method supports, see :ref:`Workflows for</span>
<span class="sd">    creating custom pyfunc models &lt;pyfunc-create-custom-workflows&gt;` and</span>
<span class="sd">    :ref:`Which workflow is right for my use case? &lt;pyfunc-create-custom-selecting-workflow&gt;`.</span>
<span class="sd">    You cannot specify the parameters for the second workflow: ``loader_module``, ``data_path``</span>
<span class="sd">    and the parameters for the first workflow: ``python_model``, ``artifacts`` together.</span>

<span class="sd">    :param artifact_path: The run-relative artifact path to which to log the Python model.</span>
<span class="sd">    :param loader_module: The name of the Python module that is used to load the model</span>
<span class="sd">                          from ``data_path``. This module must define a method with the prototype</span>
<span class="sd">                          ``_load_pyfunc(data_path)``. If not ``None``, this module and its</span>
<span class="sd">                          dependencies must be included in one of the following locations:</span>

<span class="sd">                          - The MLflow library.</span>
<span class="sd">                          - Package(s) listed in the model&#39;s Conda environment, specified by</span>
<span class="sd">                            the ``conda_env`` parameter.</span>
<span class="sd">                          - One or more of the files specified by the ``code_path`` parameter.</span>

<span class="sd">    :param data_path: Path to a file or directory containing model data.</span>
<span class="sd">    :param code_path: A list of local filesystem paths to Python file dependencies (or directories</span>
<span class="sd">                      containing file dependencies). These files are *prepended* to the system</span>
<span class="sd">                      path before the model is loaded.</span>
<span class="sd">    :param conda_env: {{ conda_env }}</span>
<span class="sd">    :param python_model: An instance of a subclass of :class:`~PythonModel`. This class is</span>
<span class="sd">                         serialized using the CloudPickle library. Any dependencies of the class</span>
<span class="sd">                         should be included in one of the following locations:</span>

<span class="sd">                            - The MLflow library.</span>
<span class="sd">                            - Package(s) listed in the model&#39;s Conda environment, specified by</span>
<span class="sd">                              the ``conda_env`` parameter.</span>
<span class="sd">                            - One or more of the files specified by the ``code_path`` parameter.</span>

<span class="sd">                         Note: If the class is imported from another module, as opposed to being</span>
<span class="sd">                         defined in the ``__main__`` scope, the defining module should also be</span>
<span class="sd">                         included in one of the listed locations.</span>
<span class="sd">    :param artifacts: A dictionary containing ``&lt;name, artifact_uri&gt;`` entries. Remote artifact URIs</span>
<span class="sd">                      are resolved to absolute filesystem paths, producing a dictionary of</span>
<span class="sd">                      ``&lt;name, absolute_path&gt;`` entries. ``python_model`` can reference these</span>
<span class="sd">                      resolved entries as the ``artifacts`` property of the ``context`` parameter</span>
<span class="sd">                      in :func:`PythonModel.load_context() &lt;mlflow.pyfunc.PythonModel.load_context&gt;`</span>
<span class="sd">                      and :func:`PythonModel.predict() &lt;mlflow.pyfunc.PythonModel.predict&gt;`.</span>
<span class="sd">                      For example, consider the following ``artifacts`` dictionary::</span>

<span class="sd">                        {</span>
<span class="sd">                            &quot;my_file&quot;: &quot;s3://my-bucket/path/to/my/file&quot;</span>
<span class="sd">                        }</span>

<span class="sd">                      In this case, the ``&quot;my_file&quot;`` artifact is downloaded from S3. The</span>
<span class="sd">                      ``python_model`` can then refer to ``&quot;my_file&quot;`` as an absolute filesystem</span>
<span class="sd">                      path via ``context.artifacts[&quot;my_file&quot;]``.</span>

<span class="sd">                      If ``None``, no artifacts are added to the model.</span>
<span class="sd">    :param registered_model_name: This argument may change or be removed in a</span>
<span class="sd">                                  future release without warning. If given, create a model</span>
<span class="sd">                                  version under ``registered_model_name``, also creating a</span>
<span class="sd">                                  registered model if one with the given name does not exist.</span>

<span class="sd">    :param signature: :py:class:`ModelSignature &lt;mlflow.models.ModelSignature&gt;`</span>
<span class="sd">                      describes model input and output :py:class:`Schema &lt;mlflow.types.Schema&gt;`.</span>
<span class="sd">                      The model signature can be :py:func:`inferred &lt;mlflow.models.infer_signature&gt;`</span>
<span class="sd">                      from datasets with valid model input (e.g. the training dataset with target</span>
<span class="sd">                      column omitted) and valid model output (e.g. model predictions generated on</span>
<span class="sd">                      the training dataset), for example:</span>

<span class="sd">                      .. code-block:: python</span>

<span class="sd">                        from mlflow.models.signature import infer_signature</span>
<span class="sd">                        train = df.drop_column(&quot;target_label&quot;)</span>
<span class="sd">                        predictions = ... # compute model predictions</span>
<span class="sd">                        signature = infer_signature(train, predictions)</span>
<span class="sd">    :param input_example: Input example provides one or several instances of valid</span>
<span class="sd">                          model input. The example can be used as a hint of what data to feed the</span>
<span class="sd">                          model. The given example can be a Pandas DataFrame where the given</span>
<span class="sd">                          example will be serialized to json using the Pandas split-oriented</span>
<span class="sd">                          format, or a numpy array where the example will be serialized to json</span>
<span class="sd">                          by converting it to a list. Bytes are base64-encoded.</span>
<span class="sd">    :param await_registration_for: Number of seconds to wait for the model version to finish</span>
<span class="sd">                            being created and is in ``READY`` status. By default, the function</span>
<span class="sd">                            waits for five minutes. Specify 0 or None to skip waiting.</span>
<span class="sd">    :param pip_requirements: {{ pip_requirements }}</span>
<span class="sd">    :param extra_pip_requirements: {{ extra_pip_requirements }}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Model</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
        <span class="n">artifact_path</span><span class="o">=</span><span class="n">artifact_path</span><span class="p">,</span>
        <span class="n">flavor</span><span class="o">=</span><span class="n">mlflow</span><span class="o">.</span><span class="n">pyfunc</span><span class="p">,</span>
        <span class="n">loader_module</span><span class="o">=</span><span class="n">loader_module</span><span class="p">,</span>
        <span class="n">data_path</span><span class="o">=</span><span class="n">data_path</span><span class="p">,</span>
        <span class="n">code_path</span><span class="o">=</span><span class="n">code_path</span><span class="p">,</span>
        <span class="n">python_model</span><span class="o">=</span><span class="n">python_model</span><span class="p">,</span>
        <span class="n">artifacts</span><span class="o">=</span><span class="n">artifacts</span><span class="p">,</span>
        <span class="n">conda_env</span><span class="o">=</span><span class="n">conda_env</span><span class="p">,</span>
        <span class="n">registered_model_name</span><span class="o">=</span><span class="n">registered_model_name</span><span class="p">,</span>
        <span class="n">signature</span><span class="o">=</span><span class="n">signature</span><span class="p">,</span>
        <span class="n">input_example</span><span class="o">=</span><span class="n">input_example</span><span class="p">,</span>
        <span class="n">await_registration_for</span><span class="o">=</span><span class="n">await_registration_for</span><span class="p">,</span>
        <span class="n">pip_requirements</span><span class="o">=</span><span class="n">pip_requirements</span><span class="p">,</span>
        <span class="n">extra_pip_requirements</span><span class="o">=</span><span class="n">extra_pip_requirements</span><span class="p">,</span>
    <span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_save_model_with_loader_module_and_data_path</span><span class="p">(</span>
    <span class="n">path</span><span class="p">,</span>
    <span class="n">loader_module</span><span class="p">,</span>
    <span class="n">data_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">code_paths</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">conda_env</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">mlflow_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">pip_requirements</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">extra_pip_requirements</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Export model as a generic Python function model.</span>
<span class="sd">    :param path: The path to which to save the Python model.</span>
<span class="sd">    :param loader_module: The name of the Python module that is used to load the model</span>
<span class="sd">                          from ``data_path``. This module must define a method with the prototype</span>
<span class="sd">                          ``_load_pyfunc(data_path)``.</span>
<span class="sd">    :param data_path: Path to a file or directory containing model data.</span>
<span class="sd">    :param code_paths: A list of local filesystem paths to Python file dependencies (or directories</span>
<span class="sd">                      containing file dependencies). These files are *prepended* to the system</span>
<span class="sd">                      path before the model is loaded.</span>
<span class="sd">    :param conda_env: Either a dictionary representation of a Conda environment or the path to a</span>
<span class="sd">                      Conda environment yaml file. If provided, this decsribes the environment</span>
<span class="sd">                      this model should be run in.</span>
<span class="sd">    :return: Model configuration containing model info.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">code</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">data_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">model_file</span> <span class="o">=</span> <span class="n">_copy_file_or_tree</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="n">data_path</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">dst_dir</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">model_file</span>

    <span class="k">if</span> <span class="n">code_paths</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">code_path</span> <span class="ow">in</span> <span class="n">code_paths</span><span class="p">:</span>
            <span class="n">_copy_file_or_tree</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="n">code_path</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">dst_dir</span><span class="o">=</span><span class="s2">&quot;code&quot;</span><span class="p">)</span>
        <span class="n">code</span> <span class="o">=</span> <span class="s2">&quot;code&quot;</span>

    <span class="k">if</span> <span class="n">mlflow_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mlflow_model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">()</span>

    <span class="n">mlflow</span><span class="o">.</span><span class="n">pyfunc</span><span class="o">.</span><span class="n">add_to_model</span><span class="p">(</span>
        <span class="n">mlflow_model</span><span class="p">,</span> <span class="n">loader_module</span><span class="o">=</span><span class="n">loader_module</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="n">code</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">_CONDA_ENV_FILE_NAME</span>
    <span class="p">)</span>
    <span class="n">mlflow_model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">MLMODEL_FILE_NAME</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">conda_env</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pip_requirements</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">default_reqs</span> <span class="o">=</span> <span class="n">get_default_pip_requirements</span><span class="p">()</span>
            <span class="c1"># To ensure `_load_pyfunc` can successfully load the model during the dependency</span>
            <span class="c1"># inference, `mlflow_model.save` must be called beforehand to save an MLmodel file.</span>
            <span class="n">inferred_reqs</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">infer_pip_requirements</span><span class="p">(</span>
                <span class="n">path</span><span class="p">,</span> <span class="n">FLAVOR_NAME</span><span class="p">,</span> <span class="n">fallback</span><span class="o">=</span><span class="n">default_reqs</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">default_reqs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">inferred_reqs</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">default_reqs</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">default_reqs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">conda_env</span><span class="p">,</span> <span class="n">pip_requirements</span><span class="p">,</span> <span class="n">pip_constraints</span> <span class="o">=</span> <span class="n">_process_pip_requirements</span><span class="p">(</span>
            <span class="n">default_reqs</span><span class="p">,</span> <span class="n">pip_requirements</span><span class="p">,</span> <span class="n">extra_pip_requirements</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">conda_env</span><span class="p">,</span> <span class="n">pip_requirements</span><span class="p">,</span> <span class="n">pip_constraints</span> <span class="o">=</span> <span class="n">_process_conda_env</span><span class="p">(</span><span class="n">conda_env</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">_CONDA_ENV_FILE_NAME</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">yaml</span><span class="o">.</span><span class="n">safe_dump</span><span class="p">(</span><span class="n">conda_env</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Save `constraints.txt` if necessary</span>
    <span class="k">if</span> <span class="n">pip_constraints</span><span class="p">:</span>
        <span class="n">write_to</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">_CONSTRAINTS_FILE_NAME</span><span class="p">),</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pip_constraints</span><span class="p">))</span>

    <span class="c1"># Save `requirements.txt`</span>
    <span class="n">write_to</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">_REQUIREMENTS_FILE_NAME</span><span class="p">),</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pip_requirements</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">mlflow_model</span>


<span class="n">loader_template</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>

<span class="s2">import importlib</span>
<span class="s2">import os</span>
<span class="s2">import sys</span>

<span class="s2">def load_pyfunc():</span>
<span class="s2">    </span><span class="si">{update_path}</span><span class="s2">return importlib.import_module(&#39;</span><span class="si">{main}</span><span class="s2">&#39;)._load_pyfunc(&#39;</span><span class="si">{data_path}</span><span class="s2">&#39;)</span>

<span class="s2">&quot;&quot;&quot;</span>
</pre></div>

              </div>
            </div>
            <footer>
  

  <hr/>

  <div role="contentinfo">
      <p class="copyright">
          &copy; MLflow Project, a Series of LF Projects, LLC. All rights reserved.
      </p>

  </div> 

</footer>
          </div>
        </div>
      </section>
    </main>
  </page>

  


  
  <script type="text/javascript">
    var DOCUMENTATION_OPTIONS = {
      URL_ROOT:'../../',
      VERSION:'1.21.0',
      COLLAPSE_INDEX:false,
      FILE_SUFFIX:'.html',
      HAS_SOURCE:  true
    };
  </script>
  <script type="text/javascript" src="../../_static/jquery.js"></script>
  <script type="text/javascript" src="../../_static/underscore.js"></script>
  <script type="text/javascript" src="../../_static/doctools.js"></script>
  <script type="text/javascript" src="../../_static/languagesections.js"></script>
  

  <script type="text/javascript" src="../../_static/js/clipboard.min.js"></script>
  <script type="text/javascript" src="../../_static/js/jquery.waypoints.min.js"></script>

  
  
  
  <script type="text/javascript">var CLIPPY_SVG_PATH = "../../_static/clippy.svg";</script>
  <script type="text/javascript" src="../../_static/js/custom.js"></script>
  

  
  
  <script type="text/javascript">
    jQuery(function () {
      SphinxRtdTheme.StickyNav.enable();
    });

  </script>
  
 
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-44077918-9"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-44077918-9');
</script>


  
    <!-- Algolia Search -->
    <script type="text/javascript">
      var algoliaConfigs = {
        key: 'b6d79a1058f2b3c1ee03bf659ade5a4b',
        index: 'mlflow',
      };
    </script>
    <div id="algolia-wrapper"></div>
    <script src="../../_static/js/tether.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
  
</body>
</html>