
  

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>mlflow.azureml</title>
  
   
  <link rel="canonical" href="https://www.mlflow.org/docs/latest/_modules/mlflow/azureml.html">
  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    

    

  
    
        <!-- Google Tag Manager -->
        <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer',"GTM-N6WMTTJ");</script>
        <!-- End Google Tag Manager -->
    

  

  
  
    

  

  
  
    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600" rel="stylesheet">
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
    
    <link rel="stylesheet" href="../../_static/css/algolia.css" type="text/css" />
    
  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="MLflow 1.30.1 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-N6WMTTJ"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
  

  
  <nav class="wy-nav-top header" role="navigation" aria-label="top navigation">
    <ul>
  <li class="menu-toggle">
    <i data-toggle="wy-nav-top" class="wy-nav-top-menu-button db-icon db-icon-menu pull-left"></i>
    <a href="../../index.html" class="wy-nav-top-logo"
      ><img src="../../_static/MLflow-logo-final-black.png" alt="MLflow"
    /></a>
    <span class="version">1.30.1</span>
  </li>
</ul>
  </nav>
  <page>
    

    <nav data-toggle="wy-nav-shift" class="wy-nav-side relative">
      <div class="wy-side-scroll">
  <div class="wy-side-nav-search">
    

    

    
<div role="search">
  
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
  </form>
  
</div>


    
  </div>

  <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
    
      <a href="../../index.html" class="main-navigation-home"><img src="../../_static/icons/nav-home.svg"> MLflow</a>
    

    
      

      
        <ul>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials-and-examples/index.html">Tutorials and Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../concepts.html">Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tracking.html">MLflow Tracking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../projects.html">MLflow Projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../models.html">MLflow Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model-registry.html">MLflow Model Registry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pipelines.html">MLflow Pipelines (experimental)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plugins.html">MLflow Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cli.html">Command-Line Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../search-runs.html">Search Runs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../search-experiments.html">Search Experiments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python_api/index.html">Python API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../R-api.html">R API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../java_api/index.html">Java API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rest-api.html">REST API</a></li>
</ul>

      
    
  </div>

  <div role="contentinfo">
    

    <p>
      <a id='feedbacklink' href="https://github.com/mlflow/mlflow/blob/master/CONTRIBUTING.md" target="_blank">Contribute</a>
    </p>
  </div>
</div>
    </nav>

    <main class="wy-grid-for-nav">
      <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
        <div class="wy-nav-content">
          <div class="rst-content">
            










<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Documentation</a> <span class="db-icon db-icon-chevron-right"></span></li>
    
        <li><a href="../index.html">Module code</a> <span class="db-icon db-icon-chevron-right"></span></li>
    
    
      <li>mlflow.azureml</li>
    
    
    <li class="wy-breadcrumbs-aside">
      <a href="https://github.com/mlflow/mlflow/blob/master/docs/source/_modules/mlflow/azureml" class="fa fa-github"> Edit on GitHub</a>
    </li>
    
  </ul>
</div>
            <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
              <div itemprop="articleBody">
                
  <h1>Source code for mlflow.azureml</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The ``mlflow.azureml`` module provides an API for deploying MLflow models to Azure</span>
<span class="sd">Machine Learning.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">uuid</span>

<span class="kn">from</span> <span class="nn">packaging.version</span> <span class="kn">import</span> <span class="n">Version</span>

<span class="kn">from</span> <span class="nn">mlflow</span> <span class="kn">import</span> <span class="n">get_tracking_uri</span><span class="p">,</span> <span class="n">get_registry_uri</span>
<span class="kn">from</span> <span class="nn">mlflow</span> <span class="kn">import</span> <span class="n">pyfunc</span>
<span class="kn">from</span> <span class="nn">mlflow</span> <span class="kn">import</span> <span class="n">register_model</span> <span class="k">as</span> <span class="n">mlflow_register_model</span>
<span class="kn">from</span> <span class="nn">mlflow.exceptions</span> <span class="kn">import</span> <span class="n">MlflowException</span>
<span class="kn">from</span> <span class="nn">mlflow.models</span> <span class="kn">import</span> <span class="n">Model</span>
<span class="kn">from</span> <span class="nn">mlflow.models.model</span> <span class="kn">import</span> <span class="n">MLMODEL_FILE_NAME</span>
<span class="kn">from</span> <span class="nn">mlflow.protos.databricks_pb2</span> <span class="kn">import</span> <span class="n">INVALID_PARAMETER_VALUE</span>
<span class="kn">from</span> <span class="nn">mlflow.tracking.artifact_utils</span> <span class="kn">import</span> <span class="n">_download_artifact_from_uri</span>
<span class="kn">from</span> <span class="nn">mlflow.utils</span> <span class="kn">import</span> <span class="n">get_unique_resource_id</span>
<span class="kn">from</span> <span class="nn">mlflow.utils.annotations</span> <span class="kn">import</span> <span class="n">deprecated</span>
<span class="kn">from</span> <span class="nn">mlflow.utils.file_utils</span> <span class="kn">import</span> <span class="n">TempDir</span><span class="p">,</span> <span class="n">_copy_file_or_tree</span><span class="p">,</span> <span class="n">_copy_project</span>
<span class="kn">from</span> <span class="nn">mlflow.version</span> <span class="kn">import</span> <span class="n">VERSION</span> <span class="k">as</span> <span class="n">mlflow_version</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>


<span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="build_image"><a class="viewcode-back" href="../../python_api/mlflow.azureml.html#mlflow.azureml.build_image">[docs]</a><span class="nd">@deprecated</span><span class="p">(</span><span class="s2">&quot;the azureml deployment plugin, https://aka.ms/aml-mlflow-deploy&quot;</span><span class="p">,</span> <span class="n">since</span><span class="o">=</span><span class="s2">&quot;1.19.0&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">build_image</span><span class="p">(</span>
    <span class="n">model_uri</span><span class="p">,</span>
    <span class="n">workspace</span><span class="p">,</span>
    <span class="n">image_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">model_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">mlflow_home</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">tags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">synchronous</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Register an MLflow model with Azure ML and build an Azure ML ContainerImage for deployment.</span>
<span class="sd">    The resulting image can be deployed as a web service to Azure Container Instances (ACI) or</span>
<span class="sd">    Azure Kubernetes Service (AKS).</span>

<span class="sd">    The resulting Azure ML ContainerImage will contain a webserver that processes model queries.</span>
<span class="sd">    For information about the input data formats accepted by this webserver, see the</span>
<span class="sd">    :ref:`MLflow deployment tools documentation &lt;azureml_deployment&gt;`.</span>

<span class="sd">    :param model_uri: The location, in URI format, of the MLflow model used to build the Azure</span>
<span class="sd">                      ML deployment image. For example:</span>

<span class="sd">                      - ``/Users/me/path/to/local/model``</span>
<span class="sd">                      - ``relative/path/to/local/model``</span>
<span class="sd">                      - ``s3://my_bucket/path/to/model``</span>
<span class="sd">                      - ``runs:/&lt;mlflow_run_id&gt;/run-relative/path/to/model``</span>
<span class="sd">                      - ``models:/&lt;model_name&gt;/&lt;model_version&gt;``</span>
<span class="sd">                      - ``models:/&lt;model_name&gt;/&lt;stage&gt;``</span>

<span class="sd">                      For more information about supported URI schemes, see</span>
<span class="sd">                      `Referencing Artifacts &lt;https://www.mlflow.org/docs/latest/concepts.html#</span>
<span class="sd">                      artifact-locations&gt;`_.</span>

<span class="sd">    :param image_name: The name to assign the Azure Container Image that will be created. If</span>
<span class="sd">                       unspecified, a unique image name will be generated.</span>
<span class="sd">    :param model_name: The name to assign the Azure Model will be created. If unspecified,</span>
<span class="sd">                       a unique model name will be generated.</span>
<span class="sd">    :param workspace: The AzureML workspace in which to build the image. This is a</span>
<span class="sd">                      `azureml.core.Workspace` object.</span>
<span class="sd">    :param mlflow_home: Path to a local copy of the MLflow GitHub repository. If specified, the</span>
<span class="sd">                        image will install MLflow from this directory. Otherwise, it will install</span>
<span class="sd">                        MLflow from pip.</span>
<span class="sd">    :param description: A string description to associate with the Azure Container Image and the</span>
<span class="sd">                        Azure Model that will be created. For more information, see</span>
<span class="sd">                        `&lt;https://docs.microsoft.com/en-us/python/api/azureml-core/</span>
<span class="sd">                        azureml.core.image.container.containerimageconfig?view=azure-ml-py&gt;`_ and</span>
<span class="sd">                        `&lt;https://docs.microsoft.com/en-us/python/api/azureml-core/</span>
<span class="sd">                        azureml.core.model.model?view=azure-ml-py#register&gt;`_.</span>
<span class="sd">    :param tags: A collection of tags, represented as a dictionary of string key-value pairs, to</span>
<span class="sd">                 associate with the Azure Container Image and the Azure Model that will be created.</span>
<span class="sd">                 These tags are added to a set of default tags that include the model uri,</span>
<span class="sd">                 and more. For more information, see</span>
<span class="sd">                 `&lt;https://docs.microsoft.com/en-us/python/api/azureml-core/</span>
<span class="sd">                 azureml.core.image.container.containerimageconfig?view-azure-ml-py&gt;`_ and</span>
<span class="sd">                 `&lt;https://docs.microsoft.com/en-us/python/api/azureml-core/</span>
<span class="sd">                 azureml.core.model.model?view=azure-ml-py#register&gt;`_.</span>
<span class="sd">    :param synchronous: If ``True``, this method blocks until the image creation procedure</span>
<span class="sd">                        terminates before returning. If ``False``, the method returns immediately,</span>
<span class="sd">                        but the returned image will not be available until the asynchronous</span>
<span class="sd">                        creation process completes. Use the</span>
<span class="sd">                        ``azureml.core.Image.wait_for_creation()`` function to wait for the creation</span>
<span class="sd">                        process to complete.</span>
<span class="sd">    :return: A tuple containing the following elements in order:</span>
<span class="sd">            - An ``azureml.core.image.ContainerImage`` object containing metadata for the new image.</span>
<span class="sd">            - An ``azureml.core.model.Model`` object containing metadata for the new model.</span>

<span class="sd">    .. code-block:: python</span>
<span class="sd">        :caption: Example</span>

<span class="sd">        import mlflow.azureml</span>
<span class="sd">        from azureml.core import Workspace</span>
<span class="sd">        from azureml.core.webservice import AciWebservice, Webservice</span>

<span class="sd">        # Load or create an Azure ML Workspace</span>
<span class="sd">        workspace_name = &quot;&lt;Name of your Azure ML workspace&gt;&quot;</span>
<span class="sd">        subscription_id = &quot;&lt;Your Azure subscription ID&gt;&quot;</span>
<span class="sd">        resource_group = &quot;&lt;Name of the Azure resource group in which to create Azure ML resources&gt;&quot;</span>
<span class="sd">        location = &quot;&lt;Name of the Azure location (region) in which to create Azure ML resources&gt;&quot;</span>
<span class="sd">        azure_workspace = Workspace.create(name=workspace_name,</span>
<span class="sd">                                           subscription_id=subscription_id,</span>
<span class="sd">                                           resource_group=resource_group,</span>
<span class="sd">                                           location=location,</span>
<span class="sd">                                           create_resource_group=True,</span>
<span class="sd">                                           exist_ok=True)</span>

<span class="sd">        # Build an Azure ML Container Image for an MLflow model</span>
<span class="sd">        azure_image, azure_model = mlflow.azureml.build_image(model_uri=&quot;&lt;model_uri&gt;&quot;,</span>
<span class="sd">                                                              workspace=azure_workspace,</span>
<span class="sd">                                                              synchronous=True)</span>
<span class="sd">        # If your image build failed, you can access build logs at the following URI:</span>
<span class="sd">        print(&quot;Access the following URI for build logs: {}&quot;.format(azure_image.image_build_log_uri))</span>

<span class="sd">        # Deploy the image to Azure Container Instances (ACI) for real-time serving</span>
<span class="sd">        webservice_deployment_config = AciWebservice.deploy_configuration()</span>
<span class="sd">        webservice = Webservice.deploy_from_image(</span>
<span class="sd">                            image=azure_image, workspace=azure_workspace, name=&quot;&lt;deployment-name&gt;&quot;)</span>
<span class="sd">        webservice.wait_for_deployment()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># The Azure ML SDK is only compatible with Python 3. However, the `mlflow.azureml` module should</span>
    <span class="c1"># still be accessible for import from Python 2. Therefore, we will only import from the SDK</span>
    <span class="c1"># upon method invocation.</span>
    <span class="c1"># pylint: disable=import-error</span>
    <span class="kn">from</span> <span class="nn">azureml.core.image</span> <span class="kn">import</span> <span class="n">ContainerImage</span>
    <span class="kn">from</span> <span class="nn">azureml.core.model</span> <span class="kn">import</span> <span class="n">Model</span> <span class="k">as</span> <span class="n">AzureModel</span>

    <span class="n">absolute_model_path</span> <span class="o">=</span> <span class="n">_download_artifact_from_uri</span><span class="p">(</span><span class="n">model_uri</span><span class="p">)</span>

    <span class="n">model_pyfunc_conf</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_load_pyfunc_conf_with_model</span><span class="p">(</span><span class="n">model_path</span><span class="o">=</span><span class="n">absolute_model_path</span><span class="p">)</span>
    <span class="n">model_python_version</span> <span class="o">=</span> <span class="n">model_pyfunc_conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pyfunc</span><span class="o">.</span><span class="n">PY_VERSION</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">model_python_version</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">Version</span><span class="p">(</span><span class="n">model_python_version</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">Version</span><span class="p">(</span><span class="s2">&quot;3.0.0&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="p">(</span>
                <span class="s2">&quot;Azure ML can only deploy models trained in Python 3 and above. See&quot;</span>
                <span class="s2">&quot; the following MLflow GitHub issue for a thorough explanation of this&quot;</span>
                <span class="s2">&quot; limitation and a workaround to enable support for deploying models&quot;</span>
                <span class="s2">&quot; trained in Python 2: https://github.com/mlflow/mlflow/issues/668&quot;</span>
            <span class="p">),</span>
            <span class="n">error_code</span><span class="o">=</span><span class="n">INVALID_PARAMETER_VALUE</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">tags</span> <span class="o">=</span> <span class="n">_build_tags</span><span class="p">(</span>
        <span class="n">model_uri</span><span class="o">=</span><span class="n">model_uri</span><span class="p">,</span> <span class="n">model_python_version</span><span class="o">=</span><span class="n">model_python_version</span><span class="p">,</span> <span class="n">user_tags</span><span class="o">=</span><span class="n">tags</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">image_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">image_name</span> <span class="o">=</span> <span class="n">_get_mlflow_azure_resource_name</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">model_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">model_name</span> <span class="o">=</span> <span class="n">_get_mlflow_azure_resource_name</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">TempDir</span><span class="p">(</span><span class="n">chdr</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">tmp</span><span class="p">:</span>
        <span class="n">model_directory_path</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">)</span>
        <span class="n">tmp_model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">model_directory_path</span><span class="p">,</span>
            <span class="n">_copy_file_or_tree</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="n">absolute_model_path</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">model_directory_path</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="n">registered_model</span> <span class="o">=</span> <span class="n">AzureModel</span><span class="o">.</span><span class="n">register</span><span class="p">(</span>
            <span class="n">workspace</span><span class="o">=</span><span class="n">workspace</span><span class="p">,</span>
            <span class="n">model_path</span><span class="o">=</span><span class="n">tmp_model_path</span><span class="p">,</span>
            <span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
            <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Registered an Azure Model with name: `</span><span class="si">%s</span><span class="s2">` and version: `</span><span class="si">%s</span><span class="s2">`&quot;</span><span class="p">,</span>
            <span class="n">registered_model</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">registered_model</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Create an execution script (entry point) for the image&#39;s model server. Azure ML requires</span>
        <span class="c1"># the container&#39;s execution script to be located in the current working directory during</span>
        <span class="c1"># image creation, so we create the execution script as a temporary file in the current</span>
        <span class="c1"># working directory.</span>
        <span class="n">execution_script_path</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="s2">&quot;execution_script.py&quot;</span><span class="p">)</span>
        <span class="n">_create_execution_script</span><span class="p">(</span><span class="n">output_path</span><span class="o">=</span><span class="n">execution_script_path</span><span class="p">,</span> <span class="n">azure_model</span><span class="o">=</span><span class="n">registered_model</span><span class="p">)</span>
        <span class="c1"># Azure ML copies the execution script into the image&#39;s application root directory by</span>
        <span class="c1"># prepending &quot;/var/azureml-app&quot; to the specified script path. The script is then executed</span>
        <span class="c1"># by referencing its path relative to the &quot;/var/azureml-app&quot; directory. Unfortunately,</span>
        <span class="c1"># if the script path is an absolute path, Azure ML attempts to reference it directly,</span>
        <span class="c1"># resulting in a failure. To circumvent this problem, we provide Azure ML with the relative</span>
        <span class="c1"># script path. Because the execution script was created in the current working directory,</span>
        <span class="c1"># this relative path is the script path&#39;s base name.</span>
        <span class="n">execution_script_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">execution_script_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mlflow_home</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Copying the specified mlflow_home directory: `</span><span class="si">%s</span><span class="s2">` to a temporary location for&quot;</span>
                <span class="s2">&quot; container creation&quot;</span><span class="p">,</span>
                <span class="n">mlflow_home</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">mlflow_home</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">tmp</span><span class="o">.</span><span class="n">path</span><span class="p">(),</span> <span class="n">_copy_project</span><span class="p">(</span><span class="n">src_path</span><span class="o">=</span><span class="n">mlflow_home</span><span class="p">,</span> <span class="n">dst_path</span><span class="o">=</span><span class="n">tmp</span><span class="o">.</span><span class="n">path</span><span class="p">())</span>
            <span class="p">)</span>
            <span class="n">image_file_dependencies</span> <span class="o">=</span> <span class="p">[</span><span class="n">mlflow_home</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">image_file_dependencies</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">dockerfile_path</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="s2">&quot;Dockerfile&quot;</span><span class="p">)</span>
        <span class="n">_create_dockerfile</span><span class="p">(</span><span class="n">output_path</span><span class="o">=</span><span class="n">dockerfile_path</span><span class="p">,</span> <span class="n">mlflow_path</span><span class="o">=</span><span class="n">mlflow_home</span><span class="p">)</span>

        <span class="n">conda_env_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">pyfunc</span><span class="o">.</span><span class="n">ENV</span> <span class="ow">in</span> <span class="n">model_pyfunc_conf</span><span class="p">:</span>
            <span class="n">conda_env_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_model_path</span><span class="p">,</span> <span class="n">model_pyfunc_conf</span><span class="p">[</span><span class="n">pyfunc</span><span class="o">.</span><span class="n">ENV</span><span class="p">])</span>

        <span class="n">image_configuration</span> <span class="o">=</span> <span class="n">ContainerImage</span><span class="o">.</span><span class="n">image_configuration</span><span class="p">(</span>
            <span class="n">execution_script</span><span class="o">=</span><span class="n">execution_script_path</span><span class="p">,</span>
            <span class="n">runtime</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">,</span>
            <span class="n">docker_file</span><span class="o">=</span><span class="n">dockerfile_path</span><span class="p">,</span>
            <span class="n">dependencies</span><span class="o">=</span><span class="n">image_file_dependencies</span><span class="p">,</span>
            <span class="n">conda_file</span><span class="o">=</span><span class="n">conda_env_path</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
            <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">ContainerImage</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">workspace</span><span class="o">=</span><span class="n">workspace</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">image_name</span><span class="p">,</span>
            <span class="n">image_config</span><span class="o">=</span><span class="n">image_configuration</span><span class="p">,</span>
            <span class="n">models</span><span class="o">=</span><span class="p">[</span><span class="n">registered_model</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Building an Azure Container Image with name: `</span><span class="si">%s</span><span class="s2">` and version: `</span><span class="si">%s</span><span class="s2">`&quot;</span><span class="p">,</span>
            <span class="n">image</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">image</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">synchronous</span><span class="p">:</span>
            <span class="n">image</span><span class="o">.</span><span class="n">wait_for_creation</span><span class="p">(</span><span class="n">show_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">registered_model</span></div>


<div class="viewcode-block" id="deploy"><a class="viewcode-back" href="../../python_api/mlflow.azureml.html#mlflow.azureml.deploy">[docs]</a><span class="nd">@deprecated</span><span class="p">(</span><span class="s2">&quot;the azureml deployment plugin, https://aka.ms/aml-mlflow-deploy&quot;</span><span class="p">,</span> <span class="n">since</span><span class="o">=</span><span class="s2">&quot;1.19.0&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">deploy</span><span class="p">(</span>
    <span class="n">model_uri</span><span class="p">,</span>
    <span class="n">workspace</span><span class="p">,</span>
    <span class="n">deployment_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">service_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">model_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">tags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">mlflow_home</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">synchronous</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Register an MLflow model with Azure ML and deploy a websevice to Azure Container Instances (ACI)</span>
<span class="sd">    or Azure Kubernetes Service (AKS).</span>

<span class="sd">    The deployed service will contain a webserver that processes model queries.</span>
<span class="sd">    For information about the input data formats accepted by this webserver, see the</span>
<span class="sd">    :ref:`MLflow deployment tools documentation &lt;azureml_deployment&gt;`.</span>

<span class="sd">    :param model_uri: The location, in URI format, of the MLflow model used to build the Azure</span>
<span class="sd">                      ML deployment image. For example:</span>

<span class="sd">                      - ``/Users/me/path/to/local/model``</span>
<span class="sd">                      - ``relative/path/to/local/model``</span>
<span class="sd">                      - ``s3://my_bucket/path/to/model``</span>
<span class="sd">                      - ``runs:/&lt;mlflow_run_id&gt;/run-relative/path/to/model``</span>
<span class="sd">                      - ``models:/&lt;model_name&gt;/&lt;model_version&gt;``</span>
<span class="sd">                      - ``models:/&lt;model_name&gt;/&lt;stage&gt;``</span>

<span class="sd">                      For more information about supported URI schemes, see</span>
<span class="sd">                      `Referencing Artifacts &lt;https://www.mlflow.org/docs/latest/concepts.html#</span>
<span class="sd">                      artifact-locations&gt;`_.</span>
<span class="sd">    :param workspace: The AzureML workspace in which to deploy the service. This is a</span>
<span class="sd">                      `azureml.core.Workspace` object.</span>
<span class="sd">    :param deployment_config: The configuration for the Azure web service. This configuration</span>
<span class="sd">                              allows you to specify the resources the webservice will use and</span>
<span class="sd">                              the compute cluster it will be deployed in. If unspecified, the web</span>
<span class="sd">                              service will be deployed into a Azure Container Instance. This is a</span>
<span class="sd">                              `azureml.core.DeploymentConfig` object. For more information, see</span>
<span class="sd">                              `&lt;https://docs.microsoft.com/python/api/azureml-core/</span>
<span class="sd">                              azureml.core.webservice.aks.aksservicedeploymentconfiguration&gt;`_ and</span>
<span class="sd">                              `&lt;https://docs.microsoft.com/en-us/python/api/azureml-core/azureml</span>
<span class="sd">                              .core.webservice.aci.aciservicedeploymentconfiguration&gt;`_</span>
<span class="sd">    :param service_name: The name to assign the Azure Machine learning webservice that will be</span>
<span class="sd">                         created. If unspecified, a unique name will be generated.</span>
<span class="sd">    :param model_name: The name to assign the Azure Model will be created. If unspecified,</span>
<span class="sd">                       a unique model name will be generated. Only used if the model is not</span>
<span class="sd">                       already registered with Azure.</span>
<span class="sd">    :param tags: A collection of tags, represented as a dictionary of string key-value pairs, to</span>
<span class="sd">                 associate with the Azure Model and Deployment that will be created.</span>
<span class="sd">                 These tags are added to a set of default tags that include the model uri,</span>
<span class="sd">                 and more. For more information, see</span>
<span class="sd">                 `&lt;https://docs.microsoft.com/en-us/python/api/azureml-core/azureml.core.model(class)?view=azure-ml-py&gt;`_.</span>
<span class="sd">    :param mlflow_home: Path to a local copy of the MLflow GitHub repository. If specified, the</span>
<span class="sd">                        image will install MLflow from this directory. Otherwise, it will install</span>
<span class="sd">                        MLflow from pip.</span>
<span class="sd">    :param synchronous: If ``True``, this method blocks until the image creation procedure</span>
<span class="sd">                        terminates before returning. If ``False``, the method returns immediately,</span>
<span class="sd">                        but the returned image will not be available until the asynchronous</span>
<span class="sd">                        creation process completes. Use the</span>
<span class="sd">                        ``azureml.core.Webservice.wait_for_deployment()`` function to wait</span>
<span class="sd">                        for the deployment process to complete.</span>
<span class="sd">    :return: A tuple containing the following elements in order:</span>
<span class="sd">            - An ``azureml.core.webservice.Webservice`` object containing metadata for the</span>
<span class="sd">            new service.</span>
<span class="sd">            - An ``azureml.core.model.Model`` object containing metadata for the new model.</span>

<span class="sd">    .. code-block:: python</span>
<span class="sd">        :caption: Example</span>

<span class="sd">        import mlflow.azureml</span>
<span class="sd">        from azureml.core import Workspace</span>
<span class="sd">        from azureml.core.webservice import AciWebservice, Webservice</span>

<span class="sd">        # Load or create an Azure ML Workspace</span>
<span class="sd">        workspace_name = &quot;&lt;Name of your Azure ML workspace&gt;&quot;</span>
<span class="sd">        subscription_id = &quot;&lt;Your Azure subscription ID&gt;&quot;</span>
<span class="sd">        resource_group = &quot;&lt;Name of the Azure resource group in which to create Azure ML resources&gt;&quot;</span>
<span class="sd">        location = &quot;&lt;Name of the Azure location (region) in which to create Azure ML resources&gt;&quot;</span>
<span class="sd">        azure_workspace = Workspace.create(name=workspace_name,</span>
<span class="sd">                                           subscription_id=subscription_id,</span>
<span class="sd">                                           resource_group=resource_group,</span>
<span class="sd">                                           location=location,</span>
<span class="sd">                                           create_resource_group=True,</span>
<span class="sd">                                           exist_ok=True)</span>

<span class="sd">        # Create an Azure Container Instance webservice for an MLflow model</span>
<span class="sd">        azure_service, azure_model = mlflow.azureml.deploy(model_uri=&quot;&lt;model_uri&gt;&quot;,</span>
<span class="sd">                                                           service_name=&quot;&lt;deployment-name&gt;&quot;,</span>
<span class="sd">                                                           workspace=azure_workspace,</span>
<span class="sd">                                                           synchronous=True)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># The Azure ML SDK is only compatible with Python 3. However, the `mlflow.azureml` module should</span>
    <span class="c1"># still be accessible for import from Python 2. Therefore, we will only import from the SDK</span>
    <span class="c1"># upon method invocation.</span>
    <span class="c1"># pylint: disable=import-error</span>
    <span class="kn">from</span> <span class="nn">azureml.core.model</span> <span class="kn">import</span> <span class="n">Model</span> <span class="k">as</span> <span class="n">AzureModel</span><span class="p">,</span> <span class="n">InferenceConfig</span>
    <span class="kn">from</span> <span class="nn">azureml.core</span> <span class="kn">import</span> <span class="n">Environment</span> <span class="k">as</span> <span class="n">AzureEnvironment</span>
    <span class="kn">from</span> <span class="nn">azureml.core</span> <span class="kn">import</span> <span class="n">VERSION</span> <span class="k">as</span> <span class="n">AZUREML_VERSION</span>
    <span class="kn">from</span> <span class="nn">azureml.core.webservice</span> <span class="kn">import</span> <span class="n">AciWebservice</span>

    <span class="n">absolute_model_path</span> <span class="o">=</span> <span class="n">_download_artifact_from_uri</span><span class="p">(</span><span class="n">model_uri</span><span class="p">)</span>

    <span class="n">model_pyfunc_conf</span><span class="p">,</span> <span class="n">model</span> <span class="o">=</span> <span class="n">_load_pyfunc_conf_with_model</span><span class="p">(</span><span class="n">model_path</span><span class="o">=</span><span class="n">absolute_model_path</span><span class="p">)</span>
    <span class="n">model_python_version</span> <span class="o">=</span> <span class="n">model_pyfunc_conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pyfunc</span><span class="o">.</span><span class="n">PY_VERSION</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">run_id</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">run_id_tag</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">run_id</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">run_id</span>
        <span class="n">run_id_tag</span> <span class="o">=</span> <span class="n">run_id</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="n">run_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">model_python_version</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">Version</span><span class="p">(</span><span class="n">model_python_version</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">Version</span><span class="p">(</span><span class="s2">&quot;3.0.0&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="p">(</span>
                <span class="s2">&quot;Azure ML can only deploy models trained in Python 3 and above. See&quot;</span>
                <span class="s2">&quot; the following MLflow GitHub issue for a thorough explanation of this&quot;</span>
                <span class="s2">&quot; limitation and a workaround to enable support for deploying models&quot;</span>
                <span class="s2">&quot; trained in Python 2: https://github.com/mlflow/mlflow/issues/668&quot;</span>
            <span class="p">),</span>
            <span class="n">error_code</span><span class="o">=</span><span class="n">INVALID_PARAMETER_VALUE</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">tags</span> <span class="o">=</span> <span class="n">_build_tags</span><span class="p">(</span>
        <span class="n">model_uri</span><span class="o">=</span><span class="n">model_uri</span><span class="p">,</span>
        <span class="n">model_python_version</span><span class="o">=</span><span class="n">model_python_version</span><span class="p">,</span>
        <span class="n">user_tags</span><span class="o">=</span><span class="n">tags</span><span class="p">,</span>
        <span class="n">run_id</span><span class="o">=</span><span class="n">run_id_tag</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">service_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">service_name</span> <span class="o">=</span> <span class="n">_get_mlflow_azure_name</span><span class="p">(</span><span class="n">run_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">model_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">model_name</span> <span class="o">=</span> <span class="n">_get_mlflow_azure_name</span><span class="p">(</span><span class="n">run_id</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">TempDir</span><span class="p">(</span><span class="n">chdr</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">tmp</span><span class="p">:</span>
        <span class="n">model_directory_path</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">)</span>
        <span class="n">tmp_model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">model_directory_path</span><span class="p">,</span>
            <span class="n">_copy_file_or_tree</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="n">absolute_model_path</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">model_directory_path</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="n">registered_model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">azure_model_id</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># If we are passed a &#39;models&#39; uri, we will attempt to extract a name and version which</span>
        <span class="c1"># can be used to retreive an AzureML Model. This will ignore stage based model uris,</span>
        <span class="c1"># which is alright until we have full deployment plugin support.</span>
        <span class="c1">#</span>
        <span class="c1"># If instead we are passed a &#39;runs&#39; uri while the user is using the AzureML tracking</span>
        <span class="c1"># and registry stores, we will be able to register the model on their behalf using</span>
        <span class="c1"># the AzureML plugin, which will maintain lineage between the model and the run that</span>
        <span class="c1"># produced it. This returns an MLFlow Model object however, so we&#39;ll still need the</span>
        <span class="c1"># name and ID in order to retrieve the AzureML Model object which is currently</span>
        <span class="c1"># needed to deploy.</span>
        <span class="k">if</span> <span class="n">model_uri</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;models:/&quot;</span><span class="p">):</span>
            <span class="n">m_name</span> <span class="o">=</span> <span class="n">model_uri</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">m_version</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">model_uri</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">azure_model_id</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">m_name</span><span class="p">,</span> <span class="n">m_version</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span>
            <span class="n">model_uri</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;runs:/&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">get_tracking_uri</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;azureml&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">get_registry_uri</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;azureml&quot;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">mlflow_model</span> <span class="o">=</span> <span class="n">mlflow_register_model</span><span class="p">(</span><span class="n">model_uri</span><span class="p">,</span> <span class="n">model_name</span><span class="p">)</span>
            <span class="n">azure_model_id</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mlflow_model</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">mlflow_model</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>

            <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Registered an Azure Model with name: `</span><span class="si">%s</span><span class="s2">` and version: `</span><span class="si">%s</span><span class="s2">`&quot;</span><span class="p">,</span>
                <span class="n">mlflow_model</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">azure_model_id</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Attempt to retrieve an AzureML Model object which we intend to deploy</span>
        <span class="k">if</span> <span class="n">azure_model_id</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">registered_model</span> <span class="o">=</span> <span class="n">AzureModel</span><span class="p">(</span><span class="n">workspace</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">azure_model_id</span><span class="p">)</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Found registered model in AzureML with ID &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">azure_model_id</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Unable to find model in AzureML with ID &#39;</span><span class="si">%s</span><span class="s2">&#39;, will register the model.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;Exception was: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">azure_model_id</span><span class="p">,</span>
                    <span class="n">e</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="c1"># If we have not found a registered model by this point, we will register it on the users&#39;</span>
        <span class="c1"># behalf. It is required for a Model to be registered in some way with Azure in order to</span>
        <span class="c1"># deploy to Azure, so this is expected for Azure users.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">registered_model</span><span class="p">:</span>
            <span class="n">registered_model</span> <span class="o">=</span> <span class="n">AzureModel</span><span class="o">.</span><span class="n">register</span><span class="p">(</span>
                <span class="n">workspace</span><span class="o">=</span><span class="n">workspace</span><span class="p">,</span> <span class="n">model_path</span><span class="o">=</span><span class="n">tmp_model_path</span><span class="p">,</span> <span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="n">tags</span>
            <span class="p">)</span>

            <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Registered an Azure Model with name: `</span><span class="si">%s</span><span class="s2">` and version: `</span><span class="si">%s</span><span class="s2">`&quot;</span><span class="p">,</span>
                <span class="n">registered_model</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">registered_model</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Create an execution script (entry point) for the image&#39;s model server. Azure ML requires</span>
        <span class="c1"># the container&#39;s execution script to be located in the current working directory during</span>
        <span class="c1"># image creation, so we create the execution script as a temporary file in the current</span>
        <span class="c1"># working directory.</span>
        <span class="n">execution_script_path</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="s2">&quot;execution_script.py&quot;</span><span class="p">)</span>
        <span class="n">_create_execution_script</span><span class="p">(</span><span class="n">output_path</span><span class="o">=</span><span class="n">execution_script_path</span><span class="p">,</span> <span class="n">azure_model</span><span class="o">=</span><span class="n">registered_model</span><span class="p">)</span>

        <span class="n">environment</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">pyfunc</span><span class="o">.</span><span class="n">ENV</span> <span class="ow">in</span> <span class="n">model_pyfunc_conf</span><span class="p">:</span>
            <span class="n">environment</span> <span class="o">=</span> <span class="n">AzureEnvironment</span><span class="o">.</span><span class="n">from_conda_specification</span><span class="p">(</span>
                <span class="n">_get_mlflow_azure_name</span><span class="p">(</span><span class="n">run_id</span><span class="p">),</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_model_path</span><span class="p">,</span> <span class="n">model_pyfunc_conf</span><span class="p">[</span><span class="n">pyfunc</span><span class="o">.</span><span class="n">ENV</span><span class="p">]),</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">environment</span> <span class="o">=</span> <span class="n">AzureEnvironment</span><span class="p">(</span><span class="n">_get_mlflow_azure_name</span><span class="p">(</span><span class="n">run_id</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">mlflow_home</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="s2">&quot;dist&quot;</span><span class="p">)</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Bulding temporary MLFlow wheel in </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="n">wheel</span> <span class="o">=</span> <span class="n">_create_mlflow_wheel</span><span class="p">(</span><span class="n">mlflow_home</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="n">whl_url</span> <span class="o">=</span> <span class="n">AzureEnvironment</span><span class="o">.</span><span class="n">add_private_pip_wheel</span><span class="p">(</span>
                <span class="n">workspace</span><span class="o">=</span><span class="n">workspace</span><span class="p">,</span> <span class="n">file_path</span><span class="o">=</span><span class="n">wheel</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="n">environment</span><span class="o">.</span><span class="n">python</span><span class="o">.</span><span class="n">conda_dependencies</span><span class="o">.</span><span class="n">add_pip_package</span><span class="p">(</span><span class="n">whl_url</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">environment</span><span class="o">.</span><span class="n">python</span><span class="o">.</span><span class="n">conda_dependencies</span><span class="o">.</span><span class="n">add_pip_package</span><span class="p">(</span>
                <span class="s2">&quot;mlflow==</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mlflow_version</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># AzureML requires azureml-defaults to be installed to include</span>
        <span class="c1"># flask for the inference server.</span>
        <span class="n">environment</span><span class="o">.</span><span class="n">python</span><span class="o">.</span><span class="n">conda_dependencies</span><span class="o">.</span><span class="n">add_pip_package</span><span class="p">(</span>
            <span class="s2">&quot;azureml-defaults==</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">AZUREML_VERSION</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">inference_config</span> <span class="o">=</span> <span class="n">InferenceConfig</span><span class="p">(</span>
            <span class="n">entry_script</span><span class="o">=</span><span class="n">execution_script_path</span><span class="p">,</span> <span class="n">environment</span><span class="o">=</span><span class="n">environment</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">deployment_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">deployment_config</span><span class="o">.</span><span class="n">tags</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># We want more narrowly-scoped tags to win on merge</span>
                <span class="n">tags</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">deployment_config</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span>
            <span class="n">deployment_config</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="n">tags</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">deployment_config</span> <span class="o">=</span> <span class="n">AciWebservice</span><span class="o">.</span><span class="n">deploy_configuration</span><span class="p">(</span><span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>

        <span class="c1"># Finally, deploy the AzureML Model object to a webservice, and return back</span>
        <span class="n">webservice</span> <span class="o">=</span> <span class="n">AzureModel</span><span class="o">.</span><span class="n">deploy</span><span class="p">(</span>
            <span class="n">workspace</span><span class="o">=</span><span class="n">workspace</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">service_name</span><span class="p">,</span>
            <span class="n">models</span><span class="o">=</span><span class="p">[</span><span class="n">registered_model</span><span class="p">],</span>
            <span class="n">inference_config</span><span class="o">=</span><span class="n">inference_config</span><span class="p">,</span>
            <span class="n">deployment_config</span><span class="o">=</span><span class="n">deployment_config</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deploying an Azure Webservice with name: `</span><span class="si">%s</span><span class="s2">`&quot;</span><span class="p">,</span> <span class="n">webservice</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">synchronous</span><span class="p">:</span>
            <span class="n">webservice</span><span class="o">.</span><span class="n">wait_for_deployment</span><span class="p">(</span><span class="n">show_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">webservice</span><span class="p">,</span> <span class="n">registered_model</span></div>


<span class="k">def</span> <span class="nf">_build_tags</span><span class="p">(</span><span class="n">model_uri</span><span class="p">,</span> <span class="n">model_python_version</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">user_tags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">run_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param model_uri: URI to the MLflow model.</span>
<span class="sd">    :param model_python_version: The version of Python that was used to train the model, if</span>
<span class="sd">                                 the model was trained in Python.</span>
<span class="sd">    :param user_tags: A collection of user-specified tags to append to the set of default tags.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tags</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">user_tags</span><span class="p">)</span> <span class="k">if</span> <span class="n">user_tags</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}</span>
    <span class="n">tags</span><span class="p">[</span><span class="s2">&quot;model_uri&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_uri</span>
    <span class="k">if</span> <span class="n">model_python_version</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tags</span><span class="p">[</span><span class="s2">&quot;python_version&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_python_version</span>
    <span class="k">if</span> <span class="n">run_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tags</span><span class="p">[</span><span class="s2">&quot;mlflow_run_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">run_id</span>
    <span class="k">return</span> <span class="n">tags</span>


<span class="k">def</span> <span class="nf">_create_execution_script</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">azure_model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates an Azure-compatibele execution script (entry point) for a model server backed by</span>
<span class="sd">    the specified model. This script is created as a temporary file in the current working</span>
<span class="sd">    directory.</span>

<span class="sd">    :param output_path: The path where the execution script will be written.</span>
<span class="sd">    :param azure_model: The Azure Model that the execution script will load for inference.</span>
<span class="sd">    :return: A reference to the temporary file containing the execution script.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">execution_script_text</span> <span class="o">=</span> <span class="n">SCORE_SRC</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">model_name</span><span class="o">=</span><span class="n">azure_model</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">model_version</span><span class="o">=</span><span class="n">azure_model</span><span class="o">.</span><span class="n">version</span>
    <span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">execution_script_text</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_create_dockerfile</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">mlflow_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a Dockerfile containing additional Docker build steps to execute</span>
<span class="sd">    when building the Azure container image. These build steps perform the following tasks:</span>

<span class="sd">    - Install MLflow</span>

<span class="sd">    :param output_path: The path where the Dockerfile will be written.</span>
<span class="sd">    :param mlflow_path: Path to a local copy of the MLflow GitHub repository. If specified, the</span>
<span class="sd">                        Dockerfile command for MLflow installation will install MLflow from this</span>
<span class="sd">                        directory. Otherwise, it will install MLflow from pip.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">docker_cmds</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;RUN apt-get update &amp;&amp; apt-get install -y default-jre&quot;</span><span class="p">]</span>
    <span class="n">docker_cmds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;RUN pip install azureml-sdk&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mlflow_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mlflow_install_cmd</span> <span class="o">=</span> <span class="s2">&quot;RUN pip install -e </span><span class="si">{mlflow_path}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">mlflow_path</span><span class="o">=</span><span class="n">_get_container_path</span><span class="p">(</span><span class="n">mlflow_path</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">mlflow_version</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;dev&quot;</span><span class="p">):</span>
        <span class="n">mlflow_install_cmd</span> <span class="o">=</span> <span class="s2">&quot;RUN pip install mlflow==</span><span class="si">{mlflow_version}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">mlflow_version</span><span class="o">=</span><span class="n">mlflow_version</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
            <span class="s2">&quot;You are running a &#39;dev&#39; version of MLflow: `</span><span class="si">{mlflow_version}</span><span class="s2">` that cannot be&quot;</span>
            <span class="s2">&quot; installed from pip. In order to build a container image, either specify the&quot;</span>
            <span class="s2">&quot; path to a local copy of the MLflow GitHub repository using the `mlflow_home`&quot;</span>
            <span class="s2">&quot; parameter or install a release version of MLflow from pip&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">mlflow_version</span><span class="o">=</span><span class="n">mlflow_version</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="n">docker_cmds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mlflow_install_cmd</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">docker_cmds</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_get_container_path</span><span class="p">(</span><span class="n">local_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a local path to a resource, obtains the path at which this resource will exist</span>
<span class="sd">    when it is copied into the Azure ML container image.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">local_path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">):</span>
        <span class="n">local_path</span> <span class="o">=</span> <span class="n">local_path</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;/var/azureml-app&quot;</span><span class="p">,</span> <span class="n">local_path</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_load_pyfunc_conf_with_model</span><span class="p">(</span><span class="n">model_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loads the `python_function` flavor configuration for the specified model or throws an exception</span>
<span class="sd">    if the model does not contain the `python_function` flavor.</span>

<span class="sd">    :param model_path: The absolute path to the model.</span>
<span class="sd">    :return: The model&#39;s `python_function` flavor configuration and the model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="n">MLMODEL_FILE_NAME</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">pyfunc</span><span class="o">.</span><span class="n">FLAVOR_NAME</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">flavors</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="p">(</span>
                <span class="s2">&quot;The specified model does not contain the `python_function` flavor. This &quot;</span>
                <span class="s2">&quot;flavor is required for model deployment.&quot;</span>
            <span class="p">),</span>
            <span class="n">error_code</span><span class="o">=</span><span class="n">INVALID_PARAMETER_VALUE</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">flavors</span><span class="p">[</span><span class="n">pyfunc</span><span class="o">.</span><span class="n">FLAVOR_NAME</span><span class="p">],</span> <span class="n">model</span>


<span class="k">def</span> <span class="nf">_get_mlflow_azure_resource_name</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :return: A unique name for an Azure resource indicating that the resource was created by</span>
<span class="sd">             MLflow</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">azureml_max_resource_length</span> <span class="o">=</span> <span class="mi">32</span>
    <span class="n">resource_prefix</span> <span class="o">=</span> <span class="s2">&quot;mlflow-&quot;</span>
    <span class="n">unique_id</span> <span class="o">=</span> <span class="n">get_unique_resource_id</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="p">(</span><span class="n">azureml_max_resource_length</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">resource_prefix</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">resource_prefix</span> <span class="o">+</span> <span class="n">unique_id</span>


<span class="k">def</span> <span class="nf">_get_mlflow_azure_name</span><span class="p">(</span><span class="n">run_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :return: A unique name for an Azure resource indicating that the resource was created by</span>
<span class="sd">             MLflow</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">azureml_max_resource_length</span> <span class="o">=</span> <span class="mi">32</span>
    <span class="n">resource_prefix</span> <span class="o">=</span> <span class="s2">&quot;mlflow-model-&quot;</span>
    <span class="n">azureml_name</span> <span class="o">=</span> <span class="n">resource_prefix</span> <span class="o">+</span> <span class="n">run_id</span>
    <span class="k">return</span> <span class="n">azureml_name</span><span class="p">[:</span><span class="n">azureml_max_resource_length</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_create_mlflow_wheel</span><span class="p">(</span><span class="n">mlflow_dir</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create the wheel of MLFlow by using setup.py bdist_wheel in the outdir.</span>

<span class="sd">    :param mlflow_dir: The absolute path to base of the MLflow Repo to create a wheel from..</span>
<span class="sd">    :param out_dir: The absolute path to the outdir.</span>
<span class="sd">                    Will be created if it does not exist.</span>
<span class="sd">    :return: The absolute path to the wheel.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">unresolved</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">out_dir</span><span class="p">)</span>
    <span class="n">unresolved</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">out_path</span> <span class="o">=</span> <span class="n">unresolved</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
        <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s2">&quot;setup.py&quot;</span><span class="p">,</span> <span class="s2">&quot;bdist_wheel&quot;</span><span class="p">,</span> <span class="s2">&quot;-d&quot;</span><span class="p">,</span> <span class="n">out_path</span><span class="p">],</span> <span class="n">cwd</span><span class="o">=</span><span class="n">mlflow_dir</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">out_path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;./*.whl&quot;</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
            <span class="s2">&quot;Error creating MLFlow Wheel - couldn&#39;t&quot;</span>
            <span class="s2">&quot; find it in dir </span><span class="si">{}</span><span class="s2"> - found </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="n">files</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
            <span class="s2">&quot;Error creating MLFlow Wheel - couldn&#39;t&quot;</span>
            <span class="s2">&quot; find it in dir </span><span class="si">{}</span><span class="s2"> - found several wheels </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="n">files</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


<span class="n">SCORE_SRC</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">import pandas as pd</span>

<span class="s2">from azureml.core.model import Model</span>
<span class="s2">from mlflow.pyfunc import load_model</span>
<span class="s2">from mlflow.pyfunc.scoring_server import parse_json_input, _get_jsonable_obj</span>


<span class="s2">def init():</span>
<span class="s2">    global model</span>
<span class="s2">    model_path = Model.get_model_path(model_name=&quot;</span><span class="si">{model_name}</span><span class="s2">&quot;, version=</span><span class="si">{model_version}</span><span class="s2">)</span>
<span class="s2">    model = load_model(model_path)</span>


<span class="s2">def run(json_input):</span>
<span class="s2">    input_df = parse_json_input(json_input=json_input, orient=&quot;split&quot;)</span>
<span class="s2">    return _get_jsonable_obj(model.predict(input_df), pandas_orient=&quot;records&quot;)</span>

<span class="s2">&quot;&quot;&quot;</span>
</pre></div>

              </div>
            </div>
            <footer>
  

  <hr/>

  <div role="contentinfo">
      <p class="copyright">
          &copy; MLflow Project, a Series of LF Projects, LLC. All rights reserved.
      </p>

  </div> 

</footer>
          </div>
        </div>
      </section>
    </main>
  </page>

  


  
  <script type="text/javascript">
    var DOCUMENTATION_OPTIONS = {
      URL_ROOT:'../../',
      VERSION:'1.30.1',
      COLLAPSE_INDEX:false,
      FILE_SUFFIX:'.html',
      HAS_SOURCE:  true
    };
  </script>
  <script type="text/javascript" src="../../_static/jquery.js"></script>
  <script type="text/javascript" src="../../_static/underscore.js"></script>
  <script type="text/javascript" src="../../_static/doctools.js"></script>
  <script type="text/javascript" src="../../_static/languagesections.js"></script>
  

  <script type="text/javascript" src="../../_static/js/clipboard.min.js"></script>
  <script type="text/javascript" src="../../_static/js/jquery.waypoints.min.js"></script>

  
  
  
  <script type="text/javascript">var CLIPPY_SVG_PATH = "../../_static/clippy.svg";</script>
  <script type="text/javascript" src="../../_static/js/custom.js"></script>
  

  
  
  <script type="text/javascript">
    jQuery(function () {
      SphinxRtdTheme.StickyNav.enable();
    });

  </script>
   

  
</body>
</html>