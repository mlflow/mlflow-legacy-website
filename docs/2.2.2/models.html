
  

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>MLflow Models &mdash; MLflow 2.2.2 documentation</title>
  
   
  <link rel="canonical" href="https://mlflow.org/docs/latest/models.html">
  
  
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    

    

  
    
        <!-- Google Tag Manager -->
        <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer',"GTM-N6WMTTJ");</script>
        <!-- End Google Tag Manager -->
    

  

  
  
    

  

  
  
    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600" rel="stylesheet">
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="_static/css/custom.css" type="text/css" />
    
  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="MLflow 2.2.2 documentation" href="index.html"/>
        <link rel="next" title="MLflow Model Registry" href="/model-registry.html"/>
        <link rel="prev" title="MLflow Projects" href="/projects.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>
<script type="text/javascript" src="_static/jquery.js"></script>
<script type="text/javascript" src="_static/underscore.js"></script>
<script type="text/javascript" src="_static/doctools.js"></script>
<script type="text/javascript" src="_static/languagesections.js"></script>

<body class="wy-body-for-nav" role="document">

  
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-N6WMTTJ"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
  

  
  <nav class="wy-nav-top header" role="navigation" aria-label="top navigation">
    <ul>
  <li class="menu-toggle">
    <i data-toggle="wy-nav-top" class="wy-nav-top-menu-button db-icon db-icon-menu pull-left"></i>
    <a href="index.html" class="wy-nav-top-logo"
      ><img src="_static/MLflow-logo-final-black.png" alt="MLflow"
    /></a>
    <span class="version">2.2.2</span>
  </li>
</ul>
  </nav>
  <page>
    

    <nav data-toggle="wy-nav-shift" class="wy-nav-side relative">
      <div class="wy-side-scroll">
  <div class="wy-side-nav-search">
    

    

    
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
  </form>
</div>


    
  </div>

  <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
    
      <a href="index.html" class="main-navigation-home"><img src="_static/icons/nav-home.svg"> MLflow</a>
    

    
      

      
        <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorials-and-examples/index.html">Tutorials and Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="concepts.html">Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="tracking.html">MLflow Tracking</a></li>
<li class="toctree-l1"><a class="reference internal" href="projects.html">MLflow Projects</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">MLflow Models</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#storage-format">Storage Format</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#fields-in-the-mlmodel-format">Fields in the MLmodel Format</a></li>
<li class="toctree-l3"><a class="reference internal" href="#additional-logged-files">Additional Logged Files</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#model-signature-and-input-example">Model Signature And Input Example</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#model-signature">Model Signature</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#column-based-signature-example">Column-based Signature Example</a></li>
<li class="toctree-l4"><a class="reference internal" href="#tensor-based-signature-example">Tensor-based Signature Example</a></li>
<li class="toctree-l4"><a class="reference internal" href="#signature-enforcement">Signature Enforcement</a></li>
<li class="toctree-l4"><a class="reference internal" href="#how-to-log-models-with-signatures">How To Log Models With Signatures</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#model-input-example">Model Input Example</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#how-to-log-model-with-column-based-example">How To Log Model With Column-based Example</a></li>
<li class="toctree-l4"><a class="reference internal" href="#how-to-log-model-with-tensor-based-example">How To Log Model With Tensor-based Example</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#model-api">Model API</a></li>
<li class="toctree-l2"><a class="reference internal" href="#built-in-model-flavors">Built-In Model Flavors</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#python-function-python-function">Python Function (<code class="docutils literal notranslate"><span class="pre">python_function</span></code>)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#how-to-save-model-as-python-function">How To Save Model As Python Function</a></li>
<li class="toctree-l4"><a class="reference internal" href="#how-to-load-and-score-python-function-models">How To Load And Score Python Function Models</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#r-function-crate">R Function (<code class="docutils literal notranslate"><span class="pre">crate</span></code>)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#crate-usage"><code class="docutils literal notranslate"><span class="pre">crate</span></code> usage</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#h2o-h2o">H<sub>2</sub>O (<code class="docutils literal notranslate"><span class="pre">h2o</span></code>)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#keras-keras">Keras (<code class="docutils literal notranslate"><span class="pre">keras</span></code>)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#keras-pyfunc-usage">Keras pyfunc usage</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#mleap-mleap">MLeap (<code class="docutils literal notranslate"><span class="pre">mleap</span></code>)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pytorch-pytorch">PyTorch (<code class="docutils literal notranslate"><span class="pre">pytorch</span></code>)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#pytorch-pyfunc-usage">PyTorch pyfunc usage</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#scikit-learn-sklearn">Scikit-learn (<code class="docutils literal notranslate"><span class="pre">sklearn</span></code>)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#scikit-learn-pyfunc-usage">Scikit-learn pyfunc usage</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#spark-mllib-spark">Spark MLlib (<code class="docutils literal notranslate"><span class="pre">spark</span></code>)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#spark-mllib-pyfunc-usage">Spark MLlib pyfunc usage</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#tensorflow-tensorflow">TensorFlow (<code class="docutils literal notranslate"><span class="pre">tensorflow</span></code>)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#onnx-onnx">ONNX (<code class="docutils literal notranslate"><span class="pre">onnx</span></code>)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#onnx-pyfunc-usage-example">ONNX pyfunc usage example</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#mxnet-gluon-gluon">MXNet Gluon (<code class="docutils literal notranslate"><span class="pre">gluon</span></code>)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#xgboost-xgboost">XGBoost (<code class="docutils literal notranslate"><span class="pre">xgboost</span></code>)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#xgboost-pyfunc-usage"><code class="docutils literal notranslate"><span class="pre">XGBoost</span></code> pyfunc usage</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#lightgbm-lightgbm">LightGBM (<code class="docutils literal notranslate"><span class="pre">lightgbm</span></code>)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#lightgbm-pyfunc-usage"><code class="docutils literal notranslate"><span class="pre">LightGBM</span></code> pyfunc usage</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#catboost-catboost">CatBoost (<code class="docutils literal notranslate"><span class="pre">catboost</span></code>)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#catboost-pyfunc-usage"><code class="docutils literal notranslate"><span class="pre">CatBoost</span></code> pyfunc usage</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#spacy-spacy">Spacy(<code class="docutils literal notranslate"><span class="pre">spaCy</span></code>)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#spacy-pyfunc-usage"><code class="docutils literal notranslate"><span class="pre">Spacy</span></code> pyfunc usage</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#fastai-fastai">Fastai(<code class="docutils literal notranslate"><span class="pre">fastai</span></code>)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#statsmodels-statsmodels">Statsmodels (<code class="docutils literal notranslate"><span class="pre">statsmodels</span></code>)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#prophet-prophet">Prophet (<code class="docutils literal notranslate"><span class="pre">prophet</span></code>)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#prophet-pyfunc-usage">Prophet pyfunc usage</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#pmdarima-pmdarima">Pmdarima (<code class="docutils literal notranslate"><span class="pre">pmdarima</span></code>)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#diviner-diviner">Diviner (<code class="docutils literal notranslate"><span class="pre">diviner</span></code>)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#diviner-types">Diviner Types</a></li>
<li class="toctree-l4"><a class="reference internal" href="#metrics-and-parameters-logging-for-diviner">Metrics and Parameters logging for Diviner</a></li>
<li class="toctree-l4"><a class="reference internal" href="#diviner-pyfunc-usage">Diviner pyfunc usage</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#model-evaluation">Model Evaluation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#evaluating-with-custom-metrics">Evaluating with Custom Metrics</a></li>
<li class="toctree-l3"><a class="reference internal" href="#performing-model-validation">Performing Model Validation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#model-customization">Model Customization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#custom-python-models">Custom Python Models</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#example-creating-a-custom-add-n-model">Example: Creating a custom “add n” model</a></li>
<li class="toctree-l4"><a class="reference internal" href="#example-saving-an-xgboost-model-in-mlflow-format">Example: Saving an XGBoost model in MLflow format</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#custom-flavors">Custom Flavors</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#built-in-deployment-tools">Built-In Deployment Tools</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#deploy-mlflow-models">Deploy MLflow models</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#serving-with-mlserver">Serving with MLServer</a></li>
<li class="toctree-l4"><a class="reference internal" href="#encoding-complex-data">Encoding complex data</a></li>
<li class="toctree-l4"><a class="reference internal" href="#command-line-interface">Command Line Interface</a></li>
<li class="toctree-l4"><a class="reference internal" href="#environment-management-tools">Environment Management Tools</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#deploy-a-python-function-model-on-microsoft-azure-ml">Deploy a <code class="docutils literal notranslate"><span class="pre">python_function</span></code> model on Microsoft Azure ML</a></li>
<li class="toctree-l3"><a class="reference internal" href="#deploy-a-python-function-model-on-amazon-sagemaker">Deploy a <code class="docutils literal notranslate"><span class="pre">python_function</span></code> model on Amazon SageMaker</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#commands">Commands</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#export-a-python-function-model-as-an-apache-spark-udf">Export a <code class="docutils literal notranslate"><span class="pre">python_function</span></code> model as an Apache Spark UDF</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#deployment-to-custom-targets">Deployment to Custom Targets</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id18">Commands</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#community-model-flavors">Community Model Flavors</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#mlflow-vizmod">MLflow VizMod</a></li>
<li class="toctree-l3"><a class="reference internal" href="#bigml-bigmlflow">BigML (<code class="docutils literal notranslate"><span class="pre">bigmlflow</span></code>)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#installing-bigmlflow">Installing bigmlflow</a></li>
<li class="toctree-l4"><a class="reference internal" href="#bigmlflow-usage">BigMLFlow usage</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#sktime">Sktime</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#installing-sktime">Installing Sktime</a></li>
<li class="toctree-l4"><a class="reference internal" href="#usage-example">Usage example</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="model-registry.html">MLflow Model Registry</a></li>
<li class="toctree-l1"><a class="reference internal" href="recipes.html">MLflow Recipes (experimental)</a></li>
<li class="toctree-l1"><a class="reference internal" href="plugins.html">MLflow Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="cli.html">Command-Line Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="search-runs.html">Search Runs</a></li>
<li class="toctree-l1"><a class="reference internal" href="search-experiments.html">Search Experiments</a></li>
<li class="toctree-l1"><a class="reference internal" href="python_api/index.html">Python API</a></li>
<li class="toctree-l1"><a class="reference internal" href="R-api.html">R API</a></li>
<li class="toctree-l1"><a class="reference internal" href="java_api/index.html">Java API</a></li>
<li class="toctree-l1"><a class="reference internal" href="rest-api.html">REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="docker.html">Official MLflow Docker Image</a></li>
</ul>

      
    
  </div>

  <div role="contentinfo">
    

    <p>
      <a id='feedbacklink' href="https://github.com/mlflow/mlflow/blob/master/CONTRIBUTING.md" target="_blank">Contribute</a>
    </p>
  </div>
</div>
    </nav>

    <main class="wy-grid-for-nav">
      <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
        <div class="wy-nav-content">
          <div class="rst-content">
            










<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Documentation</a> <span class="db-icon db-icon-chevron-right"></span></li>
    
    
      <li>MLflow Models</li>
    
    
    <!-- <li class="wy-breadcrumbs-aside">
      <a href="https://github.com/mlflow/mlflow/blob/master/docs/source/models.rst" class="fa fa-github"> Edit on GitHub</a>
    </li> -->
    
  </ul>
</div>
            <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
              <div itemprop="articleBody">
                
  <div class="section" id="mlflow-models">
<span id="models"></span><h1>MLflow Models<a class="headerlink" href="#mlflow-models" title="Permalink to this headline"> </a></h1>
<p>An MLflow Model is a standard format for packaging machine learning models that can be used in a
variety of downstream tools—for example, real-time serving through a REST API or batch inference
on Apache Spark. The format defines a convention that lets you save a model in different “flavors”
that can be understood by different downstream tools.</p>
<div class="contents local topic" id="table-of-contents">
<p class="topic-title">Table of Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#storage-format" id="id23">Storage Format</a></p></li>
<li><p><a class="reference internal" href="#model-signature-and-input-example" id="id24">Model Signature And Input Example</a></p></li>
<li><p><a class="reference internal" href="#model-api" id="id25">Model API</a></p></li>
<li><p><a class="reference internal" href="#built-in-model-flavors" id="id26">Built-In Model Flavors</a></p></li>
<li><p><a class="reference internal" href="#model-evaluation" id="id27">Model Evaluation</a></p></li>
<li><p><a class="reference internal" href="#model-customization" id="id28">Model Customization</a></p></li>
<li><p><a class="reference internal" href="#built-in-deployment-tools" id="id29">Built-In Deployment Tools</a></p></li>
<li><p><a class="reference internal" href="#deployment-to-custom-targets" id="id30">Deployment to Custom Targets</a></p></li>
<li><p><a class="reference internal" href="#community-model-flavors" id="id31">Community Model Flavors</a></p></li>
</ul>
</div>
<div class="section" id="storage-format">
<span id="model-storage-format"></span><h2><a class="toc-backref" href="#id23">Storage Format</a><a class="headerlink" href="#storage-format" title="Permalink to this headline"> </a></h2>
<p>Each MLflow Model is a directory containing arbitrary files, together with an <code class="docutils literal notranslate"><span class="pre">MLmodel</span></code>
file in the root of the directory that can define multiple <em>flavors</em> that the model can be viewed
in.</p>
<p>Flavors are the key concept that makes MLflow Models powerful: they are a convention that deployment
tools can use to understand the model, which makes it possible to write tools that work with models
from any ML library without having to integrate each tool with each library. MLflow defines
several “standard” flavors that all of its built-in deployment tools support, such as a “Python
function” flavor that describes how to run the model as a Python function. However, libraries can
also define and use other flavors. For example, MLflow’s <a class="reference internal" href="python_api/mlflow.sklearn.html#module-mlflow.sklearn" title="mlflow.sklearn"><code class="xref py py-mod docutils literal notranslate"><span class="pre">mlflow.sklearn</span></code></a> library allows
loading models back as a scikit-learn <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code> object for use in code that is aware of
scikit-learn, or as a generic Python function for use in tools that just need to apply the model
(for example, the <code class="docutils literal notranslate"><span class="pre">mlflow</span> <span class="pre">deployments</span></code> tool with the option <code class="docutils literal notranslate"><span class="pre">-t</span> <span class="pre">sagemaker</span></code> for deploying models
to Amazon SageMaker).</p>
<p>All of the flavors that a particular model supports are defined in its <code class="docutils literal notranslate"><span class="pre">MLmodel</span></code> file in YAML
format. For example, <a class="reference internal" href="python_api/mlflow.sklearn.html#module-mlflow.sklearn" title="mlflow.sklearn"><code class="xref py py-mod docutils literal notranslate"><span class="pre">mlflow.sklearn</span></code></a> outputs models as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># Directory written by mlflow.sklearn.save_model(model, &quot;my_model&quot;)
my_model/
├── MLmodel
├── model.pkl
├── conda.yaml
├── python_env.yaml
└── requirements.txt
</pre></div>
</div>
<p>And its <code class="docutils literal notranslate"><span class="pre">MLmodel</span></code> file describes two flavors:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">time_created</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2018-05-25T17:28:53.35</span>

<span class="nt">flavors</span><span class="p">:</span>
<span class="w">  </span><span class="nt">sklearn</span><span class="p">:</span>
<span class="w">    </span><span class="nt">sklearn_version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.19.1</span>
<span class="w">    </span><span class="nt">pickled_model</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">model.pkl</span>
<span class="w">  </span><span class="nt">python_function</span><span class="p">:</span>
<span class="w">    </span><span class="nt">loader_module</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mlflow.sklearn</span>
</pre></div>
</div>
<p>This model can then be used with any tool that supports either the <code class="docutils literal notranslate"><span class="pre">sklearn</span></code> or
<code class="docutils literal notranslate"><span class="pre">python_function</span></code> model flavor. For example, the <code class="docutils literal notranslate"><span class="pre">mlflow</span> <span class="pre">models</span> <span class="pre">serve</span></code> command
can serve a model with the <code class="docutils literal notranslate"><span class="pre">python_function</span></code> or the <code class="docutils literal notranslate"><span class="pre">crate</span></code> (R Function) flavor:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mlflow<span class="w"> </span>models<span class="w"> </span>serve<span class="w"> </span>-m<span class="w"> </span>my_model
</pre></div>
</div>
<p>In addition, the <code class="docutils literal notranslate"><span class="pre">mlflow</span> <span class="pre">deployments</span></code> command-line tool can package and deploy models to AWS
SageMaker as long as they support the <code class="docutils literal notranslate"><span class="pre">python_function</span></code> flavor:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mlflow<span class="w"> </span>deployments<span class="w"> </span>create<span class="w"> </span>-t<span class="w"> </span>sagemaker<span class="w"> </span>-m<span class="w"> </span>my_model<span class="w"> </span><span class="o">[</span>other<span class="w"> </span>options<span class="o">]</span>
</pre></div>
</div>
<div class="section" id="fields-in-the-mlmodel-format">
<h3>Fields in the MLmodel Format<a class="headerlink" href="#fields-in-the-mlmodel-format" title="Permalink to this headline"> </a></h3>
<p>Apart from a <strong>flavors</strong> field listing the model flavors, the MLmodel YAML format can contain
the following fields:</p>
<dl class="simple">
<dt>time_created</dt><dd><p>Date and time when the model was created, in UTC ISO 8601 format.</p>
</dd>
<dt>run_id</dt><dd><p>ID of the run that created the model, if the model was saved using <a class="reference internal" href="tracking.html#tracking"><span class="std std-ref">MLflow Tracking</span></a>.</p>
</dd>
<dt>signature</dt><dd><p><a class="reference internal" href="#model-signature"><span class="std std-ref">model signature</span></a> in JSON format.</p>
</dd>
<dt>input_example</dt><dd><p>reference to an artifact with <a class="reference internal" href="#input-example"><span class="std std-ref">input example</span></a>.</p>
</dd>
<dt>databricks_runtime</dt><dd><p>Databricks runtime version and type, if the model was trained in a Databricks notebook or job.</p>
</dd>
<dt>mlflow_version</dt><dd><p>The version of MLflow that was used to log the model.</p>
</dd>
</dl>
</div>
<div class="section" id="additional-logged-files">
<h3>Additional Logged Files<a class="headerlink" href="#additional-logged-files" title="Permalink to this headline"> </a></h3>
<p>For environment recreation, we automatically log <code class="docutils literal notranslate"><span class="pre">conda.yaml</span></code>, <code class="docutils literal notranslate"><span class="pre">python_env.yaml</span></code>, and <code class="docutils literal notranslate"><span class="pre">requirements.txt</span></code> files whenever a model is logged. These files can then be used to reinstall dependencies using <code class="docutils literal notranslate"><span class="pre">conda</span></code> or <code class="docutils literal notranslate"><span class="pre">virtualenv</span></code> with <code class="docutils literal notranslate"><span class="pre">pip</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Anaconda Inc. updated their <a class="reference external" href="https://www.anaconda.com/terms-of-service">terms of service</a> for anaconda.org channels. Based on the new terms of service you may require a commercial license if you rely on Anaconda’s packaging and distribution. See <a class="reference external" href="https://www.anaconda.com/blog/anaconda-commercial-edition-faq">Anaconda Commercial Edition FAQ</a> for more information. Your use of any Anaconda channels is governed by their terms of service.</p>
<p>MLflow models logged before <a class="reference external" href="https://mlflow.org/news/2021/06/18/1.18.0-release/index.html">v1.18</a> were by default logged with the conda <code class="docutils literal notranslate"><span class="pre">defaults</span></code> channel (<a class="reference external" href="https://repo.anaconda.com/pkgs/">https://repo.anaconda.com/pkgs/</a>) as a dependency. Because of this license change, MLflow has stopped the use of the <code class="docutils literal notranslate"><span class="pre">defaults</span></code> channel for models logged using MLflow v1.18 and above. The default channel logged is now <code class="docutils literal notranslate"><span class="pre">conda-forge</span></code>, which points at the community managed <a class="reference external" href="https://conda-forge.org/">https://conda-forge.org/</a>.</p>
<p>If you logged a model before MLflow v1.18 without excluding the <code class="docutils literal notranslate"><span class="pre">defaults</span></code> channel from the conda environment for the model, that model may have a dependency on the <code class="docutils literal notranslate"><span class="pre">defaults</span></code> channel that you may not have intended.
To manually confirm whether a model has this dependency, you can examine <code class="docutils literal notranslate"><span class="pre">channel</span></code> value in the <code class="docutils literal notranslate"><span class="pre">conda.yaml</span></code> file that is packaged with the logged model. For example, a model’s <code class="docutils literal notranslate"><span class="pre">conda.yaml</span></code> with a <code class="docutils literal notranslate"><span class="pre">defaults</span></code> channel dependency may look like this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mlflow-env</span>
<span class="nt">channels</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">defaults</span>
<span class="nt">dependencies</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python=3.8.8</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pip</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">pip</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mlflow</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">scikit-learn==0.23.2</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cloudpickle==1.6.0</span>
</pre></div>
</div>
<p>If you would like to change the channel used in a model’s environment, you can re-register the model to the model registry with a new <code class="docutils literal notranslate"><span class="pre">conda.yaml</span></code>. You can do this by specifying the channel in the <code class="docutils literal notranslate"><span class="pre">conda_env</span></code> parameter of <code class="docutils literal notranslate"><span class="pre">log_model()</span></code>.</p>
<p>For more information on the <code class="docutils literal notranslate"><span class="pre">log_model()</span></code> API, see the MLflow documentation for the model flavor you are working with, for example, <a class="reference internal" href="python_api/mlflow.sklearn.html#mlflow.sklearn.log_model" title="mlflow.sklearn.log_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.sklearn.log_model()</span></code></a>.</p>
</div>
<dl class="simple">
<dt>conda.yaml</dt><dd><p>When saving a model, MLflow provides the option to pass in a conda environment parameter that can contain dependencies used by the model. If no conda environment is provided, a default environment is created based on the flavor of the model. This conda environment is then saved in <code class="docutils literal notranslate"><span class="pre">conda.yaml</span></code>.</p>
</dd>
<dt>python_env.yaml</dt><dd><p>This file contains the following information that’s required to restore a model environment using virtualenv:</p>
<ul class="simple">
<li><p>Python version</p></li>
<li><p>Version specifiers for <code class="docutils literal notranslate"><span class="pre">pip</span></code>, <code class="docutils literal notranslate"><span class="pre">setuptools</span></code>, and <code class="docutils literal notranslate"><span class="pre">wheel</span></code></p></li>
<li><p>Pip requirements of the model (reference to <code class="docutils literal notranslate"><span class="pre">requirements.txt</span></code>)</p></li>
</ul>
</dd>
<dt>requirements.txt</dt><dd><p>The requirements file is created from the <a class="reference external" href="https://www.anaconda.com/blog/using-pip-in-a-conda-environment">pip portion</a> of the <code class="docutils literal notranslate"><span class="pre">conda.yaml</span></code> environment specification. Additional pip dependencies can be added to <code class="docutils literal notranslate"><span class="pre">requirements.txt</span></code> by including them as a pip dependency in a conda environment and logging the model with the environment or using the <code class="docutils literal notranslate"><span class="pre">pip_requirements</span></code> argument of the <cite>mlflow.&lt;flavor&gt;.log_model</cite> API.</p>
</dd>
</dl>
<p>The following shows an example of saving a model with a manually specified conda environment and the corresponding content of the generated <code class="docutils literal notranslate"><span class="pre">conda.yaml</span></code> and <code class="docutils literal notranslate"><span class="pre">requirements.txt</span></code> files.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">conda_env</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;channels&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;conda-forge&quot;</span><span class="p">],</span>
    <span class="s2">&quot;dependencies&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;python=3.8.8&quot;</span><span class="p">,</span> <span class="s2">&quot;pip&quot;</span><span class="p">],</span>
    <span class="s2">&quot;pip&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;mlflow&quot;</span><span class="p">,</span> <span class="s2">&quot;scikit-learn==0.23.2&quot;</span><span class="p">,</span> <span class="s2">&quot;cloudpickle==1.6.0&quot;</span><span class="p">],</span>
    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;mlflow-env&quot;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">mlflow</span><span class="o">.</span><span class="n">sklearn</span><span class="o">.</span><span class="n">log_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;my_model&quot;</span><span class="p">,</span> <span class="n">conda_env</span><span class="o">=</span><span class="n">conda_env</span><span class="p">)</span>
</pre></div>
</div>
<p>The written <code class="docutils literal notranslate"><span class="pre">conda.yaml</span></code> file:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mlflow-env</span>
<span class="nt">channels</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">conda-forge</span>
<span class="nt">dependencies</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python=3.8.8</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pip</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">pip</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mlflow</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">scikit-learn==0.23.2</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cloudpickle==1.6.0</span>
</pre></div>
</div>
<p>The written <code class="docutils literal notranslate"><span class="pre">python_env.yaml</span></code> file:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">python</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3.8.8</span>
<span class="nt">build_dependencies</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pip==21.1.3</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">setuptools==57.4.0</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">wheel==0.37.0</span>
<span class="nt">dependencies</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">-r requirements.txt</span>
</pre></div>
</div>
<p>The written <code class="docutils literal notranslate"><span class="pre">requirements.txt</span></code> file:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>mlflow
scikit-learn==0.23.2
cloudpickle==1.6.0
</pre></div>
</div>
</div>
</div>
<div class="section" id="model-signature-and-input-example">
<span id="model-metadata"></span><h2><a class="toc-backref" href="#id24">Model Signature And Input Example</a><a class="headerlink" href="#model-signature-and-input-example" title="Permalink to this headline"> </a></h2>
<p>When working with ML models you often need to know some basic functional properties of the model
at hand, such as “What inputs does it expect?” and “What output does it produce?”. MLflow models can
include the following additional metadata about model inputs and outputs that can be used by
downstream tooling:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#model-signature"><span class="std std-ref">Model Signature</span></a> - description of a model’s inputs and outputs.</p></li>
<li><p><a class="reference internal" href="#input-example"><span class="std std-ref">Model Input Example</span></a> - example of a valid model input.</p></li>
</ul>
<div class="section" id="model-signature">
<span id="id1"></span><h3>Model Signature<a class="headerlink" href="#model-signature" title="Permalink to this headline"> </a></h3>
<p>The Model signature defines the schema of a model’s inputs and outputs. Model inputs and outputs can
be either column-based or tensor-based. Column-based inputs and outputs can be described as a
sequence of (optionally) named columns with type specified as one of the
<a class="reference internal" href="python_api/mlflow.types.html#mlflow.types.DataType" title="mlflow.types.DataType"><code class="xref py py-class docutils literal notranslate"><span class="pre">MLflow</span> <span class="pre">data</span> <span class="pre">types</span></code></a>. Tensor-based inputs and outputs can be
described as a sequence of (optionally) named tensors with type specified as one of the
<a class="reference external" href="https://numpy.org/devdocs/user/basics.types.html">numpy data types</a>.</p>
<p>To include a signature with your model, pass a <a class="reference internal" href="python_api/mlflow.models.html#mlflow.models.ModelSignature" title="mlflow.models.ModelSignature"><code class="xref py py-class docutils literal notranslate"><span class="pre">signature</span> <span class="pre">object</span></code></a> as an argument to the appropriate log_model call, e.g.
<a class="reference internal" href="python_api/mlflow.sklearn.html#mlflow.sklearn.log_model" title="mlflow.sklearn.log_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">sklearn.log_model()</span></code></a>. More details are in the <a class="reference internal" href="#how-to-log-models-with-signatures"><span class="std std-ref">How to log models with signatures</span></a> section. The signature is stored in
JSON format in the <a class="reference internal" href="python_api/mlflow.pyfunc.html#pyfunc-model-config"><span class="std std-ref">MLmodel file</span></a>, together with other model metadata.</p>
<p>Model signatures are recognized and enforced by standard <a class="reference internal" href="#built-in-deployment"><span class="std std-ref">MLflow model deployment tools</span></a>. For example, the <a class="reference internal" href="#local-model-deployment"><span class="std std-ref">mlflow models serve</span></a> tool,
which deploys a model as a REST API, validates inputs based on the model’s signature.</p>
<div class="section" id="column-based-signature-example">
<h4>Column-based Signature Example<a class="headerlink" href="#column-based-signature-example" title="Permalink to this headline"> </a></h4>
<p>All flavors support column-based signatures.</p>
<p>Each column-based input and output is represented by a type corresponding to one of
<a class="reference internal" href="python_api/mlflow.types.html#mlflow.types.DataType" title="mlflow.types.DataType"><code class="xref py py-class docutils literal notranslate"><span class="pre">MLflow</span> <span class="pre">data</span> <span class="pre">types</span></code></a> and an optional name. The following example
displays an MLmodel file excerpt containing the model signature for a classification model trained on
the <a class="reference external" href="https://archive.ics.uci.edu/ml/datasets/iris">Iris dataset</a>. The input has 4 named, numeric columns.
The output is an unnamed integer specifying the predicted class.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">signature</span><span class="p">:</span>
<span class="w">    </span><span class="nt">inputs</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;[{&quot;name&quot;:</span><span class="nv"> </span><span class="s">&quot;sepal</span><span class="nv"> </span><span class="s">length</span><span class="nv"> </span><span class="s">(cm)&quot;,</span><span class="nv"> </span><span class="s">&quot;type&quot;:</span><span class="nv"> </span><span class="s">&quot;double&quot;},</span><span class="nv"> </span><span class="s">{&quot;name&quot;:</span><span class="nv"> </span><span class="s">&quot;sepal</span><span class="nv"> </span><span class="s">width</span>
<span class="w">      </span><span class="s">(cm)&quot;,</span><span class="nv"> </span><span class="s">&quot;type&quot;:</span><span class="nv"> </span><span class="s">&quot;double&quot;},</span><span class="nv"> </span><span class="s">{&quot;name&quot;:</span><span class="nv"> </span><span class="s">&quot;petal</span><span class="nv"> </span><span class="s">length</span><span class="nv"> </span><span class="s">(cm)&quot;,</span><span class="nv"> </span><span class="s">&quot;type&quot;:</span><span class="nv"> </span><span class="s">&quot;double&quot;},</span><span class="nv"> </span><span class="s">{&quot;name&quot;:</span>
<span class="w">      </span><span class="s">&quot;petal</span><span class="nv"> </span><span class="s">width</span><span class="nv"> </span><span class="s">(cm)&quot;,</span><span class="nv"> </span><span class="s">&quot;type&quot;:</span><span class="nv"> </span><span class="s">&quot;double&quot;}]&#39;</span>
<span class="w">    </span><span class="nt">outputs</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;[{&quot;type&quot;:</span><span class="nv"> </span><span class="s">&quot;integer&quot;}]&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="tensor-based-signature-example">
<h4>Tensor-based Signature Example<a class="headerlink" href="#tensor-based-signature-example" title="Permalink to this headline"> </a></h4>
<p>Only DL flavors support tensor-based signatures (i.e TensorFlow, Keras, PyTorch, Onnx, and Gluon).</p>
<p>Each tensor-based input and output is represented by a dtype corresponding to one of
<a class="reference external" href="https://numpy.org/devdocs/user/basics.types.html">numpy data types</a>, shape and an optional name.
When specifying the shape, -1 is used for axes that may be variable in size.
The following example displays an MLmodel file excerpt containing the model signature for a
classification model trained on the <a class="reference external" href="http://yann.lecun.com/exdb/mnist/">MNIST dataset</a>.
The input has one named tensor where input sample is an image represented by a 28 × 28 × 1 array
of float32 numbers. The output is an unnamed tensor that has 10 units specifying the
likelihood corresponding to each of the 10 classes. Note that the first dimension of the input
and the output is the batch size and is thus set to -1 to allow for variable batch sizes.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">signature</span><span class="p">:</span>
<span class="w">    </span><span class="nt">inputs</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;[{&quot;name&quot;:</span><span class="nv"> </span><span class="s">&quot;images&quot;,</span><span class="nv"> </span><span class="s">&quot;dtype&quot;:</span><span class="nv"> </span><span class="s">&quot;uint8&quot;,</span><span class="nv"> </span><span class="s">&quot;shape&quot;:</span><span class="nv"> </span><span class="s">[-1,</span><span class="nv"> </span><span class="s">28,</span><span class="nv"> </span><span class="s">28,</span><span class="nv"> </span><span class="s">1]}]&#39;</span>
<span class="w">    </span><span class="nt">outputs</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;[{&quot;shape&quot;:</span><span class="nv"> </span><span class="s">[-1,</span><span class="nv"> </span><span class="s">10],</span><span class="nv"> </span><span class="s">&quot;dtype&quot;:</span><span class="nv"> </span><span class="s">&quot;float32&quot;}]&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="signature-enforcement">
<h4>Signature Enforcement<a class="headerlink" href="#signature-enforcement" title="Permalink to this headline"> </a></h4>
<p>Schema enforcement checks the provided input against the model’s signature
and raises an exception if the input is not compatible. This enforcement is applied in MLflow before
calling the underlying model implementation. Note that this enforcement only applies when using <a class="reference internal" href="#built-in-deployment"><span class="std std-ref">MLflow
model deployment tools</span></a> or when loading models as <code class="docutils literal notranslate"><span class="pre">python_function</span></code>. In
particular, it is not applied to models that are loaded in their native format (e.g. by calling
<a class="reference internal" href="python_api/mlflow.sklearn.html#mlflow.sklearn.load_model" title="mlflow.sklearn.load_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.sklearn.load_model()</span></code></a>).</p>
<div class="section" id="name-ordering-enforcement">
<h5>Name Ordering Enforcement<a class="headerlink" href="#name-ordering-enforcement" title="Permalink to this headline"> </a></h5>
<p>The input names are checked against the model signature. If there are any missing inputs,
MLflow will raise an exception. Extra inputs that were not declared in the signature will be
ignored. If the input schema in the signature defines input names, input matching is done by name
and the inputs are reordered to match the signature. If the input schema does not have input
names, matching is done by position (i.e. MLflow will only check the number of inputs).</p>
</div>
<div class="section" id="input-type-enforcement">
<h5>Input Type Enforcement<a class="headerlink" href="#input-type-enforcement" title="Permalink to this headline"> </a></h5>
<p>The input types are checked against the signature.</p>
<p>For models with column-based signatures (i.e DataFrame inputs), MLflow will perform safe type conversions
if necessary. Generally, only conversions that are guaranteed to be lossless are allowed. For
example, int -&gt; long or int -&gt; double conversions are ok, long -&gt; double is not. If the types cannot
be made compatible, MLflow will raise an error.</p>
<p>For models with tensor-based signatures, type checking is strict (i.e an exception will be thrown if
the input type does not match the type specified by the schema).</p>
</div>
<div class="section" id="handling-integers-with-missing-values">
<h5>Handling Integers With Missing Values<a class="headerlink" href="#handling-integers-with-missing-values" title="Permalink to this headline"> </a></h5>
<p>Integer data with missing values is typically represented as floats in Python. Therefore, data
types of integer columns in Python can vary depending on the data sample. This type variance can
cause schema enforcement errors at runtime since integer and float are not compatible types. For
example, if your training data did not have any missing values for integer column c, its type will
be integer. However, when you attempt to score a sample of the data that does include a missing
value in column c, its type will be float. If your model signature specified c to have integer type,
MLflow will raise an error since it can not convert float to int. Note that MLflow uses python to
serve models and to deploy models to Spark, so this can affect most model deployments. The best way
to avoid this problem is to declare integer columns as doubles (float64) whenever there can be
missing values.</p>
</div>
<div class="section" id="handling-date-and-timestamp">
<h5>Handling Date and Timestamp<a class="headerlink" href="#handling-date-and-timestamp" title="Permalink to this headline"> </a></h5>
<p>For datetime values, Python has precision built into the type. For example, datetime values with
day precision have numpy type <code class="docutils literal notranslate"><span class="pre">datetime64[D]</span></code>, while values with nanosecond precision have
type <code class="docutils literal notranslate"><span class="pre">datetime64[ns]</span></code>. Datetime precision is ignored for column-based model signature but is
enforced for tensor-based signatures.</p>
</div>
<div class="section" id="handling-ragged-arrays">
<h5>Handling Ragged Arrays<a class="headerlink" href="#handling-ragged-arrays" title="Permalink to this headline"> </a></h5>
<p>Ragged arrays can be created in numpy and are produced with a shape of (-1,) and a dytpe of
object. This will be handled by default when using <code class="docutils literal notranslate"><span class="pre">infer_signature</span></code>, resulting in a
signature containing <code class="docutils literal notranslate"><span class="pre">Tensor('object',</span> <span class="pre">(-1,))</span></code>. A similar signature can be manually created
containing a more detailed representation of a ragged array, for a more expressive signature,
such as <code class="docutils literal notranslate"><span class="pre">Tensor('float64',</span> <span class="pre">(-1,</span> <span class="pre">-1,</span> <span class="pre">-1,</span> <span class="pre">3))</span></code>. Enforcement will then be done on as much detail
as possible given the signature provided, and will support ragged input arrays as well.</p>
</div>
</div>
<div class="section" id="how-to-log-models-with-signatures">
<span id="id3"></span><h4>How To Log Models With Signatures<a class="headerlink" href="#how-to-log-models-with-signatures" title="Permalink to this headline"> </a></h4>
<p>To include a signature with your model, pass <a class="reference internal" href="python_api/mlflow.models.html#mlflow.models.ModelSignature" title="mlflow.models.ModelSignature"><code class="xref py py-class docutils literal notranslate"><span class="pre">signature</span> <span class="pre">object</span></code></a> as an argument to the appropriate log_model call, e.g.
<a class="reference internal" href="python_api/mlflow.sklearn.html#mlflow.sklearn.log_model" title="mlflow.sklearn.log_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">sklearn.log_model()</span></code></a>. The model signature object can be created
by hand or <a class="reference internal" href="python_api/mlflow.models.html#mlflow.models.infer_signature" title="mlflow.models.infer_signature"><code class="xref py py-func docutils literal notranslate"><span class="pre">inferred</span></code></a> from datasets with valid model inputs
(e.g. the training dataset with target column omitted) and valid model outputs (e.g. model
predictions generated on the training dataset).</p>
<div class="section" id="id4">
<h5>Column-based Signature Example<a class="headerlink" href="#id4" title="Permalink to this headline"> </a></h5>
<p>The following example demonstrates how to store a model signature for a simple classifier trained
on the <code class="docutils literal notranslate"><span class="pre">Iris</span> <span class="pre">dataset</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">datasets</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">import</span> <span class="nn">mlflow</span>
<span class="kn">import</span> <span class="nn">mlflow.sklearn</span>
<span class="kn">from</span> <span class="nn">mlflow.models.signature</span> <span class="kn">import</span> <span class="n">infer_signature</span>

<span class="n">iris</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">load_iris</span><span class="p">()</span>
<span class="n">iris_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">iris</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">iris</span><span class="o">.</span><span class="n">feature_names</span><span class="p">)</span>
<span class="n">clf</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">iris_train</span><span class="p">,</span> <span class="n">iris</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
<span class="n">signature</span> <span class="o">=</span> <span class="n">infer_signature</span><span class="p">(</span><span class="n">iris_train</span><span class="p">,</span> <span class="n">clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">iris_train</span><span class="p">))</span>
<span class="n">mlflow</span><span class="o">.</span><span class="n">sklearn</span><span class="o">.</span><span class="n">log_model</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="s2">&quot;iris_rf&quot;</span><span class="p">,</span> <span class="n">signature</span><span class="o">=</span><span class="n">signature</span><span class="p">)</span>
</pre></div>
</div>
<p>The same signature can be created explicitly as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mlflow.models.signature</span> <span class="kn">import</span> <span class="n">ModelSignature</span>
<span class="kn">from</span> <span class="nn">mlflow.types.schema</span> <span class="kn">import</span> <span class="n">Schema</span><span class="p">,</span> <span class="n">ColSpec</span>

<span class="n">input_schema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">ColSpec</span><span class="p">(</span><span class="s2">&quot;double&quot;</span><span class="p">,</span> <span class="s2">&quot;sepal length (cm)&quot;</span><span class="p">),</span>
        <span class="n">ColSpec</span><span class="p">(</span><span class="s2">&quot;double&quot;</span><span class="p">,</span> <span class="s2">&quot;sepal width (cm)&quot;</span><span class="p">),</span>
        <span class="n">ColSpec</span><span class="p">(</span><span class="s2">&quot;double&quot;</span><span class="p">,</span> <span class="s2">&quot;petal length (cm)&quot;</span><span class="p">),</span>
        <span class="n">ColSpec</span><span class="p">(</span><span class="s2">&quot;double&quot;</span><span class="p">,</span> <span class="s2">&quot;petal width (cm)&quot;</span><span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="n">output_schema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">([</span><span class="n">ColSpec</span><span class="p">(</span><span class="s2">&quot;long&quot;</span><span class="p">)])</span>
<span class="n">signature</span> <span class="o">=</span> <span class="n">ModelSignature</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">input_schema</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">output_schema</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h5>Tensor-based Signature Example<a class="headerlink" href="#id5" title="Permalink to this headline"> </a></h5>
<p>The following example demonstrates how to store a model signature for a simple classifier trained
on the <code class="docutils literal notranslate"><span class="pre">MNIST</span> <span class="pre">dataset</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">keras.datasets</span> <span class="kn">import</span> <span class="n">mnist</span>
<span class="kn">from</span> <span class="nn">keras.utils</span> <span class="kn">import</span> <span class="n">to_categorical</span>
<span class="kn">from</span> <span class="nn">keras.models</span> <span class="kn">import</span> <span class="n">Sequential</span>
<span class="kn">from</span> <span class="nn">keras.layers</span> <span class="kn">import</span> <span class="n">Conv2D</span><span class="p">,</span> <span class="n">MaxPooling2D</span><span class="p">,</span> <span class="n">Dense</span><span class="p">,</span> <span class="n">Flatten</span>
<span class="kn">from</span> <span class="nn">keras.optimizers</span> <span class="kn">import</span> <span class="n">SGD</span>
<span class="kn">import</span> <span class="nn">mlflow</span>
<span class="kn">from</span> <span class="nn">mlflow.models.signature</span> <span class="kn">import</span> <span class="n">infer_signature</span>

<span class="p">(</span><span class="n">train_X</span><span class="p">,</span> <span class="n">train_Y</span><span class="p">),</span> <span class="p">(</span><span class="n">test_X</span><span class="p">,</span> <span class="n">test_Y</span><span class="p">)</span> <span class="o">=</span> <span class="n">mnist</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
<span class="n">trainX</span> <span class="o">=</span> <span class="n">train_X</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">train_X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">testX</span> <span class="o">=</span> <span class="n">test_X</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">test_X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">trainY</span> <span class="o">=</span> <span class="n">to_categorical</span><span class="p">(</span><span class="n">train_Y</span><span class="p">)</span>
<span class="n">testY</span> <span class="o">=</span> <span class="n">to_categorical</span><span class="p">(</span><span class="n">test_Y</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
    <span class="n">Conv2D</span><span class="p">(</span>
        <span class="mi">32</span><span class="p">,</span>
        <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
        <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">,</span>
        <span class="n">kernel_initializer</span><span class="o">=</span><span class="s2">&quot;he_uniform&quot;</span><span class="p">,</span>
        <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">MaxPooling2D</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Flatten</span><span class="p">())</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">,</span> <span class="n">kernel_initializer</span><span class="o">=</span><span class="s2">&quot;he_uniform&quot;</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;softmax&quot;</span><span class="p">))</span>
<span class="n">opt</span> <span class="o">=</span> <span class="n">SGD</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">opt</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="s2">&quot;categorical_crossentropy&quot;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">])</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">trainX</span><span class="p">,</span> <span class="n">trainY</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">testX</span><span class="p">,</span> <span class="n">testY</span><span class="p">))</span>

<span class="n">signature</span> <span class="o">=</span> <span class="n">infer_signature</span><span class="p">(</span><span class="n">testX</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">testX</span><span class="p">))</span>
<span class="n">mlflow</span><span class="o">.</span><span class="n">tensorflow</span><span class="o">.</span><span class="n">log_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;mnist_cnn&quot;</span><span class="p">,</span> <span class="n">signature</span><span class="o">=</span><span class="n">signature</span><span class="p">)</span>
</pre></div>
</div>
<p>The same signature can be created explicitly as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">mlflow.models.signature</span> <span class="kn">import</span> <span class="n">ModelSignature</span>
<span class="kn">from</span> <span class="nn">mlflow.types.schema</span> <span class="kn">import</span> <span class="n">Schema</span><span class="p">,</span> <span class="n">TensorSpec</span>

<span class="n">input_schema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">TensorSpec</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="n">output_schema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">([</span><span class="n">TensorSpec</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">))])</span>
<span class="n">signature</span> <span class="o">=</span> <span class="n">ModelSignature</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">input_schema</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">output_schema</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="model-input-example">
<span id="input-example"></span><h3>Model Input Example<a class="headerlink" href="#model-input-example" title="Permalink to this headline"> </a></h3>
<p>Similar to model signatures, model inputs can be column-based (i.e DataFrames) or tensor-based
(i.e numpy.ndarrays). A model input example provides an instance of a valid model input.
Input examples are stored with the model as separate artifacts and are referenced in the the
<a class="reference internal" href="python_api/mlflow.pyfunc.html#pyfunc-model-config"><span class="std std-ref">MLmodel file</span></a>.</p>
<p>To include an input example with your model, add it to the appropriate log_model call, e.g.
<a class="reference internal" href="python_api/mlflow.sklearn.html#mlflow.sklearn.log_model" title="mlflow.sklearn.log_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">sklearn.log_model()</span></code></a>.</p>
<div class="section" id="how-to-log-model-with-column-based-example">
<h4>How To Log Model With Column-based Example<a class="headerlink" href="#how-to-log-model-with-column-based-example" title="Permalink to this headline"> </a></h4>
<p>For models accepting column-based inputs, an example can be a single record or a batch of records. The
sample input can be passed in as a Pandas DataFrame, list or dictionary. The given
example will be converted to a Pandas DataFrame and then serialized to json using the Pandas split-oriented
format. Bytes are base64-encoded. The following example demonstrates how you can log a column-based
input example with your model:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">input_example</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;sepal length (cm)&quot;</span><span class="p">:</span> <span class="mf">5.1</span><span class="p">,</span>
    <span class="s2">&quot;sepal width (cm)&quot;</span><span class="p">:</span> <span class="mf">3.5</span><span class="p">,</span>
    <span class="s2">&quot;petal length (cm)&quot;</span><span class="p">:</span> <span class="mf">1.4</span><span class="p">,</span>
    <span class="s2">&quot;petal width (cm)&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">mlflow</span><span class="o">.</span><span class="n">sklearn</span><span class="o">.</span><span class="n">log_model</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">input_example</span><span class="o">=</span><span class="n">input_example</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="how-to-log-model-with-tensor-based-example">
<h4>How To Log Model With Tensor-based Example<a class="headerlink" href="#how-to-log-model-with-tensor-based-example" title="Permalink to this headline"> </a></h4>
<p>For models accepting tensor-based inputs, an example must be a batch of inputs. By default, the axis 0
is the batch axis unless specified otherwise in the model signature. The sample input can be passed in as
a numpy ndarray or a dictionary mapping a string to a numpy array. The following example demonstrates how
you can log a tensor-based input example with your model:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># each input has shape (4, 4)</span>
<span class="n">input_example</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">134</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">56</span><span class="p">],</span> <span class="p">[</span><span class="mi">253</span><span class="p">,</span> <span class="mi">242</span><span class="p">,</span> <span class="mi">195</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">93</span><span class="p">,</span> <span class="mi">82</span><span class="p">,</span> <span class="mi">82</span><span class="p">]],</span>
        <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">33</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">166</span><span class="p">],</span> <span class="p">[</span><span class="mi">76</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">],</span> <span class="p">[</span><span class="mi">33</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">82</span><span class="p">]],</span>
    <span class="p">],</span>
    <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">mlflow</span><span class="o">.</span><span class="n">tensorflow</span><span class="o">.</span><span class="n">log_model</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">input_example</span><span class="o">=</span><span class="n">input_example</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="model-api">
<span id="id6"></span><h2><a class="toc-backref" href="#id25">Model API</a><a class="headerlink" href="#model-api" title="Permalink to this headline"> </a></h2>
<p>You can save and load MLflow Models in multiple ways. First, MLflow includes integrations with
several common libraries. For example, <a class="reference internal" href="python_api/mlflow.sklearn.html#module-mlflow.sklearn" title="mlflow.sklearn"><code class="xref py py-mod docutils literal notranslate"><span class="pre">mlflow.sklearn</span></code></a> contains
<a class="reference internal" href="python_api/mlflow.sklearn.html#mlflow.sklearn.save_model" title="mlflow.sklearn.save_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">save_model</span></code></a>, <a class="reference internal" href="python_api/mlflow.sklearn.html#mlflow.sklearn.log_model" title="mlflow.sklearn.log_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">log_model</span></code></a>,
and <a class="reference internal" href="python_api/mlflow.sklearn.html#mlflow.sklearn.load_model" title="mlflow.sklearn.load_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">load_model</span></code></a> functions for scikit-learn models. Second,
you can use the <a class="reference internal" href="python_api/mlflow.models.html#mlflow.models.Model" title="mlflow.models.Model"><code class="xref py py-class docutils literal notranslate"><span class="pre">mlflow.models.Model</span></code></a> class to create and write models. This
class has four key functions:</p>
<ul class="simple">
<li><p><a class="reference internal" href="python_api/mlflow.models.html#mlflow.models.Model.add_flavor" title="mlflow.models.Model.add_flavor"><code class="xref py py-func docutils literal notranslate"><span class="pre">add_flavor</span></code></a> to add a flavor to the model. Each flavor
has a string name and a dictionary of key-value attributes, where the values can be any object
that can be serialized to YAML.</p></li>
<li><p><a class="reference internal" href="python_api/mlflow.models.html#mlflow.models.Model.save" title="mlflow.models.Model.save"><code class="xref py py-func docutils literal notranslate"><span class="pre">save</span></code></a> to save the model to a local directory.</p></li>
<li><p><a class="reference internal" href="python_api/mlflow.models.html#mlflow.models.Model.log" title="mlflow.models.Model.log"><code class="xref py py-func docutils literal notranslate"><span class="pre">log</span></code></a> to log the model as an artifact in the
current run using MLflow Tracking.</p></li>
<li><p><a class="reference internal" href="python_api/mlflow.models.html#mlflow.models.Model.load" title="mlflow.models.Model.load"><code class="xref py py-func docutils literal notranslate"><span class="pre">load</span></code></a> to load a model from a local directory or
from an artifact in a previous run.</p></li>
</ul>
</div>
<div class="section" id="built-in-model-flavors">
<h2><a class="toc-backref" href="#id26">Built-In Model Flavors</a><a class="headerlink" href="#built-in-model-flavors" title="Permalink to this headline"> </a></h2>
<p>MLflow provides several standard flavors that might be useful in your applications. Specifically,
many of its deployment tools support these flavors, so you can export your own model in one of these
flavors to benefit from all these tools:</p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#python-function-python-function" id="id32">Python Function (<code class="docutils literal notranslate"><span class="pre">python_function</span></code>)</a></p></li>
<li><p><a class="reference internal" href="#r-function-crate" id="id33">R Function (<code class="docutils literal notranslate"><span class="pre">crate</span></code>)</a></p></li>
<li><p><a class="reference internal" href="#h2o-h2o" id="id34">H<sub>2</sub>O (<code class="docutils literal notranslate"><span class="pre">h2o</span></code>)</a></p></li>
<li><p><a class="reference internal" href="#keras-keras" id="id35">Keras (<code class="docutils literal notranslate"><span class="pre">keras</span></code>)</a></p></li>
<li><p><a class="reference internal" href="#mleap-mleap" id="id36">MLeap (<code class="docutils literal notranslate"><span class="pre">mleap</span></code>)</a></p></li>
<li><p><a class="reference internal" href="#pytorch-pytorch" id="id37">PyTorch (<code class="docutils literal notranslate"><span class="pre">pytorch</span></code>)</a></p></li>
<li><p><a class="reference internal" href="#scikit-learn-sklearn" id="id38">Scikit-learn (<code class="docutils literal notranslate"><span class="pre">sklearn</span></code>)</a></p></li>
<li><p><a class="reference internal" href="#spark-mllib-spark" id="id39">Spark MLlib (<code class="docutils literal notranslate"><span class="pre">spark</span></code>)</a></p></li>
<li><p><a class="reference internal" href="#tensorflow-tensorflow" id="id40">TensorFlow (<code class="docutils literal notranslate"><span class="pre">tensorflow</span></code>)</a></p></li>
<li><p><a class="reference internal" href="#onnx-onnx" id="id41">ONNX (<code class="docutils literal notranslate"><span class="pre">onnx</span></code>)</a></p></li>
<li><p><a class="reference internal" href="#mxnet-gluon-gluon" id="id42">MXNet Gluon (<code class="docutils literal notranslate"><span class="pre">gluon</span></code>)</a></p></li>
<li><p><a class="reference internal" href="#xgboost-xgboost" id="id43">XGBoost (<code class="docutils literal notranslate"><span class="pre">xgboost</span></code>)</a></p></li>
<li><p><a class="reference internal" href="#lightgbm-lightgbm" id="id44">LightGBM (<code class="docutils literal notranslate"><span class="pre">lightgbm</span></code>)</a></p></li>
<li><p><a class="reference internal" href="#catboost-catboost" id="id45">CatBoost (<code class="docutils literal notranslate"><span class="pre">catboost</span></code>)</a></p></li>
<li><p><a class="reference internal" href="#spacy-spacy" id="id46">Spacy(<code class="docutils literal notranslate"><span class="pre">spaCy</span></code>)</a></p></li>
<li><p><a class="reference internal" href="#fastai-fastai" id="id47">Fastai(<code class="docutils literal notranslate"><span class="pre">fastai</span></code>)</a></p></li>
<li><p><a class="reference internal" href="#statsmodels-statsmodels" id="id48">Statsmodels (<code class="docutils literal notranslate"><span class="pre">statsmodels</span></code>)</a></p></li>
<li><p><a class="reference internal" href="#prophet-prophet" id="id49">Prophet (<code class="docutils literal notranslate"><span class="pre">prophet</span></code>)</a></p></li>
<li><p><a class="reference internal" href="#pmdarima-pmdarima" id="id50">Pmdarima (<code class="docutils literal notranslate"><span class="pre">pmdarima</span></code>)</a></p></li>
<li><p><a class="reference internal" href="#diviner-diviner" id="id51">Diviner (<code class="docutils literal notranslate"><span class="pre">diviner</span></code>)</a></p></li>
</ul>
</div>
<div class="section" id="python-function-python-function">
<span id="pyfunc-model-flavor"></span><h3><a class="toc-backref" href="#id32">Python Function (<code class="docutils literal notranslate"><span class="pre">python_function</span></code>)</a><a class="headerlink" href="#python-function-python-function" title="Permalink to this headline"> </a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">python_function</span></code> model flavor serves as a default model interface for MLflow Python models.
Any MLflow Python model is expected to be loadable as a <code class="docutils literal notranslate"><span class="pre">python_function</span></code> model. This enables
other MLflow tools to work with any python model regardless of which persistence module or
framework was used to produce the model. This interoperability is very powerful because it allows
any Python model to be productionized in a variety of environments.</p>
<p>In addition, the <code class="docutils literal notranslate"><span class="pre">python_function</span></code> model flavor defines a generic filesystem <a class="reference internal" href="python_api/mlflow.pyfunc.html#pyfunc-filesystem-format"><span class="std std-ref">model format</span></a> for Python models and provides utilities for saving and loading models
to and from this format. The format is self-contained in the sense that it includes all the
information necessary to load and use a model. Dependencies are stored either directly with the
model or referenced via conda environment. This model format allows other tools to integrate
their models with MLflow.</p>
<div class="section" id="how-to-save-model-as-python-function">
<h4>How To Save Model As Python Function<a class="headerlink" href="#how-to-save-model-as-python-function" title="Permalink to this headline"> </a></h4>
<p>Most <code class="docutils literal notranslate"><span class="pre">python_function</span></code> models are saved as part of other model flavors - for example, all mlflow
built-in flavors include the <code class="docutils literal notranslate"><span class="pre">python_function</span></code> flavor in the exported models. In addition, the
<a class="reference internal" href="python_api/mlflow.pyfunc.html#module-mlflow.pyfunc" title="mlflow.pyfunc"><code class="xref py py-mod docutils literal notranslate"><span class="pre">mlflow.pyfunc</span></code></a> module defines functions for creating <code class="docutils literal notranslate"><span class="pre">python_function</span></code> models explicitly.
This module also includes utilities for creating custom Python models, which is a convenient way of
adding custom python code to ML models. For more information, see the <a class="reference internal" href="#custom-python-models"><span class="std std-ref">custom Python models
documentation</span></a>.</p>
</div>
<div class="section" id="how-to-load-and-score-python-function-models">
<h4>How To Load And Score Python Function Models<a class="headerlink" href="#how-to-load-and-score-python-function-models" title="Permalink to this headline"> </a></h4>
<p>You can load <code class="docutils literal notranslate"><span class="pre">python_function</span></code> models in Python by calling the <a class="reference internal" href="python_api/mlflow.pyfunc.html#mlflow.pyfunc.load_model" title="mlflow.pyfunc.load_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.pyfunc.load_model()</span></code></a>
function. Note that the <code class="docutils literal notranslate"><span class="pre">load_model</span></code> function assumes that all dependencies are already available
and <em>will not</em> check nor install any dependencies (
see <a class="reference internal" href="#built-in-deployment"><span class="std std-ref">model deployment section</span></a> for tools to deploy models with
automatic dependency management).</p>
<p>Once loaded, you can score the model by calling the <a class="reference internal" href="python_api/mlflow.pyfunc.html#mlflow.pyfunc.PyFuncModel.predict" title="mlflow.pyfunc.PyFuncModel.predict"><code class="xref py py-func docutils literal notranslate"><span class="pre">predict</span></code></a>
method, which has the following signature:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">predict</span><span class="p">(</span><span class="n">model_input</span><span class="p">:</span> <span class="p">[</span><span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="n">pandas</span><span class="o">.</span><span class="p">(</span><span class="n">Series</span> <span class="o">|</span> <span class="n">DataFrame</span><span class="p">)]</span>
</pre></div>
</div>
<p>All PyFunc models will support <cite>pandas.DataFrame</cite> as an input. In addition to <cite>pandas.DataFrame</cite>,
DL PyFunc models will also support tensor inputs in the form of <cite>numpy.ndarrays</cite>. To verify
whether a model flavor supports tensor inputs, please check the flavor’s documentation.</p>
<p>For models with a column-based schema, inputs are typically provided in the form of a <cite>pandas.DataFrame</cite>.
If a dictionary mapping column name to values is provided as input for schemas with named columns or if a
python <cite>List</cite> or a <cite>numpy.ndarray</cite> is provided as input for schemas with unnamed columns, MLflow will cast the
input to a DataFrame. Schema enforcement and casting with respect to the expected data types is performed against
the DataFrame.</p>
<p>For models with a tensor-based schema, inputs are typically provided in the form of a <cite>numpy.ndarray</cite> or a
dictionary mapping the tensor name to its np.ndarray value. Schema enforcement will check the provided input’s
shape and type against the shape and type specified in the model’s schema and throw an error if they do not match.</p>
<p>For models where no schema is defined, no changes to the model inputs and outputs are made. MLflow will
propagate any errors raised by the model if the model does not accept the provided input type.</p>
<p>The python environment that a PyFunc model is loaded into for prediction or inference may differ from the environment
in which it was trained. In the case of an environment mismatch, a warning message will be printed when calling
<a class="reference internal" href="python_api/mlflow.pyfunc.html#mlflow.pyfunc.load_model" title="mlflow.pyfunc.load_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.pyfunc.load_model()</span></code></a>. This warning statement will identify the packages that have a version mismatch
between those used during training and the current environment.  In order to get the full dependencies of the
environment in which the model was trained, you can call <a class="reference internal" href="python_api/mlflow.pyfunc.html#mlflow.pyfunc.get_model_dependencies" title="mlflow.pyfunc.get_model_dependencies"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.pyfunc.get_model_dependencies()</span></code></a>.
Furthermore, if you want to run model inference in the same environment used in model training, you can call
<a class="reference internal" href="python_api/mlflow.pyfunc.html#mlflow.pyfunc.spark_udf" title="mlflow.pyfunc.spark_udf"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.pyfunc.spark_udf()</span></code></a> with the <cite>env_manager</cite> argument set as “conda”. This will generate the environment
from the <cite>conda.yaml</cite> file, ensuring that the python UDF will execute with the exact package versions that were used
during training.</p>
</div>
</div>
<div class="section" id="r-function-crate">
<h3><a class="toc-backref" href="#id33">R Function (<code class="docutils literal notranslate"><span class="pre">crate</span></code>)</a><a class="headerlink" href="#r-function-crate" title="Permalink to this headline"> </a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">crate</span></code> model flavor defines a generic model format for representing an arbitrary R prediction
function as an MLflow model using the <code class="docutils literal notranslate"><span class="pre">crate</span></code> function from the
<a class="reference external" href="https://github.com/r-lib/carrier">carrier</a> package. The prediction function is expected to take a dataframe as input and
produce a dataframe, a vector or a list with the predictions as output.</p>
<p>This flavor requires R to be installed in order to be used.</p>
<div class="section" id="crate-usage">
<h4><code class="docutils literal notranslate"><span class="pre">crate</span></code> usage<a class="headerlink" href="#crate-usage" title="Permalink to this headline"> </a></h4>
<p>For a minimal crate model, an example configuration for the predict function is:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="n">mlflow</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">carrier</span><span class="p">)</span>
<span class="c1"># Load iris dataset</span>
<span class="nf">data</span><span class="p">(</span><span class="s">&quot;iris&quot;</span><span class="p">)</span>

<span class="c1"># Learn simple linear regression model</span>
<span class="n">model</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">lm</span><span class="p">(</span><span class="n">Sepal.Width</span><span class="o">~</span><span class="n">Sepal.Length</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iris</span><span class="p">)</span>

<span class="c1"># Define a crate model</span>
<span class="c1"># call package functions with an explicit :: namespace.</span>
<span class="n">crate_model</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">crate</span><span class="p">(</span>
<span class="w">  </span><span class="nf">function</span><span class="p">(</span><span class="n">new_obs</span><span class="p">)</span><span class="w">  </span><span class="n">stats</span><span class="o">::</span><span class="nf">predict</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="nf">data.frame</span><span class="p">(</span><span class="s">&quot;Sepal.Length&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new_obs</span><span class="p">)),</span>
<span class="w">  </span><span class="n">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span>
<span class="p">)</span>

<span class="c1"># log the model</span>
<span class="n">model_path</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">mlflow_log_model</span><span class="p">(</span><span class="n">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">crate_model</span><span class="p">,</span><span class="w"> </span><span class="n">artifact_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;iris_prediction&quot;</span><span class="p">)</span>

<span class="c1"># load the logged model and make a prediction</span>
<span class="n">model_uri</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">paste0</span><span class="p">(</span><span class="nf">mlflow_get_run</span><span class="p">()</span><span class="o">$</span><span class="n">artifact_uri</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/iris_prediction&quot;</span><span class="p">)</span>
<span class="n">mlflow_model</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">mlflow_load_model</span><span class="p">(</span><span class="n">model_uri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model_uri</span><span class="p">,</span>
<span class="w">                                  </span><span class="n">flavor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NULL</span><span class="p">,</span>
<span class="w">                                  </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">mlflow_client</span><span class="p">())</span>

<span class="n">prediction</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">mlflow_predict</span><span class="p">(</span><span class="n">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mlflow_model</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="h2o-h2o">
<h3><a class="toc-backref" href="#id34">H<sub>2</sub>O (<code class="docutils literal notranslate"><span class="pre">h2o</span></code>)</a><a class="headerlink" href="#h2o-h2o" title="Permalink to this headline"> </a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">h2o</span></code> model flavor enables logging and loading H2O models.</p>
<p>The <a class="reference internal" href="python_api/mlflow.h2o.html#module-mlflow.h2o" title="mlflow.h2o"><code class="xref py py-mod docutils literal notranslate"><span class="pre">mlflow.h2o</span></code></a> module defines <a class="reference internal" href="python_api/mlflow.h2o.html#mlflow.h2o.save_model" title="mlflow.h2o.save_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">save_model()</span></code></a> and
<a class="reference internal" href="python_api/mlflow.h2o.html#mlflow.h2o.log_model" title="mlflow.h2o.log_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">log_model()</span></code></a> methods in python, and
<a class="reference external" href="R-api.html#mlflow-save-model-h2o">mlflow_save_model</a> and
<a class="reference external" href="R-api.html#mlflow-log-model">mlflow_log_model</a> in R for saving H2O models in MLflow Model
format.
These methods produce MLflow Models with the <code class="docutils literal notranslate"><span class="pre">python_function</span></code> flavor, allowing you to load them
as generic Python functions for inference via <a class="reference internal" href="python_api/mlflow.pyfunc.html#mlflow.pyfunc.load_model" title="mlflow.pyfunc.load_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.pyfunc.load_model()</span></code></a>.
This loaded PyFunc model can be scored with only DataFrame input. When you load
MLflow Models with the <code class="docutils literal notranslate"><span class="pre">h2o</span></code> flavor using <a class="reference internal" href="python_api/mlflow.pyfunc.html#mlflow.pyfunc.load_model" title="mlflow.pyfunc.load_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.pyfunc.load_model()</span></code></a>,
the <a class="reference external" href="http://docs.h2o.ai/h2o/latest-stable/h2o-py/docs/h2o.html#h2o.init">h2o.init()</a> method is
called. Therefore, the correct version of <code class="docutils literal notranslate"><span class="pre">h2o(-py)</span></code> must be installed in the loader’s
environment. You can customize the arguments given to
<a class="reference external" href="http://docs.h2o.ai/h2o/latest-stable/h2o-py/docs/h2o.html#h2o.init">h2o.init()</a> by modifying the
<code class="docutils literal notranslate"><span class="pre">init</span></code> entry of the persisted H2O model’s YAML configuration file: <code class="docutils literal notranslate"><span class="pre">model.h2o/h2o.yaml</span></code>.</p>
<p>Finally, you can use the <a class="reference internal" href="python_api/mlflow.h2o.html#mlflow.h2o.load_model" title="mlflow.h2o.load_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.h2o.load_model()</span></code></a> method to load MLflow Models with the
<code class="docutils literal notranslate"><span class="pre">h2o</span></code> flavor as H2O model objects.</p>
<p>For more information, see <a class="reference internal" href="python_api/mlflow.h2o.html#module-mlflow.h2o" title="mlflow.h2o"><code class="xref py py-mod docutils literal notranslate"><span class="pre">mlflow.h2o</span></code></a>.</p>
</div>
<div class="section" id="keras-keras">
<h3><a class="toc-backref" href="#id35">Keras (<code class="docutils literal notranslate"><span class="pre">keras</span></code>)</a><a class="headerlink" href="#keras-keras" title="Permalink to this headline"> </a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">keras</span></code> model flavor enables logging and loading Keras models. It is available in both Python
and R clients. In R, you can save or log the model using
<a class="reference external" href="R-api.rst#mlflow-save-model">mlflow_save_model</a> and <a class="reference external" href="R-api.rst#mlflow-log-model">mlflow_log_model</a>.
These functions serialize Keras models models as HDF5 files using the Keras library’s built-in
model persistence functions. You can use
<a class="reference external" href="R-api.rst#mlflow-load-model">mlflow_load_model</a> function in R to load MLflow Models
with the <code class="docutils literal notranslate"><span class="pre">keras</span></code> flavor as <a class="reference external" href="https://keras.io/models/about-keras-models/">Keras Model objects</a>.</p>
<div class="section" id="keras-pyfunc-usage">
<h4>Keras pyfunc usage<a class="headerlink" href="#keras-pyfunc-usage" title="Permalink to this headline"> </a></h4>
<p>For a minimal Sequential model, an example configuration for the pyfunc predict() method is:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mlflow</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>

<span class="n">mlflow</span><span class="o">.</span><span class="n">tensorflow</span><span class="o">.</span><span class="n">autolog</span><span class="p">()</span>

<span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">():</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">keras</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,)),</span>
            <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;sigmoid&quot;</span><span class="p">),</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s2">&quot;binary_crossentropy&quot;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;adam&quot;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">])</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">validation_split</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
    <span class="n">model_info</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">tensorflow</span><span class="o">.</span><span class="n">log_model</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">artifact_path</span><span class="o">=</span><span class="s2">&quot;model&quot;</span><span class="p">)</span>

<span class="n">local_artifact_dir</span> <span class="o">=</span> <span class="s2">&quot;/tmp/mlflow/keras_model&quot;</span>
<span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">local_artifact_dir</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">keras_pyfunc</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">pyfunc</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span>
    <span class="n">model_uri</span><span class="o">=</span><span class="n">model_info</span><span class="o">.</span><span class="n">model_uri</span><span class="p">,</span> <span class="n">dst_path</span><span class="o">=</span><span class="n">local_artifact_dir</span>
<span class="p">)</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">keras_pyfunc</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">local_artifact_dir</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="mleap-mleap">
<h3><a class="toc-backref" href="#id36">MLeap (<code class="docutils literal notranslate"><span class="pre">mleap</span></code>)</a><a class="headerlink" href="#mleap-mleap" title="Permalink to this headline"> </a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">mleap</span></code> model flavor supports saving Spark models in MLflow format using the
<a class="reference external" href="https://combust.github.io/mleap-docs/">MLeap</a> persistence mechanism. MLeap is an inference-optimized
format and execution engine for Spark models that does not depend on
<a class="reference external" href="https://spark.apache.org/docs/latest/api/python/pyspark.html#pyspark.SparkContext">SparkContext</a>
to evaluate inputs.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can save Spark models in MLflow format with the <code class="docutils literal notranslate"><span class="pre">mleap</span></code> flavor by specifying the
<code class="docutils literal notranslate"><span class="pre">sample_input</span></code> argument of the <a class="reference internal" href="python_api/mlflow.spark.html#mlflow.spark.save_model" title="mlflow.spark.save_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.spark.save_model()</span></code></a> or
<a class="reference internal" href="python_api/mlflow.spark.html#mlflow.spark.log_model" title="mlflow.spark.log_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.spark.log_model()</span></code></a> method (recommended). For more details see <a class="reference internal" href="#model-spark"><span class="std std-ref">Spark MLlib</span></a>.</p>
</div>
<p>The <a class="reference internal" href="python_api/mlflow.mleap.html#module-mlflow.mleap" title="mlflow.mleap"><code class="xref py py-mod docutils literal notranslate"><span class="pre">mlflow.mleap</span></code></a> module also
defines <a class="reference internal" href="python_api/mlflow.mleap.html#mlflow.mleap.save_model" title="mlflow.mleap.save_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">save_model()</span></code></a> and
<a class="reference internal" href="python_api/mlflow.mleap.html#mlflow.mleap.log_model" title="mlflow.mleap.log_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">log_model()</span></code></a> methods for saving MLeap models in MLflow format,
but these methods do not include the <code class="docutils literal notranslate"><span class="pre">python_function</span></code> flavor in the models they produce.
Similarly, <code class="docutils literal notranslate"><span class="pre">mleap</span></code> models can be saved in R with <a class="reference external" href="R-api.rst#mlflow-save-model">mlflow_save_model</a>
and loaded with <a class="reference external" href="R-api.rst#mlflow-load-model">mlflow_load_model</a>, with
<a class="reference external" href="R-api.rst#mlflow-save-model">mlflow_save_model</a> requiring <cite>sample_input</cite> to be specified as a
sample Spark dataframe containing input data to the model is required by MLeap for data schema
inference.</p>
<p>A companion module for loading MLflow Models with the MLeap flavor is available in the
<code class="docutils literal notranslate"><span class="pre">mlflow/java</span></code> package.</p>
<p>For more information, see <a class="reference internal" href="python_api/mlflow.spark.html#module-mlflow.spark" title="mlflow.spark"><code class="xref py py-mod docutils literal notranslate"><span class="pre">mlflow.spark</span></code></a>, <a class="reference internal" href="python_api/mlflow.mleap.html#module-mlflow.mleap" title="mlflow.mleap"><code class="xref py py-mod docutils literal notranslate"><span class="pre">mlflow.mleap</span></code></a>, and the
<a class="reference external" href="https://combust.github.io/mleap-docs/">MLeap documentation</a>.</p>
</div>
<div class="section" id="pytorch-pytorch">
<h3><a class="toc-backref" href="#id37">PyTorch (<code class="docutils literal notranslate"><span class="pre">pytorch</span></code>)</a><a class="headerlink" href="#pytorch-pytorch" title="Permalink to this headline"> </a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">pytorch</span></code> model flavor enables logging and loading PyTorch models.</p>
<p>The <a class="reference internal" href="python_api/mlflow.pytorch.html#module-mlflow.pytorch" title="mlflow.pytorch"><code class="xref py py-mod docutils literal notranslate"><span class="pre">mlflow.pytorch</span></code></a> module defines utilities for saving and loading MLflow Models with the
<code class="docutils literal notranslate"><span class="pre">pytorch</span></code> flavor. You can use the <a class="reference internal" href="python_api/mlflow.pytorch.html#mlflow.pytorch.save_model" title="mlflow.pytorch.save_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.pytorch.save_model()</span></code></a> and
<a class="reference internal" href="python_api/mlflow.pytorch.html#mlflow.pytorch.log_model" title="mlflow.pytorch.log_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.pytorch.log_model()</span></code></a> methods to save PyTorch models in MLflow format; both of these
functions use the <a class="reference external" href="https://pytorch.org/docs/stable/torch.html#torch.save">torch.save()</a> method to
serialize PyTorch models. Additionally, you can use the <a class="reference internal" href="python_api/mlflow.pytorch.html#mlflow.pytorch.load_model" title="mlflow.pytorch.load_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.pytorch.load_model()</span></code></a>
method to load MLflow Models with the <code class="docutils literal notranslate"><span class="pre">pytorch</span></code> flavor as PyTorch model objects. This loaded
PyFunc model can be scored with both DataFrame input and numpy array input. Finally, models
produced by <a class="reference internal" href="python_api/mlflow.pytorch.html#mlflow.pytorch.save_model" title="mlflow.pytorch.save_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.pytorch.save_model()</span></code></a> and <a class="reference internal" href="python_api/mlflow.pytorch.html#mlflow.pytorch.log_model" title="mlflow.pytorch.log_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.pytorch.log_model()</span></code></a> contain
the <code class="docutils literal notranslate"><span class="pre">python_function</span></code> flavor, allowing you to load them as generic Python functions for inference
via <a class="reference internal" href="python_api/mlflow.pyfunc.html#mlflow.pyfunc.load_model" title="mlflow.pyfunc.load_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.pyfunc.load_model()</span></code></a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When using the PyTorch flavor, if a GPU is available at prediction time, the default GPU will be used to run
inference. To disable this behavior, users can use the
<a class="reference external" href="python_api/mlflow.environment_variables.html#mlflow.environment_variables.MLFLOW_DEFAULT_PREDICTION_DEVICE">MLFLOW_DEFAULT_PREDICTION_DEVICE</a>
or pass in a device with the <cite>device</cite> parameter for the <cite>predict</cite> function.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In case of multi gpu training, ensure to save the model only with global rank 0 gpu. This avoids
logging multiple copies of the same model.</p>
</div>
<div class="section" id="pytorch-pyfunc-usage">
<h4>PyTorch pyfunc usage<a class="headerlink" href="#pytorch-pyfunc-usage" title="Permalink to this headline"> </a></h4>
<p>For a minimal PyTorch model, an example configuration for the pyfunc predict() method is:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">mlflow</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>


<span class="n">net</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">loss_function</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">L1Loss</span><span class="p">()</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">epochs</span> <span class="o">=</span> <span class="mi">5</span>
<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">):</span>
    <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

    <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_function</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>

    <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

<span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">()</span> <span class="k">as</span> <span class="n">run</span><span class="p">:</span>
    <span class="n">model_info</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">log_model</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">)</span>

<span class="n">pytorch_pyfunc</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">pyfunc</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">model_uri</span><span class="o">=</span><span class="n">model_info</span><span class="o">.</span><span class="n">model_uri</span><span class="p">)</span>

<span class="n">predictions</span> <span class="o">=</span> <span class="n">pytorch_pyfunc</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>
</pre></div>
</div>
<p>For more information, see <a class="reference internal" href="python_api/mlflow.pytorch.html#module-mlflow.pytorch" title="mlflow.pytorch"><code class="xref py py-mod docutils literal notranslate"><span class="pre">mlflow.pytorch</span></code></a>.</p>
</div>
</div>
<div class="section" id="scikit-learn-sklearn">
<h3><a class="toc-backref" href="#id38">Scikit-learn (<code class="docutils literal notranslate"><span class="pre">sklearn</span></code>)</a><a class="headerlink" href="#scikit-learn-sklearn" title="Permalink to this headline"> </a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">sklearn</span></code> model flavor provides an easy-to-use interface for saving and loading scikit-learn
models. The <a class="reference internal" href="python_api/mlflow.sklearn.html#module-mlflow.sklearn" title="mlflow.sklearn"><code class="xref py py-mod docutils literal notranslate"><span class="pre">mlflow.sklearn</span></code></a> module defines
<a class="reference internal" href="python_api/mlflow.sklearn.html#mlflow.sklearn.save_model" title="mlflow.sklearn.save_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">save_model()</span></code></a> and
<a class="reference internal" href="python_api/mlflow.sklearn.html#mlflow.sklearn.log_model" title="mlflow.sklearn.log_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">log_model()</span></code></a> functions that save scikit-learn models in
MLflow format, using either Python’s pickle module (Pickle) or CloudPickle for model serialization.
These functions produce MLflow Models with the <code class="docutils literal notranslate"><span class="pre">python_function</span></code> flavor, allowing them to
be loaded as generic Python functions for inference via <a class="reference internal" href="python_api/mlflow.pyfunc.html#mlflow.pyfunc.load_model" title="mlflow.pyfunc.load_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.pyfunc.load_model()</span></code></a>.
This loaded PyFunc model can only be scored with DataFrame input. Finally, you can use the
<a class="reference internal" href="python_api/mlflow.sklearn.html#mlflow.sklearn.load_model" title="mlflow.sklearn.load_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.sklearn.load_model()</span></code></a> method to load MLflow Models with the <code class="docutils literal notranslate"><span class="pre">sklearn</span></code> flavor as
scikit-learn model objects.</p>
<div class="section" id="scikit-learn-pyfunc-usage">
<h4>Scikit-learn pyfunc usage<a class="headerlink" href="#scikit-learn-pyfunc-usage" title="Permalink to this headline"> </a></h4>
<p>For a Scikit-learn LogisticRegression model, an example configuration for the pyfunc predict() method is:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mlflow</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>

<span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">():</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">lr</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">()</span>
    <span class="n">lr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

    <span class="n">model_info</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">sklearn</span><span class="o">.</span><span class="n">log_model</span><span class="p">(</span><span class="n">sk_model</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="n">artifact_path</span><span class="o">=</span><span class="s2">&quot;model&quot;</span><span class="p">)</span>

<span class="n">sklearn_pyfunc</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">pyfunc</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">model_uri</span><span class="o">=</span><span class="n">model_info</span><span class="o">.</span><span class="n">model_uri</span><span class="p">)</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">predictions</span> <span class="o">=</span> <span class="n">sklearn_pyfunc</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
<p>For more information, see <a class="reference internal" href="python_api/mlflow.sklearn.html#module-mlflow.sklearn" title="mlflow.sklearn"><code class="xref py py-mod docutils literal notranslate"><span class="pre">mlflow.sklearn</span></code></a>.</p>
</div>
</div>
<div class="section" id="spark-mllib-spark">
<span id="model-spark"></span><h3><a class="toc-backref" href="#id39">Spark MLlib (<code class="docutils literal notranslate"><span class="pre">spark</span></code>)</a><a class="headerlink" href="#spark-mllib-spark" title="Permalink to this headline"> </a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">spark</span></code> model flavor enables exporting Spark MLlib models as MLflow Models.</p>
<p>The <a class="reference internal" href="python_api/mlflow.spark.html#module-mlflow.spark" title="mlflow.spark"><code class="xref py py-mod docutils literal notranslate"><span class="pre">mlflow.spark</span></code></a> module defines</p>
<ul class="simple">
<li><p><a class="reference internal" href="python_api/mlflow.spark.html#mlflow.spark.save_model" title="mlflow.spark.save_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">save_model()</span></code></a> to save a Spark MLlib model to a DBFS path.</p></li>
<li><p><a class="reference internal" href="python_api/mlflow.spark.html#mlflow.spark.log_model" title="mlflow.spark.log_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">log_model()</span></code></a> to upload a Spark MLlib model to the tracking server.</p></li>
<li><p><a class="reference internal" href="python_api/mlflow.spark.html#mlflow.spark.load_model" title="mlflow.spark.load_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.spark.load_model()</span></code></a> to load MLflow Models with the <code class="docutils literal notranslate"><span class="pre">spark</span></code> flavor as Spark MLlib pipelines.</p></li>
</ul>
<p>MLflow Models produced by these functions contain the <code class="docutils literal notranslate"><span class="pre">python_function</span></code> flavor,
allowing you to load them as generic Python functions via <a class="reference internal" href="python_api/mlflow.pyfunc.html#mlflow.pyfunc.load_model" title="mlflow.pyfunc.load_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.pyfunc.load_model()</span></code></a>.
This loaded PyFunc model can only be scored with DataFrame input.
When a model with the <code class="docutils literal notranslate"><span class="pre">spark</span></code> flavor is loaded as a Python function via
<a class="reference internal" href="python_api/mlflow.pyfunc.html#mlflow.pyfunc.load_model" title="mlflow.pyfunc.load_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.pyfunc.load_model()</span></code></a>, a new
<a class="reference external" href="https://spark.apache.org/docs/latest/api/python/pyspark.html#pyspark.SparkContext">SparkContext</a>
is created for model inference; additionally, the function converts all Pandas DataFrame inputs to
Spark DataFrames before scoring. While this initialization overhead and format translation latency
is not ideal for high-performance use cases, it enables you to easily deploy any
<a class="reference external" href="http://spark.apache.org/docs/latest/api/python/pyspark.ml.html?highlight=pipelinemodel#pyspark.ml.Pipeline">MLlib PipelineModel</a> to any production environment supported by MLflow
(SageMaker, AzureML, etc).</p>
<div class="section" id="spark-mllib-pyfunc-usage">
<h4>Spark MLlib pyfunc usage<a class="headerlink" href="#spark-mllib-pyfunc-usage" title="Permalink to this headline"> </a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.ml.classification</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">pyspark.ml.linalg</span> <span class="kn">import</span> <span class="n">Vectors</span>
<span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
<span class="kn">import</span> <span class="nn">mlflow</span>

<span class="c1"># Prepare training data from a list of (label, features) tuples.</span>
<span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&quot;LogisticRegressionExample&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
<span class="n">training</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">dense</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">])),</span>
        <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">dense</span><span class="p">([</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">])),</span>
        <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">dense</span><span class="p">([</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])),</span>
        <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">dense</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">])),</span>
    <span class="p">],</span>
    <span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="s2">&quot;features&quot;</span><span class="p">],</span>
<span class="p">)</span>

<span class="c1"># Create and fit a LogisticRegression instance</span>
<span class="n">lr</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">maxIter</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">regParam</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
<span class="n">lr_model</span> <span class="o">=</span> <span class="n">lr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">training</span><span class="p">)</span>

<span class="c1"># Serialize the Model</span>
<span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">():</span>
    <span class="n">model_info</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">spark</span><span class="o">.</span><span class="n">log_model</span><span class="p">(</span><span class="n">lr_model</span><span class="p">,</span> <span class="s2">&quot;spark-model&quot;</span><span class="p">)</span>

<span class="c1"># Load saved model</span>
<span class="n">lr_model_saved</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">pyfunc</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">model_info</span><span class="o">.</span><span class="n">model_uri</span><span class="p">)</span>

<span class="c1"># Make predictions on test data.</span>
<span class="c1"># The DataFrame used in the predict method must be a Pandas DataFrame</span>
<span class="n">test</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">dense</span><span class="p">([</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">])),</span>
        <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">dense</span><span class="p">([</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">])),</span>
        <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">dense</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">2.2</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.5</span><span class="p">])),</span>
    <span class="p">],</span>
    <span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="s2">&quot;features&quot;</span><span class="p">],</span>
<span class="p">)</span><span class="o">.</span><span class="n">toPandas</span><span class="p">()</span>

<span class="n">prediction</span> <span class="o">=</span> <span class="n">lr_model_saved</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Note that when the <code class="docutils literal notranslate"><span class="pre">sample_input</span></code> parameter is provided to <code class="docutils literal notranslate"><span class="pre">log_model()</span></code> or
<code class="docutils literal notranslate"><span class="pre">save_model()</span></code>, the Spark model is automatically saved as an <code class="docutils literal notranslate"><span class="pre">mleap</span></code> flavor
by invoking <a class="reference internal" href="python_api/mlflow.mleap.html#mlflow.mleap.add_to_model" title="mlflow.mleap.add_to_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.mleap.add_to_model()</span></code></a>.</p>
<p>For example, the follow code block:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">training_df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">([</span>
    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;a b c d e spark&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;b d&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;spark f g h&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;hadoop mapreduce&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="p">],</span> <span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">])</span>

<span class="n">tokenizer</span> <span class="o">=</span> <span class="n">Tokenizer</span><span class="p">(</span><span class="n">inputCol</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="n">outputCol</span><span class="o">=</span><span class="s2">&quot;words&quot;</span><span class="p">)</span>
<span class="n">hashingTF</span> <span class="o">=</span> <span class="n">HashingTF</span><span class="p">(</span><span class="n">inputCol</span><span class="o">=</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">getOutputCol</span><span class="p">(),</span> <span class="n">outputCol</span><span class="o">=</span><span class="s2">&quot;features&quot;</span><span class="p">)</span>
<span class="n">lr</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">maxIter</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">regParam</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
<span class="n">pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">stages</span><span class="o">=</span><span class="p">[</span><span class="n">tokenizer</span><span class="p">,</span> <span class="n">hashingTF</span><span class="p">,</span> <span class="n">lr</span><span class="p">])</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">training_df</span><span class="p">)</span>

<span class="n">mlflow</span><span class="o">.</span><span class="n">spark</span><span class="o">.</span><span class="n">log_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;spark-model&quot;</span><span class="p">,</span> <span class="n">sample_input</span><span class="o">=</span><span class="n">training_df</span><span class="p">)</span>
</pre></div>
</div>
<p>results in the following directory structure logged to the MLflow Experiment:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># Directory written by with the addition of mlflow.mleap.add_to_model(model, &quot;spark-model&quot;, training_df)
# Note the addition of the mleap directory
spark-model/
├── mleap
├── sparkml
├── MLmodel
├── conda.yaml
├── python_env.yaml
└── requirements.txt
</pre></div>
</div>
<p>For more information, see <a class="reference internal" href="python_api/mlflow.mleap.html#module-mlflow.mleap" title="mlflow.mleap"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.mleap</span></code></a>.</p>
</div>
<p>For more information, see <a class="reference internal" href="python_api/mlflow.spark.html#module-mlflow.spark" title="mlflow.spark"><code class="xref py py-mod docutils literal notranslate"><span class="pre">mlflow.spark</span></code></a>.</p>
</div>
</div>
<div class="section" id="tensorflow-tensorflow">
<h3><a class="toc-backref" href="#id40">TensorFlow (<code class="docutils literal notranslate"><span class="pre">tensorflow</span></code>)</a><a class="headerlink" href="#tensorflow-tensorflow" title="Permalink to this headline"> </a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">tensorflow</span></code> model flavor allows TensorFlow Core models and Keras models
to be logged in MLflow format via the <a class="reference internal" href="python_api/mlflow.tensorflow.html#mlflow.tensorflow.save_model" title="mlflow.tensorflow.save_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.tensorflow.save_model()</span></code></a> and
<a class="reference internal" href="python_api/mlflow.tensorflow.html#mlflow.tensorflow.log_model" title="mlflow.tensorflow.log_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.tensorflow.log_model()</span></code></a> methods. These methods also add the <code class="docutils literal notranslate"><span class="pre">python_function</span></code>
flavor to the MLflow Models that they produce, allowing the models to be interpreted as generic
Python functions for inference via <a class="reference internal" href="python_api/mlflow.pyfunc.html#mlflow.pyfunc.load_model" title="mlflow.pyfunc.load_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.pyfunc.load_model()</span></code></a>. This loaded PyFunc model
can be scored with both DataFrame input and numpy array input. Finally, you can use the
<a class="reference internal" href="python_api/mlflow.tensorflow.html#mlflow.tensorflow.load_model" title="mlflow.tensorflow.load_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.tensorflow.load_model()</span></code></a> method to load MLflow Models with the <code class="docutils literal notranslate"><span class="pre">tensorflow</span></code>
flavor as TensorFlow Core models or Keras models.</p>
<p>For more information, see <a class="reference internal" href="python_api/mlflow.tensorflow.html#module-mlflow.tensorflow" title="mlflow.tensorflow"><code class="xref py py-mod docutils literal notranslate"><span class="pre">mlflow.tensorflow</span></code></a>.</p>
</div>
<div class="section" id="onnx-onnx">
<h3><a class="toc-backref" href="#id41">ONNX (<code class="docutils literal notranslate"><span class="pre">onnx</span></code>)</a><a class="headerlink" href="#onnx-onnx" title="Permalink to this headline"> </a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">onnx</span></code> model flavor enables logging of <a class="reference external" href="http://onnx.ai/">ONNX models</a> in MLflow format via
the <a class="reference internal" href="python_api/mlflow.onnx.html#mlflow.onnx.save_model" title="mlflow.onnx.save_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.onnx.save_model()</span></code></a> and <a class="reference internal" href="python_api/mlflow.onnx.html#mlflow.onnx.log_model" title="mlflow.onnx.log_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.onnx.log_model()</span></code></a> methods. These
methods also add the <code class="docutils literal notranslate"><span class="pre">python_function</span></code> flavor to the MLflow Models that they produce, allowing the
models to be interpreted as generic Python functions for inference via
<a class="reference internal" href="python_api/mlflow.pyfunc.html#mlflow.pyfunc.load_model" title="mlflow.pyfunc.load_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.pyfunc.load_model()</span></code></a>. This loaded PyFunc model can be scored with
both DataFrame input and numpy array input. The <code class="docutils literal notranslate"><span class="pre">python_function</span></code> representation of an MLflow
ONNX model uses the <a class="reference external" href="https://github.com/microsoft/onnxruntime">ONNX Runtime execution engine</a> for
evaluation. Finally, you can use the <a class="reference internal" href="python_api/mlflow.onnx.html#mlflow.onnx.load_model" title="mlflow.onnx.load_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.onnx.load_model()</span></code></a> method to load MLflow
Models with the <code class="docutils literal notranslate"><span class="pre">onnx</span></code> flavor in native ONNX format.</p>
<p>For more information, see <a class="reference internal" href="python_api/mlflow.onnx.html#module-mlflow.onnx" title="mlflow.onnx"><code class="xref py py-mod docutils literal notranslate"><span class="pre">mlflow.onnx</span></code></a> and <a class="reference external" href="http://onnx.ai/">http://onnx.ai/</a>.</p>
<div class="section" id="onnx-pyfunc-usage-example">
<h4>ONNX pyfunc usage example<a class="headerlink" href="#onnx-pyfunc-usage-example" title="Permalink to this headline"> </a></h4>
<p>For an ONNX model, an example configuration that uses pytorch to train a dummy model,
converts it to ONNX, logs to mlflow and makes a prediction using pyfunc predict() method is:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">mlflow</span>
<span class="kn">import</span> <span class="nn">onnx</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>

<span class="c1"># define a torch model</span>
<span class="n">net</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">loss_function</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">L1Loss</span><span class="p">()</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># run model training</span>
<span class="n">epochs</span> <span class="o">=</span> <span class="mi">5</span>
<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">):</span>
    <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

    <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_function</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>

    <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

<span class="c1"># convert model to ONNX and load it</span>
<span class="n">torch</span><span class="o">.</span><span class="n">onnx</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="s2">&quot;model.onnx&quot;</span><span class="p">)</span>
<span class="n">onnx_model</span> <span class="o">=</span> <span class="n">onnx</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="s2">&quot;model.onnx&quot;</span><span class="p">)</span>

<span class="c1"># log the model into a mlflow run</span>
<span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">():</span>
    <span class="n">model_info</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">onnx</span><span class="o">.</span><span class="n">log_model</span><span class="p">(</span><span class="n">onnx_model</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">)</span>

<span class="c1"># load the logged model and make a prediction</span>
<span class="n">onnx_pyfunc</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">pyfunc</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">model_info</span><span class="o">.</span><span class="n">model_uri</span><span class="p">)</span>

<span class="n">predictions</span> <span class="o">=</span> <span class="n">onnx_pyfunc</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="mxnet-gluon-gluon">
<h3><a class="toc-backref" href="#id42">MXNet Gluon (<code class="docutils literal notranslate"><span class="pre">gluon</span></code>)</a><a class="headerlink" href="#mxnet-gluon-gluon" title="Permalink to this headline"> </a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">gluon</span></code> model flavor enables logging of <a class="reference external" href="https://mxnet.incubator.apache.org/api/python/docs/api/gluon/index.html">Gluon models</a> in MLflow format via
the <a class="reference internal" href="python_api/mlflow.gluon.html#mlflow.gluon.save_model" title="mlflow.gluon.save_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.gluon.save_model()</span></code></a> and <a class="reference internal" href="python_api/mlflow.gluon.html#mlflow.gluon.log_model" title="mlflow.gluon.log_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.gluon.log_model()</span></code></a> methods. These
methods also add the <code class="docutils literal notranslate"><span class="pre">python_function</span></code> flavor to the MLflow Models that they produce, allowing the
models to be interpreted as generic Python functions for inference via
<a class="reference internal" href="python_api/mlflow.pyfunc.html#mlflow.pyfunc.load_model" title="mlflow.pyfunc.load_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.pyfunc.load_model()</span></code></a>. This loaded PyFunc model can be scored with
both DataFrame input and numpy array input. You can also use the <a class="reference internal" href="python_api/mlflow.gluon.html#mlflow.gluon.load_model" title="mlflow.gluon.load_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.gluon.load_model()</span></code></a>
method to load MLflow Models with the <code class="docutils literal notranslate"><span class="pre">gluon</span></code> flavor in native Gluon format.</p>
<p>For more information, see <a class="reference internal" href="python_api/mlflow.gluon.html#module-mlflow.gluon" title="mlflow.gluon"><code class="xref py py-mod docutils literal notranslate"><span class="pre">mlflow.gluon</span></code></a>.</p>
</div>
<div class="section" id="xgboost-xgboost">
<h3><a class="toc-backref" href="#id43">XGBoost (<code class="docutils literal notranslate"><span class="pre">xgboost</span></code>)</a><a class="headerlink" href="#xgboost-xgboost" title="Permalink to this headline"> </a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">xgboost</span></code> model flavor enables logging of <a class="reference external" href="https://xgboost.readthedocs.io/en/latest/python/python_api.html#xgboost.Booster">XGBoost models</a>
in MLflow format via the <a class="reference internal" href="python_api/mlflow.xgboost.html#mlflow.xgboost.save_model" title="mlflow.xgboost.save_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.xgboost.save_model()</span></code></a> and <a class="reference internal" href="python_api/mlflow.xgboost.html#mlflow.xgboost.log_model" title="mlflow.xgboost.log_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.xgboost.log_model()</span></code></a> methods in python and <a class="reference external" href="R-api.html#mlflow-save-model-crate">mlflow_save_model</a> and <a class="reference external" href="R-api.html#mlflow-log-model">mlflow_log_model</a> in R respectively.
These methods also add the <code class="docutils literal notranslate"><span class="pre">python_function</span></code> flavor to the MLflow Models that they produce, allowing the
models to be interpreted as generic Python functions for inference via
<a class="reference internal" href="python_api/mlflow.pyfunc.html#mlflow.pyfunc.load_model" title="mlflow.pyfunc.load_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.pyfunc.load_model()</span></code></a>. This loaded PyFunc model can only be scored with DataFrame input.
You can also use the <a class="reference internal" href="python_api/mlflow.xgboost.html#mlflow.xgboost.load_model" title="mlflow.xgboost.load_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.xgboost.load_model()</span></code></a>
method to load MLflow Models with the <code class="docutils literal notranslate"><span class="pre">xgboost</span></code> model flavor in native XGBoost format.</p>
<p>Note that the <code class="docutils literal notranslate"><span class="pre">xgboost</span></code> model flavor only supports an instance of <a class="reference external" href="https://xgboost.readthedocs.io/en/latest/python/python_api.html#xgboost.Booster">xgboost.Booster</a>,
not models that implement the <a class="reference external" href="https://xgboost.readthedocs.io/en/latest/python/python_api.html#module-xgboost.sklearn">scikit-learn API</a>.</p>
<div class="section" id="xgboost-pyfunc-usage">
<h4><code class="docutils literal notranslate"><span class="pre">XGBoost</span></code> pyfunc usage<a class="headerlink" href="#xgboost-pyfunc-usage" title="Permalink to this headline"> </a></h4>
<p>The example below</p>
<ul class="simple">
<li><p>Loads the IRIS dataset from <code class="docutils literal notranslate"><span class="pre">scikit-learn</span></code></p></li>
<li><p>Trains an XGBoost Classifier</p></li>
<li><p>Logs the model and params using <code class="docutils literal notranslate"><span class="pre">mlflow</span></code></p></li>
<li><p>Loads the logged model and makes predictions</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">load_iris</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">xgboost</span> <span class="kn">import</span> <span class="n">XGBClassifier</span>
<span class="kn">import</span> <span class="nn">mlflow</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">load_iris</span><span class="p">()</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">],</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span>
<span class="p">)</span>

<span class="n">xgb_classifier</span> <span class="o">=</span> <span class="n">XGBClassifier</span><span class="p">(</span>
    <span class="n">n_estimators</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">learning_rate</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">objective</span><span class="o">=</span><span class="s2">&quot;binary:logistic&quot;</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">123</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># log fitted model and XGBClassifier parameters</span>
<span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">():</span>
    <span class="n">xgb_classifier</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">clf_params</span> <span class="o">=</span> <span class="n">xgb_classifier</span><span class="o">.</span><span class="n">get_xgb_params</span><span class="p">()</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_params</span><span class="p">(</span><span class="n">clf_params</span><span class="p">)</span>
    <span class="n">model_info</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">xgboost</span><span class="o">.</span><span class="n">log_model</span><span class="p">(</span><span class="n">xgb_classifier</span><span class="p">,</span> <span class="s2">&quot;iris-classifier&quot;</span><span class="p">)</span>

<span class="c1"># Load saved model and make predictions</span>
<span class="n">xgb_classifier_saved</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">pyfunc</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">model_info</span><span class="o">.</span><span class="n">model_uri</span><span class="p">)</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">xgb_classifier_saved</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
</pre></div>
</div>
<p>For more information, see <a class="reference internal" href="python_api/mlflow.xgboost.html#module-mlflow.xgboost" title="mlflow.xgboost"><code class="xref py py-mod docutils literal notranslate"><span class="pre">mlflow.xgboost</span></code></a>.</p>
</div>
</div>
<div class="section" id="lightgbm-lightgbm">
<h3><a class="toc-backref" href="#id44">LightGBM (<code class="docutils literal notranslate"><span class="pre">lightgbm</span></code>)</a><a class="headerlink" href="#lightgbm-lightgbm" title="Permalink to this headline"> </a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">lightgbm</span></code> model flavor enables logging of <a class="reference external" href="https://lightgbm.readthedocs.io/en/latest/pythonapi/lightgbm.Booster.html#lightgbm-booster">LightGBM models</a>
in MLflow format via the <a class="reference internal" href="python_api/mlflow.lightgbm.html#mlflow.lightgbm.save_model" title="mlflow.lightgbm.save_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.lightgbm.save_model()</span></code></a> and <a class="reference internal" href="python_api/mlflow.lightgbm.html#mlflow.lightgbm.log_model" title="mlflow.lightgbm.log_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.lightgbm.log_model()</span></code></a> methods.
These methods also add the <code class="docutils literal notranslate"><span class="pre">python_function</span></code> flavor to the MLflow Models that they produce, allowing the
models to be interpreted as generic Python functions for inference via
<a class="reference internal" href="python_api/mlflow.pyfunc.html#mlflow.pyfunc.load_model" title="mlflow.pyfunc.load_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.pyfunc.load_model()</span></code></a>. You can also use the <a class="reference internal" href="python_api/mlflow.lightgbm.html#mlflow.lightgbm.load_model" title="mlflow.lightgbm.load_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.lightgbm.load_model()</span></code></a>
method to load MLflow Models with the <code class="docutils literal notranslate"><span class="pre">lightgbm</span></code> model flavor in native LightGBM format.</p>
<p>Note that the scikit-learn API for LightGBM is now supported. For more information, see <a class="reference internal" href="python_api/mlflow.lightgbm.html#module-mlflow.lightgbm" title="mlflow.lightgbm"><code class="xref py py-mod docutils literal notranslate"><span class="pre">mlflow.lightgbm</span></code></a>.</p>
<div class="section" id="lightgbm-pyfunc-usage">
<h4><code class="docutils literal notranslate"><span class="pre">LightGBM</span></code> pyfunc usage<a class="headerlink" href="#lightgbm-pyfunc-usage" title="Permalink to this headline"> </a></h4>
<p>The example below</p>
<ul class="simple">
<li><p>Loads the IRIS dataset from <code class="docutils literal notranslate"><span class="pre">scikit-learn</span></code></p></li>
<li><p>Trains a LightGBM <code class="docutils literal notranslate"><span class="pre">LGBMClassifier</span></code></p></li>
<li><p>Logs the model and feature importance’s using <code class="docutils literal notranslate"><span class="pre">mlflow</span></code></p></li>
<li><p>Loads the logged model and makes predictions</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">lightgbm</span> <span class="kn">import</span> <span class="n">LGBMClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">load_iris</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">import</span> <span class="nn">mlflow</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">load_iris</span><span class="p">()</span>

<span class="c1"># Remove special characters from feature names to be able to use them as keys for mlflow metrics</span>
<span class="n">feature_names</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;feature_names&quot;</span><span class="p">]</span>
<span class="p">]</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">],</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span>
<span class="p">)</span>
<span class="c1"># create model instance</span>
<span class="n">lgb_classifier</span> <span class="o">=</span> <span class="n">LGBMClassifier</span><span class="p">(</span>
    <span class="n">n_estimators</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">learning_rate</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">objective</span><span class="o">=</span><span class="s2">&quot;binary:logistic&quot;</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">123</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Fit and save model and LGBMClassifier feature importances as mlflow metrics</span>
<span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">():</span>
    <span class="n">lgb_classifier</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">feature_importances</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">feature_names</span><span class="p">,</span> <span class="n">lgb_classifier</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">))</span>
    <span class="n">feature_importance_metrics</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sa">f</span><span class="s2">&quot;feature_importance_</span><span class="si">{</span><span class="n">feature_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">imp_value</span>
        <span class="k">for</span> <span class="n">feature_name</span><span class="p">,</span> <span class="n">imp_value</span> <span class="ow">in</span> <span class="n">feature_importances</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metrics</span><span class="p">(</span><span class="n">feature_importance_metrics</span><span class="p">)</span>
    <span class="n">model_info</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">lightgbm</span><span class="o">.</span><span class="n">log_model</span><span class="p">(</span><span class="n">lgb_classifier</span><span class="p">,</span> <span class="s2">&quot;iris-classifier&quot;</span><span class="p">)</span>

<span class="c1"># Load saved model and make predictions</span>
<span class="n">lgb_classifier_saved</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">pyfunc</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">model_info</span><span class="o">.</span><span class="n">model_uri</span><span class="p">)</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">lgb_classifier_saved</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="catboost-catboost">
<h3><a class="toc-backref" href="#id45">CatBoost (<code class="docutils literal notranslate"><span class="pre">catboost</span></code>)</a><a class="headerlink" href="#catboost-catboost" title="Permalink to this headline"> </a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">catboost</span></code> model flavor enables logging of <a class="reference external" href="https://catboost.ai/docs/concepts/python-reference_catboost.html">CatBoost models</a>
in MLflow format via the <a class="reference internal" href="python_api/mlflow.catboost.html#mlflow.catboost.save_model" title="mlflow.catboost.save_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.catboost.save_model()</span></code></a> and <a class="reference internal" href="python_api/mlflow.catboost.html#mlflow.catboost.log_model" title="mlflow.catboost.log_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.catboost.log_model()</span></code></a> methods.
These methods also add the <code class="docutils literal notranslate"><span class="pre">python_function</span></code> flavor to the MLflow Models that they produce, allowing the
models to be interpreted as generic Python functions for inference via
<a class="reference internal" href="python_api/mlflow.pyfunc.html#mlflow.pyfunc.load_model" title="mlflow.pyfunc.load_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.pyfunc.load_model()</span></code></a>. You can also use the <a class="reference internal" href="python_api/mlflow.catboost.html#mlflow.catboost.load_model" title="mlflow.catboost.load_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.catboost.load_model()</span></code></a>
method to load MLflow Models with the <code class="docutils literal notranslate"><span class="pre">catboost</span></code> model flavor in native CatBoost format.</p>
<p>For more information, see <a class="reference internal" href="python_api/mlflow.catboost.html#module-mlflow.catboost" title="mlflow.catboost"><code class="xref py py-mod docutils literal notranslate"><span class="pre">mlflow.catboost</span></code></a>.</p>
<div class="section" id="catboost-pyfunc-usage">
<h4><code class="docutils literal notranslate"><span class="pre">CatBoost</span></code> pyfunc usage<a class="headerlink" href="#catboost-pyfunc-usage" title="Permalink to this headline"> </a></h4>
<p>For a CatBoost Classifier model, an example configuration for the pyfunc predict() method is:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mlflow</span>
<span class="kn">from</span> <span class="nn">catboost</span> <span class="kn">import</span> <span class="n">CatBoostClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">datasets</span>

<span class="c1"># prepare data</span>
<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">load_wine</span><span class="p">(</span><span class="n">as_frame</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_X_y</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># train the model</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">CatBoostClassifier</span><span class="p">(</span>
    <span class="n">iterations</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">loss_function</span><span class="o">=</span><span class="s2">&quot;MultiClass&quot;</span><span class="p">,</span>
    <span class="n">allow_writing_files</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="c1"># log the model into a mlflow run</span>
<span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">():</span>
    <span class="n">model_info</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">catboost</span><span class="o">.</span><span class="n">log_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">)</span>

<span class="c1"># load the logged model and make a prediction</span>
<span class="n">catboost_pyfunc</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">pyfunc</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">model_uri</span><span class="o">=</span><span class="n">model_info</span><span class="o">.</span><span class="n">model_uri</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">catboost_pyfunc</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">[:</span><span class="mi">5</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="spacy-spacy">
<h3><a class="toc-backref" href="#id46">Spacy(<code class="docutils literal notranslate"><span class="pre">spaCy</span></code>)</a><a class="headerlink" href="#spacy-spacy" title="Permalink to this headline"> </a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">spaCy</span></code> model flavor enables logging of <a class="reference external" href="https://spacy.io/models">spaCy models</a> in MLflow format via
the <a class="reference internal" href="python_api/mlflow.spacy.html#mlflow.spacy.save_model" title="mlflow.spacy.save_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.spacy.save_model()</span></code></a> and <a class="reference internal" href="python_api/mlflow.spacy.html#mlflow.spacy.log_model" title="mlflow.spacy.log_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.spacy.log_model()</span></code></a> methods. Additionally, these
methods add the <code class="docutils literal notranslate"><span class="pre">python_function</span></code> flavor to the MLflow Models that they produce, allowing the models to be
interpreted as generic Python functions for inference via <a class="reference internal" href="python_api/mlflow.pyfunc.html#mlflow.pyfunc.load_model" title="mlflow.pyfunc.load_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.pyfunc.load_model()</span></code></a>.
This loaded PyFunc model can only be scored with DataFrame input. You can
also use the <a class="reference internal" href="python_api/mlflow.spacy.html#mlflow.spacy.load_model" title="mlflow.spacy.load_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.spacy.load_model()</span></code></a> method to load MLflow Models with the <code class="docutils literal notranslate"><span class="pre">spacy</span></code> model flavor
in native spaCy format.</p>
<p>For more information, see <a class="reference internal" href="python_api/mlflow.spacy.html#module-mlflow.spacy" title="mlflow.spacy"><code class="xref py py-mod docutils literal notranslate"><span class="pre">mlflow.spacy</span></code></a>.</p>
<div class="section" id="spacy-pyfunc-usage">
<h4><code class="docutils literal notranslate"><span class="pre">Spacy</span></code> pyfunc usage<a class="headerlink" href="#spacy-pyfunc-usage" title="Permalink to this headline"> </a></h4>
<p>The example below shows how to train a <code class="docutils literal notranslate"><span class="pre">Spacy</span></code> <code class="docutils literal notranslate"><span class="pre">TextCategorizer</span></code> model, log the model artifact and metrics to the
mlflow tracking server and then load the saved model to make predictions. For this example, we will be using the
<code class="docutils literal notranslate"><span class="pre">Polarity</span> <span class="pre">2.0</span></code> dataset available in the <code class="docutils literal notranslate"><span class="pre">nltk</span></code> package. This dataset consists of 10000 positive and 10000 negative
short movie reviews.</p>
<p>First we convert the texts and sentiment labels (“pos” or “neg”) from NLTK native format to <code class="docutils literal notranslate"><span class="pre">Spacy</span></code>’s <code class="docutils literal notranslate"><span class="pre">DocBin</span></code> format:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">spacy</span>
<span class="kn">from</span> <span class="nn">nltk.corpus</span> <span class="kn">import</span> <span class="n">movie_reviews</span>
<span class="kn">from</span> <span class="nn">spacy</span> <span class="kn">import</span> <span class="n">Language</span>
<span class="kn">from</span> <span class="nn">spacy.tokens</span> <span class="kn">import</span> <span class="n">DocBin</span>

<span class="n">nltk</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s2">&quot;movie_reviews&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_sentences</span><span class="p">(</span><span class="n">sentiment_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reconstruct the sentences from the word lists for each review record for a specific ``sentiment_type``</span>
<span class="sd">    as a pandas DataFrame with two columns: &#39;sentence&#39; and &#39;sentiment&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">file_ids</span> <span class="o">=</span> <span class="n">movie_reviews</span><span class="o">.</span><span class="n">fileids</span><span class="p">(</span><span class="n">sentiment_type</span><span class="p">)</span>
    <span class="n">sent_df</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">file_id</span> <span class="ow">in</span> <span class="n">file_ids</span><span class="p">:</span>
        <span class="n">sentence</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">movie_reviews</span><span class="o">.</span><span class="n">words</span><span class="p">(</span><span class="n">file_id</span><span class="p">))</span>
        <span class="n">sent_df</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;sentence&quot;</span><span class="p">:</span> <span class="n">sentence</span><span class="p">,</span> <span class="s2">&quot;sentiment&quot;</span><span class="p">:</span> <span class="n">sentiment_type</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">sent_df</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">convert</span><span class="p">(</span><span class="n">data_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">target_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert a DataFrame with &#39;sentence&#39; and &#39;sentiment&#39; columns to a</span>
<span class="sd">    spacy DocBin object and save it to &#39;target_file&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nlp</span> <span class="o">=</span> <span class="n">spacy</span><span class="o">.</span><span class="n">blank</span><span class="p">(</span><span class="s2">&quot;en&quot;</span><span class="p">)</span>
    <span class="n">sentiment_labels</span> <span class="o">=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">sentiment</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="n">spacy_doc</span> <span class="o">=</span> <span class="n">DocBin</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">sent_tokens</span> <span class="o">=</span> <span class="n">nlp</span><span class="o">.</span><span class="n">make_doc</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;sentence&quot;</span><span class="p">])</span>
        <span class="c1"># To train a Spacy TextCategorizer model, the label must be attached to the &quot;cats&quot; dictionary of the &quot;Doc&quot;</span>
        <span class="c1"># object, e.g. {&quot;pos&quot;: 1.0, &quot;neg&quot;: 0.0} for a &quot;pos&quot; label.</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">sentiment_labels</span><span class="p">:</span>
            <span class="n">sent_tokens</span><span class="o">.</span><span class="n">cats</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;sentiment&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="mf">0.0</span>
        <span class="n">spacy_doc</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sent_tokens</span><span class="p">)</span>

    <span class="n">spacy_doc</span><span class="o">.</span><span class="n">to_disk</span><span class="p">(</span><span class="n">target_file</span><span class="p">)</span>


<span class="c1"># Build a single DataFrame with both positive and negative reviews, one row per review</span>
<span class="n">review_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_sentences</span><span class="p">(</span><span class="n">sentiment_type</span><span class="p">)</span> <span class="k">for</span> <span class="n">sentiment_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;pos&quot;</span><span class="p">,</span> <span class="s2">&quot;neg&quot;</span><span class="p">)]</span>
<span class="n">review_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">review_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># Split the DataFrame into a train and a dev set</span>
<span class="n">train_df</span> <span class="o">=</span> <span class="n">review_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;sentiment&quot;</span><span class="p">,</span> <span class="n">group_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">dev_df</span> <span class="o">=</span> <span class="n">review_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">review_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">train_df</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="p">:]</span>

<span class="c1"># Save the train and dev data files to the current directory as &quot;corpora.train&quot; and &quot;corpora.dev&quot;, respectively</span>
<span class="n">convert</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="s2">&quot;corpora.train&quot;</span><span class="p">)</span>
<span class="n">convert</span><span class="p">(</span><span class="n">dev_df</span><span class="p">,</span> <span class="s2">&quot;corpora.dev&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>To set up the training job, we first need to generate a configuration file as described in the <a class="reference external" href="https://spacy.io/usage/training#config">Spacy Documentation</a>
For simplicity, we will only use a <code class="docutils literal notranslate"><span class="pre">TextCategorizer</span></code> in the pipeline.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">python -m spacy init config --pipeline textcat --lang en mlflow-textcat.cfg</span>
</pre></div>
</div>
<p>Change the default train and dev paths in the config file to the current directory:</p>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="w"> </span> [paths]
<span class="gd">- train = null</span>
<span class="gd">- dev = null</span>
<span class="gi">+ train = &quot;.&quot;</span>
<span class="gi">+ dev = &quot;.&quot;</span>
</pre></div>
</div>
<p>In <code class="docutils literal notranslate"><span class="pre">Spacy</span></code>, the training loop is defined internally in Spacy’s code. Spacy provides a “logging” extension point where
we can use <code class="docutils literal notranslate"><span class="pre">mlflow</span></code>. To do this,</p>
<ul class="simple">
<li><p>We have to define a function to write metrics / model input to <code class="docutils literal notranslate"><span class="pre">mlfow</span></code></p></li>
<li><p>Register it as a logger in <code class="docutils literal notranslate"><span class="pre">Spacy</span></code>’s component registry</p></li>
<li><p>Change the default console logger in the <code class="docutils literal notranslate"><span class="pre">Spacy</span></code>’s configuration file (<code class="docutils literal notranslate"><span class="pre">mlflow-textcat.cfg</span></code>)</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">IO</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">import</span> <span class="nn">spacy</span>
<span class="kn">from</span> <span class="nn">spacy</span> <span class="kn">import</span> <span class="n">Language</span>
<span class="kn">import</span> <span class="nn">mlflow</span>


<span class="nd">@spacy</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">loggers</span><span class="p">(</span><span class="s2">&quot;mlflow_logger.v1&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">mlflow_logger</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns a function, ``setup_logger`` that returns two functions:</span>

<span class="sd">    * ``log_step`` is called internally by Spacy for every evaluation step. We can log the intermediate train and</span>
<span class="sd">    validation scores to the mlflow tracking server here.</span>
<span class="sd">    * ``finalize``: is called internally by Spacy after training is complete. We can log the model artifact to the</span>
<span class="sd">    mlflow tracking server here.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">setup_logger</span><span class="p">(</span>
        <span class="n">nlp</span><span class="p">:</span> <span class="n">Language</span><span class="p">,</span>
        <span class="n">stdout</span><span class="p">:</span> <span class="n">IO</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span>
        <span class="n">stderr</span><span class="p">:</span> <span class="n">IO</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]:</span>
        <span class="k">def</span> <span class="nf">log_step</span><span class="p">(</span><span class="n">info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]):</span>
            <span class="k">if</span> <span class="n">info</span><span class="p">:</span>
                <span class="n">step</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">]</span>
                <span class="n">score</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;score&quot;</span><span class="p">]</span>
                <span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>

                <span class="k">for</span> <span class="n">pipe_name</span> <span class="ow">in</span> <span class="n">nlp</span><span class="o">.</span><span class="n">pipe_names</span><span class="p">:</span>
                    <span class="n">loss</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;losses&quot;</span><span class="p">][</span><span class="n">pipe_name</span><span class="p">]</span>
                    <span class="n">metrics</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pipe_name</span><span class="si">}</span><span class="s2">_loss&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loss</span>
                    <span class="n">metrics</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pipe_name</span><span class="si">}</span><span class="s2">_score&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">score</span>
                <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metrics</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">finalize</span><span class="p">():</span>
            <span class="n">uri</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">spacy</span><span class="o">.</span><span class="n">log_model</span><span class="p">(</span><span class="n">nlp</span><span class="p">,</span> <span class="s2">&quot;mlflow_textcat_example&quot;</span><span class="p">)</span>
            <span class="n">mlflow</span><span class="o">.</span><span class="n">end_run</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">log_step</span><span class="p">,</span> <span class="n">finalize</span>

    <span class="k">return</span> <span class="n">setup_logger</span>
</pre></div>
</div>
<p>Check the <cite>spacy-loggers library &lt;https://pypi.org/project/spacy-loggers/&gt;</cite> _ for a more complete implementation.</p>
<p>Point to our mlflow logger in <code class="docutils literal notranslate"><span class="pre">Spacy</span></code> configuration file. For this example, we will lower the number of training steps
and eval frequency:</p>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="w"> </span> [training.logger]
<span class="gd">- @loggers = &quot;spacy.ConsoleLogger.v1&quot;</span>
<span class="gd">- dev = null</span>
<span class="gi">+ @loggers = &quot;mlflow_logger.v1&quot;</span>

<span class="w"> </span> [training]
<span class="gd">- max_steps = 20000</span>
<span class="gd">- eval_frequency = 100</span>
<span class="gi">+ max_steps = 100</span>
<span class="gi">+ eval_frequency = 10</span>
</pre></div>
</div>
<p>Train our model:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">spacy.cli.train</span> <span class="kn">import</span> <span class="n">train</span> <span class="k">as</span> <span class="n">spacy_train</span>

<span class="n">spacy_train</span><span class="p">(</span><span class="s2">&quot;mlflow-textcat.cfg&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>To make predictions, we load the saved model from the last run:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mlflow</span> <span class="kn">import</span> <span class="n">MlflowClient</span>

<span class="c1"># look up the last run info from mlflow</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">MlflowClient</span><span class="p">()</span>
<span class="n">last_run</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">search_runs</span><span class="p">(</span><span class="n">experiment_ids</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;0&quot;</span><span class="p">],</span> <span class="n">max_results</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># We need to append the spacy model directory name to the artifact uri</span>
<span class="n">spacy_model</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">pyfunc</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">last_run</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">artifact_uri</span><span class="si">}</span><span class="s2">/mlflow_textcat_example&quot;</span>
<span class="p">)</span>
<span class="n">predictions_in</span> <span class="o">=</span> <span class="n">dev_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s2">&quot;sentence&quot;</span><span class="p">]]</span>
<span class="n">predictions_out</span> <span class="o">=</span> <span class="n">spacy_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">predictions_in</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">predicted_labels</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;pos&quot;</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;pos&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;neg&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;neg&quot;</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">predictions_out</span>
<span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dev_df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">predicted_sentiment</span><span class="o">=</span><span class="n">predicted_labels</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="fastai-fastai">
<h3><a class="toc-backref" href="#id47">Fastai(<code class="docutils literal notranslate"><span class="pre">fastai</span></code>)</a><a class="headerlink" href="#fastai-fastai" title="Permalink to this headline"> </a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">fastai</span></code> model flavor enables logging of <a class="reference external" href="https://docs.fast.ai/learner.html">fastai Learner models</a> in MLflow format via
the <a class="reference internal" href="python_api/mlflow.fastai.html#mlflow.fastai.save_model" title="mlflow.fastai.save_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.fastai.save_model()</span></code></a> and <a class="reference internal" href="python_api/mlflow.fastai.html#mlflow.fastai.log_model" title="mlflow.fastai.log_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.fastai.log_model()</span></code></a> methods. Additionally, these
methods add the <code class="docutils literal notranslate"><span class="pre">python_function</span></code> flavor to the MLflow Models that they produce, allowing the models to be
interpreted as generic Python functions for inference via <a class="reference internal" href="python_api/mlflow.pyfunc.html#mlflow.pyfunc.load_model" title="mlflow.pyfunc.load_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.pyfunc.load_model()</span></code></a>. This loaded PyFunc model can
only be scored with DataFrame input. You can also use the <a class="reference internal" href="python_api/mlflow.fastai.html#mlflow.fastai.load_model" title="mlflow.fastai.load_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.fastai.load_model()</span></code></a> method to
load MLflow Models with the <code class="docutils literal notranslate"><span class="pre">fastai</span></code> model flavor in native fastai format.</p>
<p>The interface for utilizing a <code class="docutils literal notranslate"><span class="pre">fastai</span></code> model loaded as a pyfunc type for generating predictions uses a
Pandas DataFrame argument.</p>
<p>This example runs the <a class="reference external" href="https://docs.fast.ai/tutorial.tabular.html">fastai tabular tutorial</a>,
logs the experiments, saves the model in <code class="docutils literal notranslate"><span class="pre">fastai</span></code> format and loads the model to get predictions
using a <code class="docutils literal notranslate"><span class="pre">fastai</span></code> data loader:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">fastai.data.external</span> <span class="kn">import</span> <span class="n">URLs</span><span class="p">,</span> <span class="n">untar_data</span>
<span class="kn">from</span> <span class="nn">fastai.tabular.core</span> <span class="kn">import</span> <span class="n">Categorify</span><span class="p">,</span> <span class="n">FillMissing</span><span class="p">,</span> <span class="n">Normalize</span><span class="p">,</span> <span class="n">TabularPandas</span>
<span class="kn">from</span> <span class="nn">fastai.tabular.data</span> <span class="kn">import</span> <span class="n">TabularDataLoaders</span>
<span class="kn">from</span> <span class="nn">fastai.tabular.learner</span> <span class="kn">import</span> <span class="n">tabular_learner</span>
<span class="kn">from</span> <span class="nn">fastai.data.transforms</span> <span class="kn">import</span> <span class="n">RandomSplitter</span>
<span class="kn">from</span> <span class="nn">fastai.metrics</span> <span class="kn">import</span> <span class="n">accuracy</span>
<span class="kn">from</span> <span class="nn">fastcore.basics</span> <span class="kn">import</span> <span class="n">range_of</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">mlflow</span>
<span class="kn">import</span> <span class="nn">mlflow.fastai</span>


<span class="k">def</span> <span class="nf">print_auto_logged_info</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
    <span class="n">tags</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;mlflow.&quot;</span><span class="p">)}</span>
    <span class="n">artifacts</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">f</span><span class="o">.</span><span class="n">path</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">MlflowClient</span><span class="p">()</span><span class="o">.</span><span class="n">list_artifacts</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">run_id</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;run_id: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">run_id</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;artifacts: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">artifacts</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;params: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">params</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;metrics: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">metrics</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;tags: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tags</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">epochs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">untar_data</span><span class="p">(</span><span class="n">URLs</span><span class="o">.</span><span class="n">ADULT_SAMPLE</span><span class="p">)</span>
    <span class="n">path</span><span class="o">.</span><span class="n">ls</span><span class="p">()</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;adult.csv&quot;</span><span class="p">)</span>

    <span class="n">dls</span> <span class="o">=</span> <span class="n">TabularDataLoaders</span><span class="o">.</span><span class="n">from_csv</span><span class="p">(</span>
        <span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;adult.csv&quot;</span><span class="p">,</span>
        <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
        <span class="n">y_names</span><span class="o">=</span><span class="s2">&quot;salary&quot;</span><span class="p">,</span>
        <span class="n">cat_names</span><span class="o">=</span><span class="p">[</span>
            <span class="s2">&quot;workclass&quot;</span><span class="p">,</span>
            <span class="s2">&quot;education&quot;</span><span class="p">,</span>
            <span class="s2">&quot;marital-status&quot;</span><span class="p">,</span>
            <span class="s2">&quot;occupation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;relationship&quot;</span><span class="p">,</span>
            <span class="s2">&quot;race&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="n">cont_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="s2">&quot;fnlwgt&quot;</span><span class="p">,</span> <span class="s2">&quot;education-num&quot;</span><span class="p">],</span>
        <span class="n">procs</span><span class="o">=</span><span class="p">[</span><span class="n">Categorify</span><span class="p">,</span> <span class="n">FillMissing</span><span class="p">,</span> <span class="n">Normalize</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="n">splits</span> <span class="o">=</span> <span class="n">RandomSplitter</span><span class="p">(</span><span class="n">valid_pct</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)(</span><span class="n">range_of</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>

    <span class="n">to</span> <span class="o">=</span> <span class="n">TabularPandas</span><span class="p">(</span>
        <span class="n">df</span><span class="p">,</span>
        <span class="n">procs</span><span class="o">=</span><span class="p">[</span><span class="n">Categorify</span><span class="p">,</span> <span class="n">FillMissing</span><span class="p">,</span> <span class="n">Normalize</span><span class="p">],</span>
        <span class="n">cat_names</span><span class="o">=</span><span class="p">[</span>
            <span class="s2">&quot;workclass&quot;</span><span class="p">,</span>
            <span class="s2">&quot;education&quot;</span><span class="p">,</span>
            <span class="s2">&quot;marital-status&quot;</span><span class="p">,</span>
            <span class="s2">&quot;occupation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;relationship&quot;</span><span class="p">,</span>
            <span class="s2">&quot;race&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="n">cont_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="s2">&quot;fnlwgt&quot;</span><span class="p">,</span> <span class="s2">&quot;education-num&quot;</span><span class="p">],</span>
        <span class="n">y_names</span><span class="o">=</span><span class="s2">&quot;salary&quot;</span><span class="p">,</span>
        <span class="n">splits</span><span class="o">=</span><span class="n">splits</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">dls</span> <span class="o">=</span> <span class="n">to</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">(</span><span class="n">bs</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">tabular_learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">accuracy</span><span class="p">)</span>

    <span class="n">mlflow</span><span class="o">.</span><span class="n">fastai</span><span class="o">.</span><span class="n">autolog</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">()</span> <span class="k">as</span> <span class="n">run</span><span class="p">:</span>
        <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">fastai</span><span class="o">.</span><span class="n">log_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">)</span>

    <span class="n">print_auto_logged_info</span><span class="p">(</span><span class="n">mlflow</span><span class="o">.</span><span class="n">get_run</span><span class="p">(</span><span class="n">run_id</span><span class="o">=</span><span class="n">run</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">run_id</span><span class="p">))</span>

    <span class="n">model_uri</span> <span class="o">=</span> <span class="s2">&quot;runs:/</span><span class="si">{}</span><span class="s2">/model&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">run_id</span><span class="p">)</span>
    <span class="n">loaded_model</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">fastai</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">model_uri</span><span class="p">)</span>

    <span class="n">test_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">test_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;salary&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">dl</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">dls</span><span class="o">.</span><span class="n">test_dl</span><span class="p">(</span><span class="n">test_df</span><span class="p">)</span>

    <span class="n">predictions</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">loaded_model</span><span class="o">.</span><span class="n">get_preds</span><span class="p">(</span><span class="n">dl</span><span class="o">=</span><span class="n">dl</span><span class="p">)</span>
    <span class="n">px</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float&quot;</span><span class="p">)</span>
    <span class="n">px</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>


<span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>Output (<code class="docutils literal notranslate"><span class="pre">Pandas</span> <span class="pre">DataFrame</span></code>):</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 44%" />
<col style="width: 46%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Index</p></th>
<th class="head"><p>Probability of first class</p></th>
<th class="head"><p>Probability of second class</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0</p></td>
<td><p>0.545088</p></td>
<td><p>0.454912</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>0.503172</p></td>
<td><p>0.496828</p></td>
</tr>
<tr class="row-even"><td><p>2</p></td>
<td><p>0.962663</p></td>
<td><p>0.037337</p></td>
</tr>
<tr class="row-odd"><td><p>3</p></td>
<td><p>0.206107</p></td>
<td><p>0.793893</p></td>
</tr>
<tr class="row-even"><td><p>4</p></td>
<td><p>0.807599</p></td>
<td><p>0.192401</p></td>
</tr>
</tbody>
</table>
<p>Alternatively, when using the <code class="docutils literal notranslate"><span class="pre">python_function</span></code> flavor, get predictions from a DataFrame.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">fastai.data.external</span> <span class="kn">import</span> <span class="n">URLs</span><span class="p">,</span> <span class="n">untar_data</span>
<span class="kn">from</span> <span class="nn">fastai.tabular.core</span> <span class="kn">import</span> <span class="n">Categorify</span><span class="p">,</span> <span class="n">FillMissing</span><span class="p">,</span> <span class="n">Normalize</span><span class="p">,</span> <span class="n">TabularPandas</span>
<span class="kn">from</span> <span class="nn">fastai.tabular.data</span> <span class="kn">import</span> <span class="n">TabularDataLoaders</span>
<span class="kn">from</span> <span class="nn">fastai.tabular.learner</span> <span class="kn">import</span> <span class="n">tabular_learner</span>
<span class="kn">from</span> <span class="nn">fastai.data.transforms</span> <span class="kn">import</span> <span class="n">RandomSplitter</span>
<span class="kn">from</span> <span class="nn">fastai.metrics</span> <span class="kn">import</span> <span class="n">accuracy</span>
<span class="kn">from</span> <span class="nn">fastcore.basics</span> <span class="kn">import</span> <span class="n">range_of</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">mlflow</span>
<span class="kn">import</span> <span class="nn">mlflow.fastai</span>

<span class="n">model_uri</span> <span class="o">=</span> <span class="o">...</span>

<span class="n">path</span> <span class="o">=</span> <span class="n">untar_data</span><span class="p">(</span><span class="n">URLs</span><span class="o">.</span><span class="n">ADULT_SAMPLE</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;adult.csv&quot;</span><span class="p">)</span>
<span class="n">test_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">test_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;salary&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">loaded_model</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">pyfunc</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">model_uri</span><span class="p">)</span>
<span class="n">loaded_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_df</span><span class="p">)</span>
</pre></div>
</div>
<p>Output (<code class="docutils literal notranslate"><span class="pre">Pandas</span> <span class="pre">DataFrame</span></code>):</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Index</p></th>
<th class="head"><p>Probability of first class, Probability of second class</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0</p></td>
<td><p>[0.5450878, 0.45491222]</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>[0.50317234, 0.49682766]</p></td>
</tr>
<tr class="row-even"><td><p>2</p></td>
<td><p>[0.9626626, 0.037337445]</p></td>
</tr>
<tr class="row-odd"><td><p>3</p></td>
<td><p>[0.20610662, 0.7938934]</p></td>
</tr>
<tr class="row-even"><td><p>4</p></td>
<td><p>[0.8075987, 0.19240129]</p></td>
</tr>
</tbody>
</table>
<p>For more information, see <a class="reference internal" href="python_api/mlflow.fastai.html#module-mlflow.fastai" title="mlflow.fastai"><code class="xref py py-mod docutils literal notranslate"><span class="pre">mlflow.fastai</span></code></a>.</p>
</div>
<div class="section" id="statsmodels-statsmodels">
<h3><a class="toc-backref" href="#id48">Statsmodels (<code class="docutils literal notranslate"><span class="pre">statsmodels</span></code>)</a><a class="headerlink" href="#statsmodels-statsmodels" title="Permalink to this headline"> </a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">statsmodels</span></code> model flavor enables logging of <a class="reference external" href="https://www.statsmodels.org/stable/api.html">Statsmodels models</a> in MLflow format via the <a class="reference internal" href="python_api/mlflow.statsmodels.html#mlflow.statsmodels.save_model" title="mlflow.statsmodels.save_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.statsmodels.save_model()</span></code></a>
and <a class="reference internal" href="python_api/mlflow.statsmodels.html#mlflow.statsmodels.log_model" title="mlflow.statsmodels.log_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.statsmodels.log_model()</span></code></a> methods.
These methods also add the <code class="docutils literal notranslate"><span class="pre">python_function</span></code> flavor to the MLflow Models that they produce, allowing the
models to be interpreted as generic Python functions for inference via
<a class="reference internal" href="python_api/mlflow.pyfunc.html#mlflow.pyfunc.load_model" title="mlflow.pyfunc.load_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.pyfunc.load_model()</span></code></a>. This loaded PyFunc model can only be scored with DataFrame input.
You can also use the <a class="reference internal" href="python_api/mlflow.statsmodels.html#mlflow.statsmodels.load_model" title="mlflow.statsmodels.load_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.statsmodels.load_model()</span></code></a>
method to load MLflow Models with the <code class="docutils literal notranslate"><span class="pre">statsmodels</span></code> model flavor in native statsmodels format.</p>
<p>As for now, automatic logging is restricted to parameters, metrics and models generated by a call to <cite>fit</cite>
on a <code class="docutils literal notranslate"><span class="pre">statsmodels</span></code> model.</p>
<p>For more information, see <a class="reference internal" href="python_api/mlflow.statsmodels.html#module-mlflow.statsmodels" title="mlflow.statsmodels"><code class="xref py py-mod docutils literal notranslate"><span class="pre">mlflow.statsmodels</span></code></a>.</p>
</div>
<div class="section" id="prophet-prophet">
<h3><a class="toc-backref" href="#id49">Prophet (<code class="docutils literal notranslate"><span class="pre">prophet</span></code>)</a><a class="headerlink" href="#prophet-prophet" title="Permalink to this headline"> </a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">prophet</span></code> model flavor enables logging of <a class="reference external" href="https://facebook.github.io/prophet/">Prophet models</a> in MLflow format via the <a class="reference internal" href="python_api/mlflow.prophet.html#mlflow.prophet.save_model" title="mlflow.prophet.save_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.prophet.save_model()</span></code></a>
and <a class="reference internal" href="python_api/mlflow.prophet.html#mlflow.prophet.log_model" title="mlflow.prophet.log_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.prophet.log_model()</span></code></a> methods.
These methods also add the <code class="docutils literal notranslate"><span class="pre">python_function</span></code> flavor to the MLflow Models that they produce, allowing the
models to be interpreted as generic Python functions for inference via
<a class="reference internal" href="python_api/mlflow.pyfunc.html#mlflow.pyfunc.load_model" title="mlflow.pyfunc.load_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.pyfunc.load_model()</span></code></a>. This loaded PyFunc model can only be scored with DataFrame input.
You can also use the <a class="reference internal" href="python_api/mlflow.prophet.html#mlflow.prophet.load_model" title="mlflow.prophet.load_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.prophet.load_model()</span></code></a>
method to load MLflow Models with the <code class="docutils literal notranslate"><span class="pre">prophet</span></code> model flavor in native prophet format.</p>
<div class="section" id="prophet-pyfunc-usage">
<h4>Prophet pyfunc usage<a class="headerlink" href="#prophet-pyfunc-usage" title="Permalink to this headline"> </a></h4>
<p>This example uses a time series dataset from Prophet’s GitHub repository, containing log number of daily views to
Peyton Manning’s Wikipedia page for several years. A sample of the dataset is as follows:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 43%" />
<col style="width: 57%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>ds</p></th>
<th class="head"><p>y</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>2007-12-10</p></td>
<td><p>9.59076113897809</p></td>
</tr>
<tr class="row-odd"><td><p>2007-12-11</p></td>
<td><p>8.51959031601596</p></td>
</tr>
<tr class="row-even"><td><p>2007-12-12</p></td>
<td><p>8.18367658262066</p></td>
</tr>
<tr class="row-odd"><td><p>2007-12-13</p></td>
<td><p>8.07246736935477</p></td>
</tr>
</tbody>
</table>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">prophet</span> <span class="kn">import</span> <span class="n">Prophet</span>
<span class="kn">from</span> <span class="nn">prophet.diagnostics</span> <span class="kn">import</span> <span class="n">cross_validation</span><span class="p">,</span> <span class="n">performance_metrics</span>

<span class="kn">import</span> <span class="nn">mlflow</span>

<span class="c1"># starts on 2007-12-10, ends on 2016-01-20</span>
<span class="n">train_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="s2">&quot;https://raw.githubusercontent.com/facebook/prophet/main/examples/example_wp_log_peyton_manning.csv&quot;</span>
<span class="p">)</span>

<span class="c1"># Create a &quot;test&quot; DataFrame with the &quot;ds&quot; column containing 10 days after the end date in train_df</span>
<span class="n">test_dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s2">&quot;2016-01-21&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;2016-01-31&quot;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;D&quot;</span><span class="p">)</span>
<span class="n">test_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">test_dates</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;ds&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span>

<span class="n">prophet_model</span> <span class="o">=</span> <span class="n">Prophet</span><span class="p">(</span><span class="n">changepoint_prior_scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">uncertainty_samples</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>

<span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">():</span>
    <span class="n">prophet_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_df</span><span class="p">)</span>

    <span class="c1"># extract and log parameters such as changepoint_prior_scale in the mlflow run</span>
    <span class="n">model_params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">(</span><span class="n">prophet_model</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_params</span><span class="p">(</span><span class="n">model_params</span><span class="p">)</span>

    <span class="c1"># cross validate with 900 days of data initially, predictions for next 30 days</span>
    <span class="c1"># walk forward by 30 days</span>
    <span class="n">cv_results</span> <span class="o">=</span> <span class="n">cross_validation</span><span class="p">(</span>
        <span class="n">prophet_model</span><span class="p">,</span> <span class="n">initial</span><span class="o">=</span><span class="s2">&quot;900 days&quot;</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="s2">&quot;30 days&quot;</span><span class="p">,</span> <span class="n">horizon</span><span class="o">=</span><span class="s2">&quot;30 days&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Calculate metrics from cv_results, then average each metric across all backtesting windows and log to mlflow</span>
    <span class="n">cv_metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;mse&quot;</span><span class="p">,</span> <span class="s2">&quot;rmse&quot;</span><span class="p">,</span> <span class="s2">&quot;mape&quot;</span><span class="p">]</span>
    <span class="n">metrics_results</span> <span class="o">=</span> <span class="n">performance_metrics</span><span class="p">(</span><span class="n">cv_results</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">cv_metrics</span><span class="p">)</span>
    <span class="n">average_metrics</span> <span class="o">=</span> <span class="n">metrics_results</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">cv_metrics</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metrics</span><span class="p">(</span><span class="n">average_metrics</span><span class="p">)</span>
    <span class="n">model_info</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">prophet</span><span class="o">.</span><span class="n">log_model</span><span class="p">(</span><span class="n">prophet_model</span><span class="p">,</span> <span class="s2">&quot;prophet-model&quot;</span><span class="p">)</span>

<span class="c1"># Load saved model</span>
<span class="n">prophet_model_saved</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">pyfunc</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">model_info</span><span class="o">.</span><span class="n">model_uri</span><span class="p">)</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">prophet_model_saved</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_df</span><span class="p">)</span>
</pre></div>
</div>
<p>Output (<code class="docutils literal notranslate"><span class="pre">Pandas</span> <span class="pre">DataFrame</span></code>):</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 21%" />
<col style="width: 23%" />
<col style="width: 25%" />
<col style="width: 21%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Index</p></th>
<th class="head"><p>ds</p></th>
<th class="head"><p>yhat</p></th>
<th class="head"><p>yhat_upper</p></th>
<th class="head"><p>yhat_lower</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0</p></td>
<td><p>2016-01-21</p></td>
<td><p>8.526513</p></td>
<td><p>8.827397</p></td>
<td><p>8.328563</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>2016-01-22</p></td>
<td><p>8.541355</p></td>
<td><p>9.434994</p></td>
<td><p>8.112758</p></td>
</tr>
<tr class="row-even"><td><p>2</p></td>
<td><p>2016-01-23</p></td>
<td><p>8.308332</p></td>
<td><p>8.633746</p></td>
<td><p>8.201323</p></td>
</tr>
<tr class="row-odd"><td><p>3</p></td>
<td><p>2016-01-24</p></td>
<td><p>8.676326</p></td>
<td><p>9.534593</p></td>
<td><p>8.020874</p></td>
</tr>
<tr class="row-even"><td><p>4</p></td>
<td><p>2016-01-25</p></td>
<td><p>8.983457</p></td>
<td><p>9.430136</p></td>
<td><p>8.121798</p></td>
</tr>
</tbody>
</table>
<p>For more information, see <a class="reference internal" href="python_api/mlflow.prophet.html#module-mlflow.prophet" title="mlflow.prophet"><code class="xref py py-mod docutils literal notranslate"><span class="pre">mlflow.prophet</span></code></a>.</p>
</div>
</div>
<div class="section" id="pmdarima-pmdarima">
<h3><a class="toc-backref" href="#id50">Pmdarima (<code class="docutils literal notranslate"><span class="pre">pmdarima</span></code>)</a><a class="headerlink" href="#pmdarima-pmdarima" title="Permalink to this headline"> </a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">pmdarima</span></code> model flavor enables logging of <a class="reference external" href="http://alkaline-ml.com/pmdarima/">pmdarima models</a> in MLflow
format via the <a class="reference internal" href="python_api/mlflow.pmdarima.html#mlflow.pmdarima.save_model" title="mlflow.pmdarima.save_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.pmdarima.save_model()</span></code></a> and <a class="reference internal" href="python_api/mlflow.pmdarima.html#mlflow.pmdarima.log_model" title="mlflow.pmdarima.log_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.pmdarima.log_model()</span></code></a> methods.
These methods also add the <code class="docutils literal notranslate"><span class="pre">python_function</span></code> flavor to the MLflow Models that they produce, allowing the
model to be interpreted as generic Python functions for inference via <a class="reference internal" href="python_api/mlflow.pyfunc.html#mlflow.pyfunc.load_model" title="mlflow.pyfunc.load_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.pyfunc.load_model()</span></code></a>.
This loaded PyFunc model can only be scored with a DataFrame input.
You can also use the <a class="reference internal" href="python_api/mlflow.pmdarima.html#mlflow.pmdarima.load_model" title="mlflow.pmdarima.load_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.pmdarima.load_model()</span></code></a> method to load MLflow Models with the <code class="docutils literal notranslate"><span class="pre">pmdarima</span></code>
model flavor in native pmdarima formats.</p>
<p>The interface for utilizing a <code class="docutils literal notranslate"><span class="pre">pmdarima</span></code> model loaded as a <code class="docutils literal notranslate"><span class="pre">pyfunc</span></code> type for generating forecast predictions uses
a <em>single-row</em> <code class="docutils literal notranslate"><span class="pre">Pandas</span> <span class="pre">DataFrame</span></code> configuration argument. The following columns in this configuration
<code class="docutils literal notranslate"><span class="pre">Pandas</span> <span class="pre">DataFrame</span></code> are supported:</p>
<ul class="simple">
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">n_periods</span></code> (required) - specifies the number of future periods to generate starting from the last datetime value</dt><dd><p>of the training dataset, utilizing the frequency of the input training series when the model was trained.
(for example, if the training data series elements represent one value per hour, in order to forecast 3 days of
future data, set the column <code class="docutils literal notranslate"><span class="pre">n_periods</span></code> to <code class="docutils literal notranslate"><span class="pre">72</span></code>.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">X</span></code> (optional) - exogenous regressor values (<em>only supported in pmdarima version &gt;= 1.8.0</em>) a 2D array of values for</dt><dd><p>future time period events. For more information, read the underlying library
<a class="reference external" href="https://www.statsmodels.org/stable/endog_exog.html">explanation</a>.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">return_conf_int</span></code> (optional) - a boolean (Default: <code class="docutils literal notranslate"><span class="pre">False</span></code>) for whether to return confidence interval values.</dt><dd><p>See above note.</p>
</dd>
</dl>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">alpha</span></code> (optional) - the significance value for calculating confidence intervals. (Default: <code class="docutils literal notranslate"><span class="pre">0.05</span></code>)</p></li>
</ul>
<p>An example configuration for the <code class="docutils literal notranslate"><span class="pre">pyfunc</span></code> predict of a <code class="docutils literal notranslate"><span class="pre">pmdarima</span></code> model is shown below, with a future period
prediction count of 100, a confidence interval calculation generation, no exogenous regressor elements, and a default
alpha of <code class="docutils literal notranslate"><span class="pre">0.05</span></code>:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 20%" />
<col style="width: 30%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Index</p></th>
<th class="head"><p>n_periods</p></th>
<th class="head"><p>return_conf_int</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0</p></td>
<td><p>100</p></td>
<td><p>True</p></td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Pandas</span> <span class="pre">DataFrame</span></code> passed to a <code class="docutils literal notranslate"><span class="pre">pmdarima</span></code> <code class="docutils literal notranslate"><span class="pre">pyfunc</span></code> flavor must only contain 1 row.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When predicting a <code class="docutils literal notranslate"><span class="pre">pmdarima</span></code> flavor, the <code class="docutils literal notranslate"><span class="pre">predict</span></code> method’s <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> configuration column
<code class="docutils literal notranslate"><span class="pre">return_conf_int</span></code>’s value controls the output format. When the column’s value is set to <code class="docutils literal notranslate"><span class="pre">False</span></code> or <code class="docutils literal notranslate"><span class="pre">None</span></code>
(which is the default if this column is not supplied in the configuration <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code>), the schema of the
returned <code class="docutils literal notranslate"><span class="pre">Pandas</span> <span class="pre">DataFrame</span></code> is a single column: <code class="docutils literal notranslate"><span class="pre">[&quot;yhat&quot;]</span></code>. When set to <code class="docutils literal notranslate"><span class="pre">True</span></code>, the schema of the returned
<code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> is: <code class="docutils literal notranslate"><span class="pre">[&quot;yhat&quot;,</span> <span class="pre">&quot;yhat_lower&quot;,</span> <span class="pre">&quot;yhat_upper&quot;]</span></code> with the respective lower (<code class="docutils literal notranslate"><span class="pre">yhat_lower</span></code>) and
upper (<code class="docutils literal notranslate"><span class="pre">yhat_upper</span></code>) confidence intervals added to the forecast predictions (<code class="docutils literal notranslate"><span class="pre">yhat</span></code>).</p>
</div>
<p>Example usage of pmdarima artifact loaded as a pyfunc with confidence intervals calculated:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pmdarima</span>
<span class="kn">import</span> <span class="nn">mlflow</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">pmdarima</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">load_airpassengers</span><span class="p">()</span>

<span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">():</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">pmdarima</span><span class="o">.</span><span class="n">auto_arima</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">seasonal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">pmdarima</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;/tmp/model.pmd&quot;</span><span class="p">)</span>

<span class="n">loaded_pyfunc</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">pyfunc</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="s2">&quot;/tmp/model.pmd&quot;</span><span class="p">)</span>

<span class="n">prediction_conf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="p">[{</span><span class="s2">&quot;n_periods&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;return_conf_int&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}]</span>
<span class="p">)</span>

<span class="n">predictions</span> <span class="o">=</span> <span class="n">loaded_pyfunc</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">prediction_conf</span><span class="p">)</span>
</pre></div>
</div>
<p>Output (<code class="docutils literal notranslate"><span class="pre">Pandas</span> <span class="pre">DataFrame</span></code>):</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 17%" />
<col style="width: 28%" />
<col style="width: 28%" />
<col style="width: 28%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Index</p></th>
<th class="head"><p>yhat</p></th>
<th class="head"><p>yhat_lower</p></th>
<th class="head"><p>yhat_upper</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0</p></td>
<td><p>467.573731</p></td>
<td><p>423.30995</p></td>
<td><p>511.83751</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>490.494467</p></td>
<td><p>416.17449</p></td>
<td><p>564.81444</p></td>
</tr>
<tr class="row-even"><td><p>2</p></td>
<td><p>509.138684</p></td>
<td><p>420.56255</p></td>
<td><p>597.71117</p></td>
</tr>
<tr class="row-odd"><td><p>3</p></td>
<td><p>492.554714</p></td>
<td><p>397.30634</p></td>
<td><p>587.80309</p></td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Signature logging for <code class="docutils literal notranslate"><span class="pre">pmdarima</span></code> will not function correctly if <code class="docutils literal notranslate"><span class="pre">return_conf_int</span></code> is set to <code class="docutils literal notranslate"><span class="pre">True</span></code> from
a non-pyfunc artifact. The output of the native <code class="docutils literal notranslate"><span class="pre">ARIMA.predict()</span></code> when returning confidence intervals is not
a recognized signature type.</p>
</div>
</div>
<div class="section" id="diviner-diviner">
<h3><a class="toc-backref" href="#id51">Diviner (<code class="docutils literal notranslate"><span class="pre">diviner</span></code>)</a><a class="headerlink" href="#diviner-diviner" title="Permalink to this headline"> </a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">diviner</span></code> model flavor enables logging of
<a class="reference external" href="https://databricks-diviner.readthedocs.io/en/latest/index.html">diviner models</a> in MLflow format via the
<a class="reference internal" href="python_api/mlflow.diviner.html#mlflow.diviner.save_model" title="mlflow.diviner.save_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.diviner.save_model()</span></code></a> and <a class="reference internal" href="python_api/mlflow.diviner.html#mlflow.diviner.log_model" title="mlflow.diviner.log_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.diviner.log_model()</span></code></a> methods. These methods also add the
<code class="docutils literal notranslate"><span class="pre">python_function</span></code> flavor to the MLflow Models that they produce, allowing the model to be interpreted as generic
Python functions for inference via <a class="reference internal" href="python_api/mlflow.pyfunc.html#mlflow.pyfunc.load_model" title="mlflow.pyfunc.load_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.pyfunc.load_model()</span></code></a>.
This loaded PyFunc model can only be scored with a DataFrame input.
You can also use the <a class="reference internal" href="python_api/mlflow.diviner.html#mlflow.diviner.load_model" title="mlflow.diviner.load_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.diviner.load_model()</span></code></a> method to load MLflow Models with the <code class="docutils literal notranslate"><span class="pre">diviner</span></code>
model flavor in native diviner formats.</p>
<div class="section" id="diviner-types">
<h4>Diviner Types<a class="headerlink" href="#diviner-types" title="Permalink to this headline"> </a></h4>
<p>Diviner is a library that provides an orchestration framework for performing time series forecasting on groups of
related series. Forecasting in <code class="docutils literal notranslate"><span class="pre">diviner</span></code> is accomplished through wrapping popular open source libraries such as
<a class="reference external" href="https://facebook.github.io/prophet/">prophet</a> and <a class="reference external" href="http://alkaline-ml.com/pmdarima/">pmdarima</a>. The <code class="docutils literal notranslate"><span class="pre">diviner</span></code>
library offers a simplified set of APIs to simultaneously generate distinct time series forecasts for multiple data
groupings using a single input DataFrame and a unified high-level API.</p>
</div>
<div class="section" id="metrics-and-parameters-logging-for-diviner">
<h4>Metrics and Parameters logging for Diviner<a class="headerlink" href="#metrics-and-parameters-logging-for-diviner" title="Permalink to this headline"> </a></h4>
<p>Unlike other flavors that are supported in MLflow, Diviner has the concept of grouped models. As a collection of many
(perhaps thousands) of individual forecasting models, the burden to the tracking server to log individual metrics
and parameters for each of these models is significant. For this reason, metrics and parameters are exposed for
retrieval from Diviner’s APIs as <code class="docutils literal notranslate"><span class="pre">Pandas</span></code> <code class="docutils literal notranslate"><span class="pre">DataFrames</span></code>, rather than discrete primitive values.</p>
<p>To illustrate, let us assume we are forecasting hourly electricity consumption from major cities around the world.
A sample of our input data looks like this:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 16%" />
<col style="width: 23%" />
<col style="width: 44%" />
<col style="width: 16%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>country</p></th>
<th class="head"><p>city</p></th>
<th class="head"><p>datetime</p></th>
<th class="head"><p>watts</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>US</p></td>
<td><p>NewYork</p></td>
<td><p>2022-03-01 00:01:00</p></td>
<td><p>23568.9</p></td>
</tr>
<tr class="row-odd"><td><p>US</p></td>
<td><p>NewYork</p></td>
<td><p>2022-03-01 00:02:00</p></td>
<td><p>22331.7</p></td>
</tr>
<tr class="row-even"><td><p>US</p></td>
<td><p>Boston</p></td>
<td><p>2022-03-01 00:01:00</p></td>
<td><p>14220.1</p></td>
</tr>
<tr class="row-odd"><td><p>US</p></td>
<td><p>Boston</p></td>
<td><p>2022-03-01 00:02:00</p></td>
<td><p>14183.4</p></td>
</tr>
<tr class="row-even"><td><p>CA</p></td>
<td><p>Toronto</p></td>
<td><p>2022-03-01 00:01:00</p></td>
<td><p>18562.2</p></td>
</tr>
<tr class="row-odd"><td><p>CA</p></td>
<td><p>Toronto</p></td>
<td><p>2022-03-01 00:02:00</p></td>
<td><p>17681.6</p></td>
</tr>
<tr class="row-even"><td><p>MX</p></td>
<td><p>MexicoCity</p></td>
<td><p>2022-03-01 00:01:00</p></td>
<td><p>19946.8</p></td>
</tr>
<tr class="row-odd"><td><p>MX</p></td>
<td><p>MexicoCity</p></td>
<td><p>2022-03-01 00:02:00</p></td>
<td><p>19444.0</p></td>
</tr>
</tbody>
</table>
<p>If we were to <code class="docutils literal notranslate"><span class="pre">fit</span></code> a model on this data, supplying the grouping keys as:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">grouping_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;country&quot;</span><span class="p">,</span> <span class="s2">&quot;city&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>We will have a model generated for each of the grouping keys that have been supplied:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[(</span><span class="s2">&quot;US&quot;</span><span class="p">,</span> <span class="s2">&quot;NewYork&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;US&quot;</span><span class="p">,</span> <span class="s2">&quot;Boston&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;CA&quot;</span><span class="p">,</span> <span class="s2">&quot;Toronto&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;MX&quot;</span><span class="p">,</span> <span class="s2">&quot;MexicoCity&quot;</span><span class="p">)]</span>
</pre></div>
</div>
<p>With a model constructed for each of these, entering each of their metrics and parameters wouldn’t be an issue for the
MLflow tracking server. What would become a problem, however, is if we modeled each major city on the planet and ran
this forecasting scenario every day. If we were to adhere to the conditions of the World Bank, that would mean just
over 10,000 models as of 2022. After a mere few weeks of running this forecasting every day we would have a very large
metrics table.</p>
<p>To eliminate this issue for large-scale forecasting, the metrics and parameters for <code class="docutils literal notranslate"><span class="pre">diviner</span></code> are extracted as a
grouping key indexed <code class="docutils literal notranslate"><span class="pre">Pandas</span> <span class="pre">DataFrame</span></code>, as shown below for example (float values truncated for visibility):</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 28%" />
<col style="width: 9%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 8%" />
<col style="width: 8%" />
<col style="width: 5%" />
<col style="width: 7%" />
<col style="width: 7%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>grouping_key_columns</p></th>
<th class="head"><p>country</p></th>
<th class="head"><p>city</p></th>
<th class="head"><p>mse</p></th>
<th class="head"><p>rmse</p></th>
<th class="head"><p>mae</p></th>
<th class="head"><p>mape</p></th>
<th class="head"><p>mdape</p></th>
<th class="head"><p>smape</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>“(‘country’, ‘city’)”</p></td>
<td><p>CA</p></td>
<td><p>Toronto</p></td>
<td><p>8276851.6</p></td>
<td><p>2801.7</p></td>
<td><p>2417.7</p></td>
<td><p>0.16</p></td>
<td><p>0.16</p></td>
<td><p>0.159</p></td>
</tr>
<tr class="row-odd"><td><p>“(‘country’, ‘city’)”</p></td>
<td><p>MX</p></td>
<td><p>MexicoCity</p></td>
<td><p>3548872.4</p></td>
<td><p>1833.8</p></td>
<td><p>1584.5</p></td>
<td><p>0.15</p></td>
<td><p>0.16</p></td>
<td><p>0.159</p></td>
</tr>
<tr class="row-even"><td><p>“(‘country’, ‘city’)”</p></td>
<td><p>US</p></td>
<td><p>NewYork</p></td>
<td><p>3167846.4</p></td>
<td><p>1732.4</p></td>
<td><p>1498.2</p></td>
<td><p>0.15</p></td>
<td><p>0.16</p></td>
<td><p>0.158</p></td>
</tr>
<tr class="row-odd"><td><p>“(‘country’, ‘city’)”</p></td>
<td><p>US</p></td>
<td><p>Boston</p></td>
<td><p>14082666.4</p></td>
<td><p>3653.2</p></td>
<td><p>3156.2</p></td>
<td><p>0.15</p></td>
<td><p>0.16</p></td>
<td><p>0.159</p></td>
</tr>
</tbody>
</table>
<p>There are two recommended means of logging the metrics and parameters from a <code class="docutils literal notranslate"><span class="pre">diviner</span></code> model :</p>
<ul class="simple">
<li><p>Writing the DataFrames to local storage and using <a class="reference internal" href="python_api/mlflow.html#mlflow.log_artifacts" title="mlflow.log_artifacts"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.log_artifacts()</span></code></a></p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">mlflow</span>
<span class="kn">import</span> <span class="nn">tempfile</span>

<span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdir</span><span class="p">:</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">extract_model_params</span><span class="p">()</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">cross_validate_and_score</span><span class="p">(</span>
        <span class="n">horizon</span><span class="o">=</span><span class="s2">&quot;72 hours&quot;</span><span class="p">,</span>
        <span class="n">period</span><span class="o">=</span><span class="s2">&quot;240 hours&quot;</span><span class="p">,</span>
        <span class="n">initial</span><span class="o">=</span><span class="s2">&quot;480 hours&quot;</span><span class="p">,</span>
        <span class="n">parallel</span><span class="o">=</span><span class="s2">&quot;threads&quot;</span><span class="p">,</span>
        <span class="n">rolling_window</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">monthly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">params</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tmpdir</span><span class="si">}</span><span class="s2">/params.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">metrics</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tmpdir</span><span class="si">}</span><span class="s2">/metrics.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_artifacts</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">,</span> <span class="n">artifact_path</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Writing directly as a JSON artifact using <a class="reference internal" href="python_api/mlflow.html#mlflow.log_dict" title="mlflow.log_dict"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.log_dict()</span></code></a></p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The parameters extract from <code class="docutils literal notranslate"><span class="pre">diviner</span></code> models <em>may require</em> casting (or dropping of columns) if using the
<code class="docutils literal notranslate"><span class="pre">pd.DataFrame.to_dict()</span></code> approach due to the inability of this method to serialize objects.</p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mlflow</span>

<span class="n">params</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">extract_model_params</span><span class="p">()</span>
<span class="n">metrics</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">cross_validate_and_score</span><span class="p">(</span>
    <span class="n">horizon</span><span class="o">=</span><span class="s2">&quot;72 hours&quot;</span><span class="p">,</span>
    <span class="n">period</span><span class="o">=</span><span class="s2">&quot;240 hours&quot;</span><span class="p">,</span>
    <span class="n">initial</span><span class="o">=</span><span class="s2">&quot;480 hours&quot;</span><span class="p">,</span>
    <span class="n">parallel</span><span class="o">=</span><span class="s2">&quot;threads&quot;</span><span class="p">,</span>
    <span class="n">rolling_window</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">monthly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">params</span><span class="p">[</span><span class="s2">&quot;t_scale&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;t_scale&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<span class="n">params</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;stan_backend&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">mlflow</span><span class="o">.</span><span class="n">log_dict</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span> <span class="s2">&quot;params.json&quot;</span><span class="p">)</span>
<span class="n">mlflow</span><span class="o">.</span><span class="n">log_dict</span><span class="p">(</span><span class="n">metrics</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span> <span class="s2">&quot;metrics.json&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Logging of the model artifact is shown in the <code class="docutils literal notranslate"><span class="pre">pyfunc</span></code> example below.</p>
</div>
<div class="section" id="diviner-pyfunc-usage">
<h4>Diviner pyfunc usage<a class="headerlink" href="#diviner-pyfunc-usage" title="Permalink to this headline"> </a></h4>
<p>The MLflow Diviner flavor includes an implementation of the <code class="docutils literal notranslate"><span class="pre">pyfunc</span></code> interface for Diviner models. To control
prediction behavior, you can specify configuration arguments in the first row of a Pandas DataFrame input.</p>
<p>As this configuration is dependent upon the underlying model type (i.e., the <code class="docutils literal notranslate"><span class="pre">diviner.GroupedProphet.forecast()</span></code>
method has a different signature than does <code class="docutils literal notranslate"><span class="pre">diviner.GroupedPmdarima.predict()</span></code>), the Diviner pyfunc implementation
attempts to coerce arguments to the types expected by the underlying model.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Diviner models support both “full group” and “partial group” forecasting. If a column named <code class="docutils literal notranslate"><span class="pre">&quot;groups&quot;</span></code> is present
in the configuration <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> submitted to the <code class="docutils literal notranslate"><span class="pre">pyfunc</span></code> flavor, the grouping key values in the first row
will be used to generate a subset of forecast predictions. This functionality removes the need to filter a subset
from the full output of all groups forecasts if the results of only a few (or one) groups are needed.</p>
</div>
<p>For a <code class="docutils literal notranslate"><span class="pre">GroupedPmdarima</span></code> model, an example configuration for the <code class="docutils literal notranslate"><span class="pre">pyfunc</span></code> <code class="docutils literal notranslate"><span class="pre">predict()</span></code> method is:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mlflow</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pmdarima.arima.auto</span> <span class="kn">import</span> <span class="n">AutoARIMA</span>
<span class="kn">from</span> <span class="nn">diviner</span> <span class="kn">import</span> <span class="n">GroupedPmdarima</span>

<span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">():</span>
    <span class="n">base_model</span> <span class="o">=</span> <span class="n">AutoARIMA</span><span class="p">(</span><span class="n">out_of_sample_size</span><span class="o">=</span><span class="mi">96</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">GroupedPmdarima</span><span class="p">(</span><span class="n">model_template</span><span class="o">=</span><span class="n">base_model</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
        <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
        <span class="n">group_key_columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;country&quot;</span><span class="p">,</span> <span class="s2">&quot;city&quot;</span><span class="p">],</span>
        <span class="n">y_col</span><span class="o">=</span><span class="s2">&quot;watts&quot;</span><span class="p">,</span>
        <span class="n">datetime_col</span><span class="o">=</span><span class="s2">&quot;datetime&quot;</span><span class="p">,</span>
        <span class="n">silence_warnings</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">mlflow</span><span class="o">.</span><span class="n">diviner</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">diviner_model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s2">&quot;/tmp/diviner_model&quot;</span><span class="p">)</span>

<span class="n">diviner_pyfunc</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">pyfunc</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">model_uri</span><span class="o">=</span><span class="s2">&quot;/tmp/diviner_model&quot;</span><span class="p">)</span>

<span class="n">predict_conf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s2">&quot;n_periods&quot;</span><span class="p">:</span> <span class="mi">120</span><span class="p">,</span>
        <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;US&quot;</span><span class="p">,</span> <span class="s2">&quot;NewYork&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;CA&quot;</span><span class="p">,</span> <span class="s2">&quot;Toronto&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;MX&quot;</span><span class="p">,</span> <span class="s2">&quot;MexicoCity&quot;</span><span class="p">),</span>
        <span class="p">],</span>  <span class="c1"># NB: List of tuples required.</span>
        <span class="s2">&quot;predict_col&quot;</span><span class="p">:</span> <span class="s2">&quot;wattage_forecast&quot;</span><span class="p">,</span>
        <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="s2">&quot;return_conf_int&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;on_error&quot;</span><span class="p">:</span> <span class="s2">&quot;warn&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
<span class="p">)</span>

<span class="n">subset_forecasts</span> <span class="o">=</span> <span class="n">diviner_pyfunc</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">predict_conf</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>There are several instances in which a configuration <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> submitted to the <code class="docutils literal notranslate"><span class="pre">pyfunc</span></code> <code class="docutils literal notranslate"><span class="pre">predict()</span></code> method
will cause an <code class="docutils literal notranslate"><span class="pre">MlflowException</span></code> to be raised:</p>
<blockquote>
<div><ul class="simple">
<li><p>If neither <code class="docutils literal notranslate"><span class="pre">horizon</span></code> or <code class="docutils literal notranslate"><span class="pre">n_periods</span></code> are provided.</p></li>
<li><p>The value of <code class="docutils literal notranslate"><span class="pre">n_periods</span></code> or <code class="docutils literal notranslate"><span class="pre">horizon</span></code> is not an integer.</p></li>
<li><p>If the model is of type <code class="docutils literal notranslate"><span class="pre">GroupedProphet</span></code>, <code class="docutils literal notranslate"><span class="pre">frequency</span></code> as a string type must be provided.</p></li>
<li><p>If both <code class="docutils literal notranslate"><span class="pre">horizon</span></code> and <code class="docutils literal notranslate"><span class="pre">n_periods</span></code> are provided with different values.</p></li>
</ul>
</div></blockquote>
</div>
</div>
</div>
</div>
<div class="section" id="model-evaluation">
<span id="id9"></span><h2><a class="toc-backref" href="#id27">Model Evaluation</a><a class="headerlink" href="#model-evaluation" title="Permalink to this headline"> </a></h2>
<p>After building and training your MLflow Model, you can use the <a class="reference internal" href="python_api/mlflow.html#mlflow.evaluate" title="mlflow.evaluate"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.evaluate()</span></code></a> API to
evaluate its performance on one or more datasets of your choosing. <a class="reference internal" href="python_api/mlflow.html#mlflow.evaluate" title="mlflow.evaluate"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.evaluate()</span></code></a>
currently supports evaluation of MLflow Models with the
<a class="reference internal" href="#pyfunc-model-flavor"><span class="std std-ref">python_function (pyfunc) model flavor</span></a> for classification and regression
tasks, computing a variety of task-specific performance metrics, model performance plots, and
model explanations. Evaluation results are logged to <a class="reference internal" href="tracking.html#tracking"><span class="std std-ref">MLflow Tracking</span></a>.</p>
<p>The following <a class="reference external" href="https://github.com/mlflow/mlflow/blob/master/examples/evaluation/evaluate_on_binary_classifier.py">example from the MLflow GitHub Repository</a>
uses <a class="reference internal" href="python_api/mlflow.html#mlflow.evaluate" title="mlflow.evaluate"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.evaluate()</span></code></a> to evaluate the performance of a classifier
on the <a class="reference external" href="https://archive.ics.uci.edu/ml/datasets/adult">UCI Adult Data Set</a>, logging a
comprehensive collection of MLflow Metrics and Artifacts that provide insight into model performance
and behavior:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xgboost</span>
<span class="kn">import</span> <span class="nn">shap</span>
<span class="kn">import</span> <span class="nn">mlflow</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>

<span class="c1"># Load the UCI Adult Dataset</span>
<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">adult</span><span class="p">()</span>

<span class="c1"># Split the data into training and test sets</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.33</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>

<span class="c1"># Fit an XGBoost binary classifier on the training data split</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">xgboost</span><span class="o">.</span><span class="n">XGBClassifier</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="c1"># Build the Evaluation Dataset from the test set</span>
<span class="n">eval_data</span> <span class="o">=</span> <span class="n">X_test</span>
<span class="n">eval_data</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_test</span>

<span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">()</span> <span class="k">as</span> <span class="n">run</span><span class="p">:</span>
    <span class="c1"># Log the baseline model to MLflow</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">sklearn</span><span class="o">.</span><span class="n">log_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">)</span>
    <span class="n">model_uri</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">get_artifact_uri</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">)</span>

    <span class="c1"># Evaluate the logged model</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span>
        <span class="n">model_uri</span><span class="p">,</span>
        <span class="n">eval_data</span><span class="p">,</span>
        <span class="n">targets</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="p">,</span>
        <span class="n">model_type</span><span class="o">=</span><span class="s2">&quot;classifier&quot;</span><span class="p">,</span>
        <span class="n">evaluators</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">],</span>
    <span class="p">)</span>
</pre></div>
</div>
<p><a class="reference internal" href="_images/model_evaluation_metrics.png"><img alt="eval_metrics_img" src="_images/model_evaluation_metrics.png" style="width: 15%;" /></a> <a class="reference internal" href="_images/model_evaluation_feature_importance.png"><img alt="eval_importance_img" src="_images/model_evaluation_feature_importance.png" style="width: 84%;" /></a></p>
<div class="section" id="evaluating-with-custom-metrics">
<h3>Evaluating with Custom Metrics<a class="headerlink" href="#evaluating-with-custom-metrics" title="Permalink to this headline"> </a></h3>
<p>If the default set of metrics is insufficient, you can supply <code class="docutils literal notranslate"><span class="pre">custom_metrics</span></code> and <code class="docutils literal notranslate"><span class="pre">custom_artifacts</span></code>
to <a class="reference internal" href="python_api/mlflow.html#mlflow.evaluate" title="mlflow.evaluate"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.evaluate()</span></code></a> to produce custom metrics and artifacts for the model(s) that you’re evaluating.
The following <a class="reference external" href="https://github.com/mlflow/mlflow/blob/master/examples/evaluation/evaluate_with_custom_metrics.py">short example from the MLflow GitHub Repository</a>
uses <a class="reference internal" href="python_api/mlflow.html#mlflow.evaluate" title="mlflow.evaluate"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.evaluate()</span></code></a> with a custom metric function to evaluate the performance of a regressor on the
<a class="reference external" href="https://www.dcc.fc.up.pt/~ltorgo/Regression/cal_housing.html">California Housing Dataset</a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LinearRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">fetch_california_housing</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">mlflow</span>
<span class="kn">from</span> <span class="nn">mlflow.models</span> <span class="kn">import</span> <span class="n">make_metric</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># loading the California housing dataset</span>
<span class="n">cali_housing</span> <span class="o">=</span> <span class="n">fetch_california_housing</span><span class="p">(</span><span class="n">as_frame</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># split the dataset into train and test partitions</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">cali_housing</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">cali_housing</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">123</span>
<span class="p">)</span>

<span class="c1"># train the model</span>
<span class="n">lin_reg</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="c1"># creating the evaluation dataframe</span>
<span class="n">eval_data</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">eval_data</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_test</span>


<span class="k">def</span> <span class="nf">squared_diff_plus_one</span><span class="p">(</span><span class="n">eval_df</span><span class="p">,</span> <span class="n">_builtin_metrics</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This example custom metric function creates a metric based on the ``prediction`` and</span>
<span class="sd">    ``target`` columns in ``eval_df`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">eval_df</span><span class="p">[</span><span class="s2">&quot;prediction&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">eval_df</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">sum_on_target_divided_by_two</span><span class="p">(</span><span class="n">_eval_df</span><span class="p">,</span> <span class="n">builtin_metrics</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This example custom metric function creates a metric derived from existing metrics in</span>
<span class="sd">    ``builtin_metrics``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">builtin_metrics</span><span class="p">[</span><span class="s2">&quot;sum_on_target&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>


<span class="k">def</span> <span class="nf">prediction_target_scatter</span><span class="p">(</span><span class="n">eval_df</span><span class="p">,</span> <span class="n">_builtin_metrics</span><span class="p">,</span> <span class="n">artifacts_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This example custom artifact generates and saves a scatter plot to ``artifacts_dir`` that</span>
<span class="sd">    visualizes the relationship between the predictions and targets for the given model to a</span>
<span class="sd">    file as an image artifact.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">eval_df</span><span class="p">[</span><span class="s2">&quot;prediction&quot;</span><span class="p">],</span> <span class="n">eval_df</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Targets&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Predictions&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Targets vs. Predictions&quot;</span><span class="p">)</span>
    <span class="n">plot_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">artifacts_dir</span><span class="p">,</span> <span class="s2">&quot;example_scatter_plot.png&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;example_scatter_plot_artifact&quot;</span><span class="p">:</span> <span class="n">plot_path</span><span class="p">}</span>


<span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">()</span> <span class="k">as</span> <span class="n">run</span><span class="p">:</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">sklearn</span><span class="o">.</span><span class="n">log_model</span><span class="p">(</span><span class="n">lin_reg</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">)</span>
    <span class="n">model_uri</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">get_artifact_uri</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model_uri</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="n">eval_data</span><span class="p">,</span>
        <span class="n">targets</span><span class="o">=</span><span class="s2">&quot;target&quot;</span><span class="p">,</span>
        <span class="n">model_type</span><span class="o">=</span><span class="s2">&quot;regressor&quot;</span><span class="p">,</span>
        <span class="n">evaluators</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">],</span>
        <span class="n">custom_metrics</span><span class="o">=</span><span class="p">[</span>
            <span class="n">make_metric</span><span class="p">(</span>
                <span class="n">eval_fn</span><span class="o">=</span><span class="n">squared_diff_plus_one</span><span class="p">,</span>
                <span class="n">greater_is_better</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">make_metric</span><span class="p">(</span>
                <span class="n">eval_fn</span><span class="o">=</span><span class="n">sum_on_target_divided_by_two</span><span class="p">,</span>
                <span class="n">greater_is_better</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">],</span>
        <span class="n">custom_artifacts</span><span class="o">=</span><span class="p">[</span><span class="n">prediction_target_scatter</span><span class="p">],</span>
    <span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;metrics:</span><span class="se">\n</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">metrics</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;artifacts:</span><span class="se">\n</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">artifacts</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>For a more comprehensive custom metrics usage example, refer to <a class="reference external" href="https://github.com/mlflow/mlflow/blob/master/examples/evaluation/evaluate_with_custom_metrics_comprehensive.py">this example from the MLflow GitHub Repository</a>.</p>
</div>
<div class="section" id="performing-model-validation">
<span id="model-validation"></span><h3>Performing Model Validation<a class="headerlink" href="#performing-model-validation" title="Permalink to this headline"> </a></h3>
<p>You can also use the <a class="reference internal" href="python_api/mlflow.html#mlflow.evaluate" title="mlflow.evaluate"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.evaluate()</span></code></a> API to perform some checks on the metrics
generated during model evaluation to validate the quality of your model. By specifying a
<code class="docutils literal notranslate"><span class="pre">validation_thresholds</span></code> dictionary mapping metric names to <a class="reference internal" href="python_api/mlflow.models.html#mlflow.models.MetricThreshold" title="mlflow.models.MetricThreshold"><code class="xref py py-class docutils literal notranslate"><span class="pre">mlflow.models.MetricThreshold</span></code></a>
objects, you can specify value thresholds that your model’s evaluation metrics must exceed as well
as absolute and relative gains your model must have in comparison to a specified
<code class="docutils literal notranslate"><span class="pre">baseline_model</span></code>. If your model fails to clear specified thresholds, <a class="reference internal" href="python_api/mlflow.html#mlflow.evaluate" title="mlflow.evaluate"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.evaluate()</span></code></a>
will throw a <code class="docutils literal notranslate"><span class="pre">ModelValidationFailedException</span></code> detailing the validation failure.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xgboost</span>
<span class="kn">import</span> <span class="nn">shap</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.dummy</span> <span class="kn">import</span> <span class="n">DummyClassifier</span>
<span class="kn">import</span> <span class="nn">mlflow</span>
<span class="kn">from</span> <span class="nn">mlflow.models</span> <span class="kn">import</span> <span class="n">MetricThreshold</span>

<span class="c1"># load UCI Adult Data Set; segment it into training and test sets</span>
<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">adult</span><span class="p">()</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.33</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>

<span class="c1"># train a candidate XGBoost model</span>
<span class="n">candidate_model</span> <span class="o">=</span> <span class="n">xgboost</span><span class="o">.</span><span class="n">XGBClassifier</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="c1"># train a baseline dummy model</span>
<span class="n">baseline_model</span> <span class="o">=</span> <span class="n">DummyClassifier</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;uniform&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="c1"># construct an evaluation dataset from the test set</span>
<span class="n">eval_data</span> <span class="o">=</span> <span class="n">X_test</span>
<span class="n">eval_data</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_test</span>

<span class="c1"># Define criteria for model to be validated against</span>
<span class="n">thresholds</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;accuracy_score&quot;</span><span class="p">:</span> <span class="n">MetricThreshold</span><span class="p">(</span>
        <span class="n">threshold</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>  <span class="c1"># accuracy should be &gt;=0.8</span>
        <span class="n">min_absolute_change</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>  <span class="c1"># accuracy should be at least 0.05 greater than baseline model accuracy</span>
        <span class="n">min_relative_change</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>  <span class="c1"># accuracy should be at least 5 percent greater than baseline model accuracy</span>
        <span class="n">higher_is_better</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">}</span>

<span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">()</span> <span class="k">as</span> <span class="n">run</span><span class="p">:</span>
    <span class="n">candidate_model_uri</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">sklearn</span><span class="o">.</span><span class="n">log_model</span><span class="p">(</span>
        <span class="n">candidate_model</span><span class="p">,</span> <span class="s2">&quot;candidate_model&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">model_uri</span>
    <span class="n">baseline_model_uri</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">sklearn</span><span class="o">.</span><span class="n">log_model</span><span class="p">(</span>
        <span class="n">baseline_model</span><span class="p">,</span> <span class="s2">&quot;baseline_model&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">model_uri</span>

    <span class="n">mlflow</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span>
        <span class="n">candidate_model_uri</span><span class="p">,</span>
        <span class="n">eval_data</span><span class="p">,</span>
        <span class="n">targets</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="p">,</span>
        <span class="n">model_type</span><span class="o">=</span><span class="s2">&quot;classifier&quot;</span><span class="p">,</span>
        <span class="n">validation_thresholds</span><span class="o">=</span><span class="n">thresholds</span><span class="p">,</span>
        <span class="n">baseline_model</span><span class="o">=</span><span class="n">baseline_model_uri</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>Refer to <a class="reference internal" href="python_api/mlflow.models.html#mlflow.models.MetricThreshold" title="mlflow.models.MetricThreshold"><code class="xref py py-class docutils literal notranslate"><span class="pre">mlflow.models.MetricThreshold</span></code></a> to see details on how the thresholds are specified
and checked. For a more comprehensive demonstration on how to use <a class="reference internal" href="python_api/mlflow.html#mlflow.evaluate" title="mlflow.evaluate"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.evaluate()</span></code></a> to perform model validation, refer to
<a class="reference external" href="https://github.com/mlflow/mlflow/blob/master/examples/evaluation/evaluate_with_model_validation.py">the Model Validation example from the MLflow GitHub Repository</a>.</p>
<p>The logged output within the MLflow UI for the comprehensive example is shown below. Note the two model artifacts that have
been logged: ‘baseline_model’ and ‘candidate_model’ for comparison purposes in the example.</p>
<p><a class="reference internal" href="_images/model_evaluation_compare_feature_importance.png"><img alt="eval_importance_compare_img" src="_images/model_evaluation_compare_feature_importance.png" style="width: 99%;" /></a></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Limitations (when the default evaluator is used):</p>
<ul class="simple">
<li><p>Model validation results are not included in the active MLflow run.</p></li>
<li><p>No metrics are logged nor artifacts produced for the baseline model in the active MLflow run.</p></li>
</ul>
</div>
<p>Additional information about model evaluation behaviors and outputs is available in the
<a class="reference internal" href="python_api/mlflow.html#mlflow.evaluate" title="mlflow.evaluate"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.evaluate()</span></code></a> API docs.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Differences in the computation of Area under Curve Precision Recall score (metric name
<code class="docutils literal notranslate"><span class="pre">precision_recall_auc</span></code>) between multi and binary classifiers:</p>
<p>Multiclass classifier models, when evaluated, utilize the standard scoring metric from sklearn:
<code class="docutils literal notranslate"><span class="pre">sklearn.metrics.roc_auc_score</span></code> to calculate the area under the precision recall curve. This
algorithm performs a linear interpolation calculation utilizing the trapezoidal rule to estimate
the area under the precision recall curve. It is well-suited for use in evaluating multi-class
classification models to provide a single numeric value of the quality of fit.</p>
<p>Binary classifier models, on the other hand, use the <code class="docutils literal notranslate"><span class="pre">sklearn.metrics.average_precision_score</span></code> to
avoid the shortcomings of the <code class="docutils literal notranslate"><span class="pre">roc_auc_score</span></code> implementation when applied to heavily
imbalanced classes in binary classification. Usage of the <code class="docutils literal notranslate"><span class="pre">roc_auc_score</span></code> for imbalanced
datasets can give a misleading result (optimistically better than the model’s actual ability
to accurately predict the minority class membership).</p>
<p>For additional information on the topic of why different algorithms are employed for this, as
well as links to the papers that informed the implementation of these metrics within the
<code class="docutils literal notranslate"><span class="pre">sklearn.metrics</span></code> module, refer to
<a class="reference external" href="https://scikit-learn.org/stable/modules/model_evaluation.html#precision-recall-f-measure-metrics">the documentation</a>.</p>
<p>For simplicity purposes, both methodologies evaluation metric results (whether for multi-class
or binary classification) are unified in the single metric: <code class="docutils literal notranslate"><span class="pre">precision_recall_auc</span></code>.</p>
</div>
</div>
</div>
<div class="section" id="model-customization">
<h2><a class="toc-backref" href="#id28">Model Customization</a><a class="headerlink" href="#model-customization" title="Permalink to this headline"> </a></h2>
<p>While MLflow’s built-in model persistence utilities are convenient for packaging models from various
popular ML libraries in MLflow Model format, they do not cover every use case. For example, you may
want to use a model from an ML library that is not explicitly supported by MLflow’s built-in
flavors. Alternatively, you may want to package custom inference code and data to create an
MLflow Model. Fortunately, MLflow provides two solutions that can be used to accomplish these
tasks: <a class="reference internal" href="#custom-python-models"><span class="std std-ref">Custom Python Models</span></a> and <a class="reference internal" href="#custom-flavors"><span class="std std-ref">Custom Flavors</span></a>.</p>
<div class="contents local topic" id="in-this-section">
<p class="topic-title">In this section:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#custom-python-models" id="id52">Custom Python Models</a></p>
<ul>
<li><p><a class="reference internal" href="#example-creating-a-custom-add-n-model" id="id53">Example: Creating a custom “add n” model</a></p></li>
<li><p><a class="reference internal" href="#example-saving-an-xgboost-model-in-mlflow-format" id="id54">Example: Saving an XGBoost model in MLflow format</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#custom-flavors" id="id55">Custom Flavors</a></p></li>
</ul>
</div>
<div class="section" id="custom-python-models">
<span id="id10"></span><h3><a class="toc-backref" href="#id52">Custom Python Models</a><a class="headerlink" href="#custom-python-models" title="Permalink to this headline"> </a></h3>
<p>The <a class="reference internal" href="python_api/mlflow.pyfunc.html#module-mlflow.pyfunc" title="mlflow.pyfunc"><code class="xref py py-mod docutils literal notranslate"><span class="pre">mlflow.pyfunc</span></code></a> module provides <a class="reference internal" href="python_api/mlflow.pyfunc.html#mlflow.pyfunc.save_model" title="mlflow.pyfunc.save_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">save_model()</span></code></a> and
<a class="reference internal" href="python_api/mlflow.pyfunc.html#mlflow.pyfunc.log_model" title="mlflow.pyfunc.log_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">log_model()</span></code></a> utilities for creating MLflow Models with the
<code class="docutils literal notranslate"><span class="pre">python_function</span></code> flavor that contain user-specified code and <em>artifact</em> (file) dependencies.
These artifact dependencies may include serialized models produced by any Python ML library.</p>
<p>Because these custom models contain the <code class="docutils literal notranslate"><span class="pre">python_function</span></code> flavor, they can be deployed
to any of MLflow’s supported production environments, such as SageMaker, AzureML, or local
REST endpoints.</p>
<p>The following examples demonstrate how you can use the <a class="reference internal" href="python_api/mlflow.pyfunc.html#module-mlflow.pyfunc" title="mlflow.pyfunc"><code class="xref py py-mod docutils literal notranslate"><span class="pre">mlflow.pyfunc</span></code></a> module to create
custom Python models. For additional information about model customization with MLflow’s
<code class="docutils literal notranslate"><span class="pre">python_function</span></code> utilities, see the
<a class="reference internal" href="python_api/mlflow.pyfunc.html#pyfunc-create-custom"><span class="std std-ref">python_function custom models documentation</span></a>.</p>
<div class="section" id="example-creating-a-custom-add-n-model">
<h4><a class="toc-backref" href="#id53">Example: Creating a custom “add n” model</a><a class="headerlink" href="#example-creating-a-custom-add-n-model" title="Permalink to this headline"> </a></h4>
<p>This example defines a class for a custom model that adds a specified numeric value, <code class="docutils literal notranslate"><span class="pre">n</span></code>, to all
columns of a Pandas DataFrame input. Then, it uses the <a class="reference internal" href="python_api/mlflow.pyfunc.html#module-mlflow.pyfunc" title="mlflow.pyfunc"><code class="xref py py-mod docutils literal notranslate"><span class="pre">mlflow.pyfunc</span></code></a> APIs to save an
instance of this model with <code class="docutils literal notranslate"><span class="pre">n</span> <span class="pre">=</span> <span class="pre">5</span></code> in MLflow Model format. Finally, it loads the model in
<code class="docutils literal notranslate"><span class="pre">python_function</span></code> format and uses it to evaluate a sample input.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mlflow.pyfunc</span>


<span class="c1"># Define the model class</span>
<span class="k">class</span> <span class="nc">AddN</span><span class="p">(</span><span class="n">mlflow</span><span class="o">.</span><span class="n">pyfunc</span><span class="o">.</span><span class="n">PythonModel</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">n</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">model_input</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">model_input</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">column</span><span class="p">:</span> <span class="n">column</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>


<span class="c1"># Construct and save the model</span>
<span class="n">model_path</span> <span class="o">=</span> <span class="s2">&quot;add_n_model&quot;</span>
<span class="n">add5_model</span> <span class="o">=</span> <span class="n">AddN</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">mlflow</span><span class="o">.</span><span class="n">pyfunc</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">model_path</span><span class="p">,</span> <span class="n">python_model</span><span class="o">=</span><span class="n">add5_model</span><span class="p">)</span>

<span class="c1"># Load the model in `python_function` format</span>
<span class="n">loaded_model</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">pyfunc</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>

<span class="c1"># Evaluate the model</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">model_input</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)])</span>
<span class="n">model_output</span> <span class="o">=</span> <span class="n">loaded_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">model_input</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">model_output</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">15</span><span class="p">)]))</span>
</pre></div>
</div>
</div>
<div class="section" id="example-saving-an-xgboost-model-in-mlflow-format">
<h4><a class="toc-backref" href="#id54">Example: Saving an XGBoost model in MLflow format</a><a class="headerlink" href="#example-saving-an-xgboost-model-in-mlflow-format" title="Permalink to this headline"> </a></h4>
<p>This example begins by training and saving a gradient boosted tree model using the XGBoost
library. Next, it defines a wrapper class around the XGBoost model that conforms to MLflow’s
<code class="docutils literal notranslate"><span class="pre">python_function</span></code> <a class="reference internal" href="python_api/mlflow.pyfunc.html#pyfunc-inference-api"><span class="std std-ref">inference API</span></a>. Then, it uses the wrapper class and
the saved XGBoost model to construct an MLflow Model that performs inference using the gradient
boosted tree. Finally, it loads the MLflow Model in <code class="docutils literal notranslate"><span class="pre">python_function</span></code> format and uses it to
evaluate test data.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load training and test datasets</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">version_info</span>
<span class="kn">import</span> <span class="nn">xgboost</span> <span class="k">as</span> <span class="nn">xgb</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">datasets</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>

<span class="n">PYTHON_VERSION</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{major}</span><span class="s2">.</span><span class="si">{minor}</span><span class="s2">.</span><span class="si">{micro}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="n">major</span><span class="o">=</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="n">version_info</span><span class="o">.</span><span class="n">minor</span><span class="p">,</span> <span class="n">micro</span><span class="o">=</span><span class="n">version_info</span><span class="o">.</span><span class="n">micro</span>
<span class="p">)</span>
<span class="n">iris</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">load_iris</span><span class="p">()</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">target</span>
<span class="n">x_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">dtrain</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">DMatrix</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">y_train</span><span class="p">)</span>

<span class="c1"># Train and save an XGBoost model</span>
<span class="n">xgb_model</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;max_depth&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">},</span> <span class="n">dtrain</span><span class="o">=</span><span class="n">dtrain</span><span class="p">,</span> <span class="n">num_boost_round</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">xgb_model_path</span> <span class="o">=</span> <span class="s2">&quot;xgb_model.pth&quot;</span>
<span class="n">xgb_model</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">xgb_model_path</span><span class="p">)</span>

<span class="c1"># Create an `artifacts` dictionary that assigns a unique name to the saved XGBoost model file.</span>
<span class="c1"># This dictionary will be passed to `mlflow.pyfunc.save_model`, which will copy the model file</span>
<span class="c1"># into the new MLflow Model&#39;s directory.</span>
<span class="n">artifacts</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;xgb_model&quot;</span><span class="p">:</span> <span class="n">xgb_model_path</span><span class="p">}</span>

<span class="c1"># Define the model class</span>
<span class="kn">import</span> <span class="nn">mlflow.pyfunc</span>


<span class="k">class</span> <span class="nc">XGBWrapper</span><span class="p">(</span><span class="n">mlflow</span><span class="o">.</span><span class="n">pyfunc</span><span class="o">.</span><span class="n">PythonModel</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">load_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">xgboost</span> <span class="k">as</span> <span class="nn">xgb</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">xgb_model</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">Booster</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xgb_model</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">artifacts</span><span class="p">[</span><span class="s2">&quot;xgb_model&quot;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">model_input</span><span class="p">):</span>
        <span class="n">input_matrix</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">DMatrix</span><span class="p">(</span><span class="n">model_input</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">xgb_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">input_matrix</span><span class="p">)</span>


<span class="c1"># Create a Conda environment for the new MLflow Model that contains all necessary dependencies.</span>
<span class="kn">import</span> <span class="nn">cloudpickle</span>

<span class="n">conda_env</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;channels&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;defaults&quot;</span><span class="p">],</span>
    <span class="s2">&quot;dependencies&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;python=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">PYTHON_VERSION</span><span class="p">),</span>
        <span class="s2">&quot;pip&quot;</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s2">&quot;pip&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;mlflow&quot;</span><span class="p">,</span>
                <span class="s2">&quot;xgboost==</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xgb</span><span class="o">.</span><span class="n">__version__</span><span class="p">),</span>
                <span class="s2">&quot;cloudpickle==</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cloudpickle</span><span class="o">.</span><span class="n">__version__</span><span class="p">),</span>
            <span class="p">],</span>
        <span class="p">},</span>
    <span class="p">],</span>
    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;xgb_env&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># Save the MLflow Model</span>
<span class="n">mlflow_pyfunc_model_path</span> <span class="o">=</span> <span class="s2">&quot;xgb_mlflow_pyfunc&quot;</span>
<span class="n">mlflow</span><span class="o">.</span><span class="n">pyfunc</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span>
    <span class="n">path</span><span class="o">=</span><span class="n">mlflow_pyfunc_model_path</span><span class="p">,</span>
    <span class="n">python_model</span><span class="o">=</span><span class="n">XGBWrapper</span><span class="p">(),</span>
    <span class="n">artifacts</span><span class="o">=</span><span class="n">artifacts</span><span class="p">,</span>
    <span class="n">conda_env</span><span class="o">=</span><span class="n">conda_env</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Load the model in `python_function` format</span>
<span class="n">loaded_model</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">pyfunc</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">mlflow_pyfunc_model_path</span><span class="p">)</span>

<span class="c1"># Evaluate the model</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">test_predictions</span> <span class="o">=</span> <span class="n">loaded_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">x_test</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">test_predictions</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="custom-flavors">
<span id="id11"></span><h3><a class="toc-backref" href="#id55">Custom Flavors</a><a class="headerlink" href="#custom-flavors" title="Permalink to this headline"> </a></h3>
<p>You can also create custom MLflow Models by writing a custom <em>flavor</em>.</p>
<p>As discussed in the <a class="reference internal" href="#model-api"><span class="std std-ref">Model API</span></a> and <a class="reference internal" href="#model-storage-format"><span class="std std-ref">Storage Format</span></a> sections, an MLflow Model
is defined by a directory of files that contains an <code class="docutils literal notranslate"><span class="pre">MLmodel</span></code> configuration file. This <code class="docutils literal notranslate"><span class="pre">MLmodel</span></code>
file describes various model attributes, including the flavors in which the model can be
interpreted. The <code class="docutils literal notranslate"><span class="pre">MLmodel</span></code> file contains an entry for each flavor name; each entry is
a YAML-formatted collection of flavor-specific attributes.</p>
<p>To create a new flavor to support a custom model, you define the set of flavor-specific attributes
to include in the <code class="docutils literal notranslate"><span class="pre">MLmodel</span></code> configuration file, as well as the code that can interpret the
contents of the model directory and the flavor’s attributes.</p>
<p>As an example, let’s examine the <a class="reference internal" href="python_api/mlflow.pytorch.html#module-mlflow.pytorch" title="mlflow.pytorch"><code class="xref py py-mod docutils literal notranslate"><span class="pre">mlflow.pytorch</span></code></a> module corresponding to MLflow’s
<code class="docutils literal notranslate"><span class="pre">pytorch</span></code> flavor. In the <a class="reference internal" href="python_api/mlflow.pytorch.html#mlflow.pytorch.save_model" title="mlflow.pytorch.save_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.pytorch.save_model()</span></code></a> method, a PyTorch model is saved
to a specified output directory. Additionally, <a class="reference internal" href="python_api/mlflow.pytorch.html#mlflow.pytorch.save_model" title="mlflow.pytorch.save_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.pytorch.save_model()</span></code></a> leverages the
<a class="reference internal" href="python_api/mlflow.models.html#mlflow.models.Model.add_flavor" title="mlflow.models.Model.add_flavor"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.models.Model.add_flavor()</span></code></a> and <a class="reference internal" href="python_api/mlflow.models.html#mlflow.models.Model.save" title="mlflow.models.Model.save"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.models.Model.save()</span></code></a> functions to
produce an <code class="docutils literal notranslate"><span class="pre">MLmodel</span></code> configuration containing the <code class="docutils literal notranslate"><span class="pre">pytorch</span></code> flavor. The resulting configuration
has several flavor-specific attributes, such as <code class="docutils literal notranslate"><span class="pre">pytorch_version</span></code>, which denotes the version of the
PyTorch library that was used to train the model. To interpret model directories produced by
<a class="reference internal" href="python_api/mlflow.pytorch.html#mlflow.pytorch.save_model" title="mlflow.pytorch.save_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">save_model()</span></code></a>, the <a class="reference internal" href="python_api/mlflow.pytorch.html#module-mlflow.pytorch" title="mlflow.pytorch"><code class="xref py py-mod docutils literal notranslate"><span class="pre">mlflow.pytorch</span></code></a> module also
defines a <a class="reference internal" href="python_api/mlflow.pytorch.html#mlflow.pytorch.load_model" title="mlflow.pytorch.load_model"><code class="xref py py-mod docutils literal notranslate"><span class="pre">load_model()</span></code></a> method.
<a class="reference internal" href="python_api/mlflow.pytorch.html#mlflow.pytorch.load_model" title="mlflow.pytorch.load_model"><code class="xref py py-mod docutils literal notranslate"><span class="pre">mlflow.pytorch.load_model()</span></code></a> reads the <code class="docutils literal notranslate"><span class="pre">MLmodel</span></code> configuration from a specified
model directory and uses the configuration attributes of the <code class="docutils literal notranslate"><span class="pre">pytorch</span></code> flavor to load
and return a PyTorch model from its serialized representation.</p>
</div>
</div>
<div class="section" id="built-in-deployment-tools">
<span id="built-in-deployment"></span><h2><a class="toc-backref" href="#id29">Built-In Deployment Tools</a><a class="headerlink" href="#built-in-deployment-tools" title="Permalink to this headline"> </a></h2>
<p>MLflow provides tools for deploying MLflow models on a local machine and to several production environments.
Not all deployment methods are available for all model flavors.</p>
<div class="contents local topic" id="id12">
<p class="topic-title">In this section:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#deploy-mlflow-models" id="id56">Deploy MLflow models</a></p></li>
<li><p><a class="reference internal" href="#deploy-a-python-function-model-on-microsoft-azure-ml" id="id57">Deploy a <code class="docutils literal notranslate"><span class="pre">python_function</span></code> model on Microsoft Azure ML</a></p></li>
<li><p><a class="reference internal" href="#deploy-a-python-function-model-on-amazon-sagemaker" id="id58">Deploy a <code class="docutils literal notranslate"><span class="pre">python_function</span></code> model on Amazon SageMaker</a></p></li>
<li><p><a class="reference internal" href="#export-a-python-function-model-as-an-apache-spark-udf" id="id59">Export a <code class="docutils literal notranslate"><span class="pre">python_function</span></code> model as an Apache Spark UDF</a></p></li>
</ul>
</div>
<div class="section" id="deploy-mlflow-models">
<span id="local-model-deployment"></span><h3><a class="toc-backref" href="#id56">Deploy MLflow models</a><a class="headerlink" href="#deploy-mlflow-models" title="Permalink to this headline"> </a></h3>
<p>MLflow can deploy models locally as local REST API endpoints or to directly score files. In addition,
MLflow can package models as self-contained Docker images with the REST API endpoint. The image can
be used to safely deploy the model to various environments such as Kubernetes.</p>
<p>You deploy MLflow model locally or generate a Docker image using the CLI interface to the
<a class="reference internal" href="python_api/mlflow.models.html#module-mlflow.models" title="mlflow.models"><code class="xref py py-mod docutils literal notranslate"><span class="pre">mlflow.models</span></code></a> module.</p>
<p>The REST API defines 4 endpoints:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">/ping</span></code> used for health check</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/health</span></code> (same as /ping)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/version</span></code> used for getting the mlflow version</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/invocations</span></code> used for scoring</p></li>
</ul>
<p>The REST API server accepts csv or json input. The input format must be specified in
<code class="docutils literal notranslate"><span class="pre">Content-Type</span></code> header. The value of the header must be either <code class="docutils literal notranslate"><span class="pre">application/json</span></code> or
<code class="docutils literal notranslate"><span class="pre">application/csv</span></code>.</p>
<p>The csv input must be a valid pandas.DataFrame csv representation. For example,
<code class="docutils literal notranslate"><span class="pre">data</span> <span class="pre">=</span> <span class="pre">pandas_df.to_csv()</span></code>.</p>
<p>The json input must be a dictionary with exactly one of the following fields that further specify
the type and encoding of the input data</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">dataframe_split</span></code> field with pandas DataFrames in the <code class="docutils literal notranslate"><span class="pre">split</span></code> orientation. For example,
<code class="docutils literal notranslate"><span class="pre">data</span> <span class="pre">=</span> <span class="pre">{&quot;dataframe_split&quot;:</span> <span class="pre">pandas_df.to_dict(orient='split')</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dataframe_records</span></code> field with pandas DataFrame in the <code class="docutils literal notranslate"><span class="pre">records</span></code> orientation. For example,
<code class="docutils literal notranslate"><span class="pre">data</span> <span class="pre">=</span> <span class="pre">{&quot;dataframe_records&quot;:</span> <span class="pre">pandas_df.to_dict(orient='records')</span></code>.*We do not
recommend using this format because it is not guaranteed to preserve column ordering.*</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">instances</span></code> field with tensor input formatted as described in <a class="reference external" href="https://www.tensorflow.org/tfx/serving/api_rest#request_format_2">TF Serving’s API docs</a> where the provided inputs
will be cast to Numpy arrays.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">inputs</span></code> field with tensor input formatted as described in <a class="reference external" href="https://www.tensorflow.org/tfx/serving/api_rest#request_format_2">TF Serving’s API docs</a> where the provided inputs
will be cast to Numpy arrays.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Since JSON loses type information, MLflow will cast the JSON input to the input type specified
in the model’s schema if available. If your model is sensitive to input types, it is recommended that
a schema is provided for the model to ensure that type mismatch errors do not occur at inference time.
In particular, DL models are typically strict about input types and will need model schema in order
for the model to score correctly. For complex data types, see <a class="reference internal" href="#encoding-complex-data"><span class="std std-ref">Encoding complex data</span></a> below.</p>
</div>
<p>Example requests:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># split-oriented DataFrame input</span>
curl<span class="w"> </span>http://127.0.0.1:5000/invocations<span class="w"> </span>-H<span class="w"> </span><span class="s1">&#39;Content-Type: application/json&#39;</span><span class="w"> </span>-d<span class="w"> </span><span class="s1">&#39;{</span>
<span class="s1">  &quot;dataframe_split&quot;: {</span>
<span class="s1">      &quot;columns&quot;: [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;],</span>
<span class="s1">      &quot;data&quot;: [[1, 2, 3], [4, 5, 6]]</span>
<span class="s1">  }</span>
<span class="s1">}&#39;</span>

<span class="c1"># record-oriented DataFrame input (fine for vector rows, loses ordering for JSON records)</span>
curl<span class="w"> </span>http://127.0.0.1:5000/invocations<span class="w"> </span>-H<span class="w"> </span><span class="s1">&#39;Content-Type: application/json&#39;</span><span class="w"> </span>-d<span class="w"> </span><span class="s1">&#39;{</span>
<span class="s1">  &quot;dataframe_records&quot;: [</span>
<span class="s1">    {&quot;a&quot;: 1,&quot;b&quot;: 2,&quot;c&quot;: 3},</span>
<span class="s1">    {&quot;a&quot;: 4,&quot;b&quot;: 5,&quot;c&quot;: 6}</span>
<span class="s1">  ]</span>
<span class="s1">}&#39;</span>

<span class="c1"># numpy/tensor input using TF serving&#39;s &quot;instances&quot; format</span>
curl<span class="w"> </span>http://127.0.0.1:5000/invocations<span class="w"> </span>-H<span class="w"> </span><span class="s1">&#39;Content-Type: application/json&#39;</span><span class="w"> </span>-d<span class="w"> </span><span class="s1">&#39;{</span>
<span class="s1">    &quot;instances&quot;: [</span>
<span class="s1">        {&quot;a&quot;: &quot;s1&quot;, &quot;b&quot;: 1, &quot;c&quot;: [1, 2, 3]},</span>
<span class="s1">        {&quot;a&quot;: &quot;s2&quot;, &quot;b&quot;: 2, &quot;c&quot;: [4, 5, 6]},</span>
<span class="s1">        {&quot;a&quot;: &quot;s3&quot;, &quot;b&quot;: 3, &quot;c&quot;: [7, 8, 9]}</span>
<span class="s1">    ]</span>
<span class="s1">}&#39;</span>

<span class="c1"># numpy/tensor input using TF serving&#39;s &quot;inputs&quot; format</span>
curl<span class="w"> </span>http://127.0.0.1:5000/invocations<span class="w"> </span>-H<span class="w"> </span><span class="s1">&#39;Content-Type: application/json&#39;</span><span class="w"> </span>-d<span class="w"> </span><span class="s1">&#39;{</span>
<span class="s1">    &quot;inputs&quot;: {&quot;a&quot;: [&quot;s1&quot;, &quot;s2&quot;, &quot;s3&quot;], &quot;b&quot;: [1, 2, 3], &quot;c&quot;: [[1, 2, 3], [4, 5, 6], [7, 8, 9]]}</span>
<span class="s1">}&#39;</span>
</pre></div>
</div>
<p>For more information about serializing pandas DataFrames, see
<a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/generated/pandas.DataFrame.to_json.html">pandas.DataFrame.to_json</a>.</p>
<p>For more information about serializing tensor inputs using the TF serving format, see
<a class="reference external" href="https://www.tensorflow.org/tfx/serving/api_rest#request_format_2">TF serving’s request format docs</a>.</p>
<div class="section" id="serving-with-mlserver">
<span id="id14"></span><h4>Serving with MLServer<a class="headerlink" href="#serving-with-mlserver" title="Permalink to this headline"> </a></h4>
<p>Python models can be deployed using <a class="reference external" href="https://mlserver.readthedocs.io/en/latest/">Seldon’s MLServer</a> as alternative inference server.
MLServer is integrated with two leading open source model deployment tools,
<a class="reference external" href="https://docs.seldon.io/projects/seldon-core/en/latest/graph/protocols.html#v2-kfserving-protocol">Seldon Core</a>
and <a class="reference external" href="https://kserve.github.io/website/modelserving/v1beta1/sklearn/v2/">KServe (formerly known as KFServing)</a>, and can
be used to test and deploy models using these frameworks.
This is especially powerful when building docker images since the docker image
built with MLServer can be deployed directly with both of these frameworks.</p>
<p>MLServer exposes the same scoring API through the <code class="docutils literal notranslate"><span class="pre">/invocations</span></code> endpoint.
In addition, it supports the standard <a class="reference external" href="https://docs.seldon.io/projects/seldon-core/en/latest/reference/apis/v2-protocol.html">V2 Inference Protocol</a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To use MLServer with MLflow, please install <code class="docutils literal notranslate"><span class="pre">mlflow</span></code> as:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pip<span class="w"> </span>install<span class="w"> </span>mlflow<span class="o">[</span>extras<span class="o">]</span>
</pre></div>
</div>
</div>
<p>To serve a MLflow model using MLServer, you can use the <code class="docutils literal notranslate"><span class="pre">--enable-mlserver</span></code> flag,
such as:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mlflow<span class="w"> </span>models<span class="w"> </span>serve<span class="w"> </span>-m<span class="w"> </span>my_model<span class="w"> </span>--enable-mlserver
</pre></div>
</div>
<p>Similarly, to build a Docker image built with MLServer you can use the
<code class="docutils literal notranslate"><span class="pre">--enable-mlserver</span></code> flag, such as:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mlflow<span class="w"> </span>models<span class="w"> </span>build<span class="w"> </span>-m<span class="w"> </span>my_model<span class="w"> </span>--enable-mlserver<span class="w"> </span>-n<span class="w"> </span>my-model
</pre></div>
</div>
<p>To read more about the integration between MLflow and MLServer, please check
the <a class="reference external" href="https://mlserver.readthedocs.io/en/latest/examples/mlflow/README.html">end-to-end example in the MLServer documentation</a> or
visit the <a class="reference external" href="https://mlserver.readthedocs.io/en/latest/">MLServer docs</a>.</p>
</div>
<div class="section" id="encoding-complex-data">
<span id="id15"></span><h4>Encoding complex data<a class="headerlink" href="#encoding-complex-data" title="Permalink to this headline"> </a></h4>
<p>Complex data types, such as dates or binary, do not have a native JSON representation. If you include a model
signature, MLflow can automatically decode supported data types from JSON. The following data type conversions
are supported:</p>
<ul class="simple">
<li><p>binary: data is expected to be base64 encoded, MLflow will automatically base64 decode.</p></li>
<li><p>datetime: data is expected as string according to
<a class="reference external" href="https://www.iso.org/iso-8601-date-and-time-format.html">ISO 8601 specification</a>.
MLflow will parse this into the appropriate datetime representation on the given platform.</p></li>
</ul>
<p>Example requests:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># record-oriented DataFrame input with binary column &quot;b&quot;</span>
curl<span class="w"> </span>http://127.0.0.1:5000/invocations<span class="w"> </span>-H<span class="w"> </span><span class="s1">&#39;Content-Type: application/json&#39;</span><span class="w"> </span>-d<span class="w"> </span><span class="s1">&#39;[</span>
<span class="s1">    {&quot;a&quot;: 0, &quot;b&quot;: &quot;dGVzdCBiaW5hcnkgZGF0YSAw&quot;},</span>
<span class="s1">    {&quot;a&quot;: 1, &quot;b&quot;: &quot;dGVzdCBiaW5hcnkgZGF0YSAx&quot;},</span>
<span class="s1">    {&quot;a&quot;: 2, &quot;b&quot;: &quot;dGVzdCBiaW5hcnkgZGF0YSAy&quot;}</span>
<span class="s1">]&#39;</span>

<span class="c1"># record-oriented DataFrame input with datetime column &quot;b&quot;</span>
curl<span class="w"> </span>http://127.0.0.1:5000/invocations<span class="w"> </span>-H<span class="w"> </span><span class="s1">&#39;Content-Type: application/json&#39;</span><span class="w"> </span>-d<span class="w"> </span><span class="s1">&#39;[</span>
<span class="s1">    {&quot;a&quot;: 0, &quot;b&quot;: &quot;2020-01-01T00:00:00Z&quot;},</span>
<span class="s1">    {&quot;a&quot;: 1, &quot;b&quot;: &quot;2020-02-01T12:34:56Z&quot;},</span>
<span class="s1">    {&quot;a&quot;: 2, &quot;b&quot;: &quot;2021-03-01T00:00:00Z&quot;}</span>
<span class="s1">]&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="command-line-interface">
<h4>Command Line Interface<a class="headerlink" href="#command-line-interface" title="Permalink to this headline"> </a></h4>
<p>MLflow also has a CLI that supports the following commands:</p>
<ul class="simple">
<li><p><a class="reference external" href="cli.html#mlflow-models-serve">serve</a> deploys the model as a local REST API server.</p></li>
<li><p><a class="reference external" href="cli.html#mlflow-models-build-docker">build_docker</a> packages a REST API endpoint serving the
model as a docker image.</p></li>
<li><p><a class="reference external" href="cli.html#mlflow-models-predict">predict</a> uses the model to generate a prediction for a local
CSV or JSON file. Note that this method only supports DataFrame input.</p></li>
</ul>
<p>For more info, see:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mlflow<span class="w"> </span>models<span class="w"> </span>--help
mlflow<span class="w"> </span>models<span class="w"> </span>serve<span class="w"> </span>--help
mlflow<span class="w"> </span>models<span class="w"> </span>predict<span class="w"> </span>--help
mlflow<span class="w"> </span>models<span class="w"> </span>build-docker<span class="w"> </span>--help
</pre></div>
</div>
</div>
<div class="section" id="environment-management-tools">
<h4>Environment Management Tools<a class="headerlink" href="#environment-management-tools" title="Permalink to this headline"> </a></h4>
<p>MLflow currently supports the following environment management tools to restore model environments:</p>
<dl>
<dt>local</dt><dd><p>Use the local environment. No extra tools are required.</p>
</dd>
<dt>virtualenv (preferred)</dt><dd><p>Create environments using virtualenv and pyenv (for python version management). Virtualenv and
pyenv (for Linux and macOS) or pyenv-win (for Windows) must be installed for this mode of environment reconstruction.</p>
<ul class="simple">
<li><p><a class="reference external" href="https://virtualenv.pypa.io/en/latest/installation.html">virtualenv installation instructions</a></p></li>
<li><p><a class="reference external" href="https://github.com/pyenv/pyenv#installation">pyenv installation instructions</a></p></li>
<li><p><a class="reference external" href="https://github.com/pyenv-win/pyenv-win#installation">pyenv-win installation instructions</a></p></li>
</ul>
</dd>
<dt>conda</dt><dd><p>Create environments using conda. Conda must be installed for this mode of environment reconstruction.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>By using conda, you’re responsible for adhering to <a class="reference external" href="https://legal.anaconda.com/policies/en/?name=terms-of-service">Anaconda’s terms of service</a>.</p>
</div>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.conda.io/projects/conda/en/latest/user-guide/install/index.html">conda installation instructions</a></p></li>
</ul>
</dd>
</dl>
<p>The <code class="docutils literal notranslate"><span class="pre">mlflow</span> <span class="pre">models</span></code> CLI commands provide an optional <code class="docutils literal notranslate"><span class="pre">--env-manager</span></code> argument that selects a specific environment management configuration to be used, as shown below:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use virtualenv</span>
mlflow<span class="w"> </span>models<span class="w"> </span>predict<span class="w"> </span>...<span class="w"> </span>--env-manager<span class="o">=</span>virtualenv
<span class="c1"># Use conda</span>
mlflow<span class="w"> </span>models<span class="w"> </span>serve<span class="w"> </span>...<span class="w"> </span>--env-manager<span class="o">=</span>conda
</pre></div>
</div>
</div>
</div>
<div class="section" id="deploy-a-python-function-model-on-microsoft-azure-ml">
<span id="azureml-deployment"></span><h3><a class="toc-backref" href="#id57">Deploy a <code class="docutils literal notranslate"><span class="pre">python_function</span></code> model on Microsoft Azure ML</a><a class="headerlink" href="#deploy-a-python-function-model-on-microsoft-azure-ml" title="Permalink to this headline"> </a></h3>
<p>The MLflow plugin <a class="reference external" href="https://pypi.org/project/azureml-mlflow/">azureml-mlflow</a> can deploy models to Azure ML, either to Azure Kubernetes Service (AKS) or Azure Container Instances (ACI) for real-time serving.</p>
<p>The resulting deployment accepts the following data formats as input:</p>
<ul class="simple">
<li><p>JSON-serialized pandas DataFrames in the <code class="docutils literal notranslate"><span class="pre">split</span></code> orientation. For example, <code class="docutils literal notranslate"><span class="pre">data</span> <span class="pre">=</span> <span class="pre">pandas_df.to_json(orient='split')</span></code>. This format is specified using a <code class="docutils literal notranslate"><span class="pre">Content-Type</span></code> request header value of <code class="docutils literal notranslate"><span class="pre">application/json</span></code>.</p></li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The <code class="docutils literal notranslate"><span class="pre">TensorSpec</span></code> input format is not fully supported for deployments on Azure Machine Learning at the moment. Be aware that many <code class="docutils literal notranslate"><span class="pre">autolog()</span></code> implementations may use <code class="docutils literal notranslate"><span class="pre">TensorSpec</span></code> for model’s signatures when logging models and hence those deployments will fail in Azure ML.</p>
</div>
<p>Deployments can be generated using both the Python API or MLflow CLI. In both cases, a <code class="docutils literal notranslate"><span class="pre">JSON</span></code> configuration file can be indicated with the details of the deployment you want to achieve. If not indicated, then a default deployment is done using Azure Container Instances (ACI) and a minimal configuration. The full specification of this configuration file can be checked at <a class="reference external" href="https://docs.microsoft.com/en-us/azure/machine-learning/reference-azure-machine-learning-cli#deployment-configuration-schema">Deployment configuration schema</a>. Also, you will also need the Azure ML MLflow Tracking URI of your particular Azure ML Workspace where you want to deploy your model. You can obtain this URI in several ways:</p>
<ul class="simple">
<li><p>Through the <a class="reference external" href="https://ml.azure.com">Azure ML Studio</a>:</p>
<ul>
<li><p>Navigate to <a class="reference external" href="https://ml.azure.com">Azure ML Studio</a> and select the workspace you are working on.</p></li>
<li><p>Click on the name of the workspace at the upper right corner of the page.</p></li>
<li><p>Click “View all properties in Azure Portal” on the pane popup.</p></li>
<li><p>Copy the <code class="docutils literal notranslate"><span class="pre">MLflow</span> <span class="pre">tracking</span> <span class="pre">URI</span></code> value from the properties section.</p></li>
</ul>
</li>
<li><p>Programmatically, using Azure ML SDK with the method <a class="reference external" href="https://docs.microsoft.com/en-us/python/api/azureml-core/azureml.core.workspace.workspace?view=azure-ml-py#azureml-core-workspace-workspace-get-mlflow-tracking-uri">Workspace.get_mlflow_tracking_uri()</a>. If you are running inside Azure ML Compute, like for instance a Compute Instance, you can get this value also from the environment variable <code class="docutils literal notranslate"><span class="pre">os.environ[&quot;MLFLOW_TRACKING_URI&quot;]</span></code>.</p></li>
<li><p>Manually, for a given Subscription ID, Resource Group and Azure ML Workspace, the URI is as follows: <code class="docutils literal notranslate"><span class="pre">azureml://eastus.api.azureml.ms/mlflow/v1.0/subscriptions/&lt;SUBSCRIPTION_ID&gt;/resourceGroups/&lt;RESOURCE_GROUP_NAME&gt;/providers/Microsoft.MachineLearningServices/workspaces/&lt;WORKSPACE_NAME&gt;</span></code></p></li>
</ul>
<p class="rubric">Configuration example for ACI deployment</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;computeType&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;aci&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;containerResourceRequirements&quot;</span><span class="p">:</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;cpu&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;memoryInGB&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;location&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;eastus2&quot;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<dl class="simple">
<dt>Remarks:</dt><dd><ul class="simple">
<li><p>If <code class="docutils literal notranslate"><span class="pre">containerResourceRequirements</span></code> is not indicated, a deployment with minimal compute configuration is applied (<code class="docutils literal notranslate"><span class="pre">cpu:</span> <span class="pre">0.1</span></code> and <code class="docutils literal notranslate"><span class="pre">memory:</span> <span class="pre">0.5</span></code>).</p></li>
<li><p>If <code class="docutils literal notranslate"><span class="pre">location</span></code> is not indicated, it defaults to the location of the workspace.</p></li>
</ul>
</dd>
</dl>
<p class="rubric">Configuration example for an AKS deployment</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;computeType&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;aks&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;computeTargetName&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;aks-mlflow&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<dl class="simple">
<dt>Remarks:</dt><dd><ul class="simple">
<li><p>In above example, <code class="docutils literal notranslate"><span class="pre">aks-mlflow</span></code> is the name of an Azure Kubernetes Cluster registered/created in Azure Machine Learning.</p></li>
</ul>
</dd>
</dl>
<p>The following examples show how to create a deployment in ACI. Please, ensure you have <a class="reference external" href="https://pypi.org/project/azureml-mlflow/">azureml-mlflow</a> installed before continuing.</p>
<p class="rubric">Example: Workflow using the Python API</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">mlflow.deployments</span> <span class="kn">import</span> <span class="n">get_deploy_client</span>

<span class="c1"># Create the deployment configuration.</span>
<span class="c1"># If no deployment configuration is provided, then the deployment happens on ACI.</span>
<span class="n">deploy_config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;computeType&quot;</span><span class="p">:</span> <span class="s2">&quot;aci&quot;</span><span class="p">}</span>

<span class="c1"># Write the deployment configuration into a file.</span>
<span class="n">deployment_config_path</span> <span class="o">=</span> <span class="s2">&quot;deployment_config.json&quot;</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">deployment_config_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
    <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">deploy_config</span><span class="p">))</span>

<span class="c1"># Set the tracking uri in the deployment client.</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">get_deploy_client</span><span class="p">(</span><span class="s2">&quot;&lt;azureml-mlflow-tracking-url&gt;&quot;</span><span class="p">)</span>

<span class="c1"># MLflow requires the deployment configuration to be passed as a dictionary.</span>
<span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;deploy-config-file&quot;</span><span class="p">:</span> <span class="n">deployment_config_path</span><span class="p">}</span>
<span class="n">model_name</span> <span class="o">=</span> <span class="s2">&quot;mymodel&quot;</span>
<span class="n">model_version</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># define the model path and the name is the service name</span>
<span class="c1"># if model is not registered, it gets registered automatically and a name is autogenerated using the &quot;name&quot; parameter below</span>
<span class="n">client</span><span class="o">.</span><span class="n">create_deployment</span><span class="p">(</span>
    <span class="n">model_uri</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;models:/</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">model_version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;mymodel-aci-deployment&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># After the model deployment completes, requests can be posted via HTTP to the new ACI</span>
<span class="c1"># webservice&#39;s scoring URI.</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Scoring URI is: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">webservice</span><span class="o">.</span><span class="n">scoring_uri</span><span class="p">)</span>

<span class="c1"># The following example posts a sample input from the wine dataset</span>
<span class="c1"># used in the MLflow ElasticNet example:</span>
<span class="c1"># https://github.com/mlflow/mlflow/tree/master/examples/sklearn_elasticnet_wine</span>

<span class="c1"># `sample_input` is a JSON-serialized pandas DataFrame with the `split` orientation</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="c1"># `sample_input` is a JSON-serialized pandas DataFrame with the `split` orientation</span>
<span class="n">sample_input</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;columns&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;alcohol&quot;</span><span class="p">,</span>
        <span class="s2">&quot;chlorides&quot;</span><span class="p">,</span>
        <span class="s2">&quot;citric acid&quot;</span><span class="p">,</span>
        <span class="s2">&quot;density&quot;</span><span class="p">,</span>
        <span class="s2">&quot;fixed acidity&quot;</span><span class="p">,</span>
        <span class="s2">&quot;free sulfur dioxide&quot;</span><span class="p">,</span>
        <span class="s2">&quot;pH&quot;</span><span class="p">,</span>
        <span class="s2">&quot;residual sugar&quot;</span><span class="p">,</span>
        <span class="s2">&quot;sulphates&quot;</span><span class="p">,</span>
        <span class="s2">&quot;total sulfur dioxide&quot;</span><span class="p">,</span>
        <span class="s2">&quot;volatile acidity&quot;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="mf">8.8</span><span class="p">,</span> <span class="mf">0.045</span><span class="p">,</span> <span class="mf">0.36</span><span class="p">,</span> <span class="mf">1.001</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mf">20.7</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mf">0.27</span><span class="p">]],</span>
<span class="p">}</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
    <span class="n">url</span><span class="o">=</span><span class="n">webservice</span><span class="o">.</span><span class="n">scoring_uri</span><span class="p">,</span>
    <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">sample_input</span><span class="p">),</span>
    <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Content-type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">},</span>
<span class="p">)</span>
<span class="n">response_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">response_json</span><span class="p">)</span>
</pre></div>
</div>
<p class="rubric">Example: Workflow using the MLflow CLI</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;{ computeType: aci }&quot;</span><span class="w"> </span>&gt;<span class="w"> </span>deployment_config.json
mlflow<span class="w"> </span>deployments<span class="w"> </span>create<span class="w"> </span>--name<span class="w"> </span>&lt;deployment-name&gt;<span class="w"> </span>-m<span class="w"> </span>models:/&lt;model-name&gt;/&lt;model-version&gt;<span class="w"> </span>-t<span class="w"> </span>&lt;azureml-mlflow-tracking-url&gt;<span class="w"> </span>--deploy-config-file<span class="w"> </span>deployment_config.json

<span class="c1"># After the deployment completes, requests can be posted via HTTP to the new ACI</span>
<span class="c1"># webservice&#39;s scoring URI.</span>

<span class="nv">scoring_uri</span><span class="o">=</span><span class="k">$(</span>az<span class="w"> </span>ml<span class="w"> </span>service<span class="w"> </span>show<span class="w"> </span>--name<span class="w"> </span>&lt;deployment-name&gt;<span class="w"> </span>-v<span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span>-r<span class="w"> </span><span class="s2">&quot;.scoringUri&quot;</span><span class="k">)</span>

<span class="c1"># The following example posts a sample input from the wine dataset</span>
<span class="c1"># used in the MLflow ElasticNet example:</span>
<span class="c1"># https://github.com/mlflow/mlflow/tree/master/examples/sklearn_elasticnet_wine</span>

<span class="c1"># `sample_input` is a JSON-serialized pandas DataFrame with the `split` orientation</span>
<span class="nv">sample_input</span><span class="o">=</span><span class="s1">&#39;</span>
<span class="s1">{</span>
<span class="s1">    &quot;columns&quot;: [</span>
<span class="s1">        &quot;alcohol&quot;,</span>
<span class="s1">        &quot;chlorides&quot;,</span>
<span class="s1">        &quot;citric acid&quot;,</span>
<span class="s1">        &quot;density&quot;,</span>
<span class="s1">        &quot;fixed acidity&quot;,</span>
<span class="s1">        &quot;free sulfur dioxide&quot;,</span>
<span class="s1">        &quot;pH&quot;,</span>
<span class="s1">        &quot;residual sugar&quot;,</span>
<span class="s1">        &quot;sulphates&quot;,</span>
<span class="s1">        &quot;total sulfur dioxide&quot;,</span>
<span class="s1">        &quot;volatile acidity&quot;</span>
<span class="s1">    ],</span>
<span class="s1">    &quot;data&quot;: [</span>
<span class="s1">        [8.8, 0.045, 0.36, 1.001, 7, 45, 3, 20.7, 0.45, 170, 0.27]</span>
<span class="s1">    ]</span>
<span class="s1">}&#39;</span>

<span class="nb">echo</span><span class="w"> </span><span class="nv">$sample_input</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>curl<span class="w"> </span>-s<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span><span class="nv">$scoring_uri</span><span class="se">\</span>
-H<span class="w"> </span><span class="s1">&#39;Cache-Control: no-cache&#39;</span><span class="se">\</span>
-H<span class="w"> </span><span class="s1">&#39;Content-Type: application/json&#39;</span><span class="se">\</span>
-d<span class="w"> </span>@-
</pre></div>
</div>
<p>You can also test your deployments locally first using the option <cite>run-local</cite>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mlflow<span class="w"> </span>deployments<span class="w"> </span>run-local<span class="w"> </span>--name<span class="w"> </span>&lt;deployment-name&gt;<span class="w"> </span>-m<span class="w"> </span>models:/&lt;model-name&gt;/&lt;model-version&gt;<span class="w"> </span>-t<span class="w"> </span>&lt;azureml-mlflow-tracking-url&gt;
</pre></div>
</div>
<p>For more info, see:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mlflow<span class="w"> </span>deployments<span class="w"> </span><span class="nb">help</span><span class="w"> </span>-t<span class="w"> </span>azureml
</pre></div>
</div>
</div>
<div class="section" id="deploy-a-python-function-model-on-amazon-sagemaker">
<span id="sagemaker-deployment"></span><h3><a class="toc-backref" href="#id58">Deploy a <code class="docutils literal notranslate"><span class="pre">python_function</span></code> model on Amazon SageMaker</a><a class="headerlink" href="#deploy-a-python-function-model-on-amazon-sagemaker" title="Permalink to this headline"> </a></h3>
<p>The <a class="reference internal" href="python_api/mlflow.deployments.html#module-mlflow.deployments" title="mlflow.deployments"><code class="xref py py-mod docutils literal notranslate"><span class="pre">mlflow.deployments</span></code></a> and <a class="reference internal" href="python_api/mlflow.sagemaker.html#module-mlflow.sagemaker" title="mlflow.sagemaker"><code class="xref py py-mod docutils literal notranslate"><span class="pre">mlflow.sagemaker</span></code></a> modules can deploy
<code class="docutils literal notranslate"><span class="pre">python_function</span></code> models locally in a Docker container with SageMaker compatible environment and
remotely on SageMaker. To deploy remotely to SageMaker you need to set up your environment and user
accounts. To export a custom model to SageMaker, you need a MLflow-compatible Docker image to be
available on Amazon ECR. MLflow provides a default Docker image definition; however, it is up to you
to build the image and upload it to ECR. MLflow includes the utility function
<code class="docutils literal notranslate"><span class="pre">build_and_push_container</span></code> to perform this step. Once built and uploaded, you can use the MLflow
container for all MLflow Models. Model webservers deployed using the <a class="reference internal" href="python_api/mlflow.deployments.html#module-mlflow.deployments" title="mlflow.deployments"><code class="xref py py-mod docutils literal notranslate"><span class="pre">mlflow.deployments</span></code></a>
module accept the following data formats as input, depending on the deployment flavor:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">python_function</span></code>: For this deployment flavor, the endpoint accepts the same formats described
in the <a class="reference internal" href="#local-model-deployment"><span class="std std-ref">local model deployment documentation</span></a>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mleap</span></code>: For this deployment flavor, the endpoint accepts <cite>only</cite>
JSON-serialized pandas DataFrames in the <code class="docutils literal notranslate"><span class="pre">split</span></code> orientation. For example,
<code class="docutils literal notranslate"><span class="pre">data</span> <span class="pre">=</span> <span class="pre">pandas_df.to_json(orient='split')</span></code>. This format is specified using a <code class="docutils literal notranslate"><span class="pre">Content-Type</span></code>
request header value of <code class="docutils literal notranslate"><span class="pre">application/json</span></code>.</p></li>
</ul>
<div class="section" id="commands">
<h4>Commands<a class="headerlink" href="#commands" title="Permalink to this headline"> </a></h4>
<ul class="simple">
<li><p><a class="reference internal" href="python_api/mlflow.sagemaker.html#mlflow.sagemaker.run_local" title="mlflow.sagemaker.run_local"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow</span> <span class="pre">deployments</span> <span class="pre">run-local</span> <span class="pre">-t</span> <span class="pre">sagemaker</span></code></a> deploys the
model locally in a Docker container. The image and the environment should be identical to how the
model would be run remotely and it is therefore useful for testing the model prior to deployment.</p></li>
<li><p><a class="reference external" href="cli.html#mlflow-sagemaker-build-and-push-container">mlflow sagemaker build-and-push-container</a>
builds an MLfLow Docker image and uploads it to ECR. The caller must have the correct permissions
set up. The image is built locally and requires Docker to be present on the machine that performs
this step.</p></li>
<li><p><a class="reference internal" href="python_api/mlflow.sagemaker.html#mlflow.sagemaker.SageMakerDeploymentClient.create_deployment" title="mlflow.sagemaker.SageMakerDeploymentClient.create_deployment"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow</span> <span class="pre">deployments</span> <span class="pre">create</span> <span class="pre">-t</span> <span class="pre">sagemaker</span></code></a>
deploys the model on Amazon SageMaker. MLflow uploads the Python Function model into S3 and starts
an Amazon SageMaker endpoint serving the model.</p></li>
</ul>
<p class="rubric">Example workflow using the MLflow CLI</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mlflow<span class="w"> </span>sagemaker<span class="w"> </span>build-and-push-container<span class="w">  </span><span class="c1"># build the container (only needs to be called once)</span>
mlflow<span class="w"> </span>deployments<span class="w"> </span>run-local<span class="w"> </span>-t<span class="w"> </span>sagemaker<span class="w"> </span>--name<span class="w"> </span>&lt;deployment-name&gt;<span class="w"> </span>-m<span class="w"> </span>&lt;path-to-model&gt;<span class="w">  </span><span class="c1"># test the model locally</span>
mlflow<span class="w"> </span>deployments<span class="w"> </span>sagemaker<span class="w"> </span>create<span class="w"> </span>-t<span class="w">  </span><span class="c1"># deploy the model remotely</span>
</pre></div>
</div>
<p>For more info, see:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mlflow<span class="w"> </span>sagemaker<span class="w"> </span>--help
mlflow<span class="w"> </span>sagemaker<span class="w"> </span>build-and-push-container<span class="w"> </span>--help
mlflow<span class="w"> </span>deployments<span class="w"> </span>run-local<span class="w"> </span>--help
mlflow<span class="w"> </span>deployments<span class="w"> </span><span class="nb">help</span><span class="w"> </span>-t<span class="w"> </span>sagemaker
</pre></div>
</div>
</div>
</div>
<div class="section" id="export-a-python-function-model-as-an-apache-spark-udf">
<h3><a class="toc-backref" href="#id59">Export a <code class="docutils literal notranslate"><span class="pre">python_function</span></code> model as an Apache Spark UDF</a><a class="headerlink" href="#export-a-python-function-model-as-an-apache-spark-udf" title="Permalink to this headline"> </a></h3>
<p>You can output a <code class="docutils literal notranslate"><span class="pre">python_function</span></code> model as an Apache Spark UDF, which can be uploaded to a
Spark cluster and used to score the model.</p>
<p class="rubric">Example</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">struct</span>
<span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>

<span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
<span class="n">pyfunc_udf</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">pyfunc</span><span class="o">.</span><span class="n">spark_udf</span><span class="p">(</span><span class="n">spark</span><span class="p">,</span> <span class="s2">&quot;&lt;path-to-model&gt;&quot;</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">spark_df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;prediction&quot;</span><span class="p">,</span> <span class="n">pyfunc_udf</span><span class="p">(</span><span class="n">struct</span><span class="p">([</span><span class="o">...</span><span class="p">])))</span>
</pre></div>
</div>
<p>If a model contains a signature, the UDF can be called without specifying column name arguments.
In this case, the UDF will be called with column names from signature, so the evaluation
dataframe’s column names must match the model signature’s column names.</p>
<p class="rubric">Example</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>

<span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
<span class="n">pyfunc_udf</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">pyfunc</span><span class="o">.</span><span class="n">spark_udf</span><span class="p">(</span><span class="n">spark</span><span class="p">,</span> <span class="s2">&quot;&lt;path-to-model-with-signature&gt;&quot;</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">spark_df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;prediction&quot;</span><span class="p">,</span> <span class="n">pyfunc_udf</span><span class="p">())</span>
</pre></div>
</div>
<p>If a model contains a signature with tensor spec inputs,
you will need to pass a column of array type as a corresponding UDF argument.
The values in this column must be comprised of one-dimensional arrays. The
UDF will reshape the array values to the required shape with ‘C’ order
(i.e. read / write the elements using C-like index order) and cast the values
as the required tensor spec type. For example, assuming a model
requires input ‘a’ of shape (-1, 2, 3) and input ‘b’ of shape (-1, 4, 5). In order to
perform inference on this data, we need to prepare a Spark DataFrame with column ‘a’
containing arrays of length 6 and column ‘b’ containing arrays of length 20. We can then
invoke the UDF like following example code:</p>
<p class="rubric">Example</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>

<span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
<span class="c1"># Assuming the model requires input &#39;a&#39; of shape (-1, 2, 3) and input &#39;b&#39; of shape (-1, 4, 5)</span>
<span class="n">model_path</span> <span class="o">=</span> <span class="s2">&quot;&lt;path-to-model-requiring-multidimensional-inputs&gt;&quot;</span>
<span class="n">pyfunc_udf</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">pyfunc</span><span class="o">.</span><span class="n">spark_udf</span><span class="p">(</span><span class="n">spark</span><span class="p">,</span> <span class="n">model_path</span><span class="p">)</span>
<span class="c1"># The `spark_df` has column &#39;a&#39; containing arrays of length 6 and</span>
<span class="c1"># column &#39;b&#39; containing arrays of length 20</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">spark_df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;prediction&quot;</span><span class="p">,</span> <span class="n">pyfunc_udf</span><span class="p">(</span><span class="n">struct</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">)))</span>
</pre></div>
</div>
<p>The resulting UDF is based on Spark’s Pandas UDF and is currently limited to producing either a single
value, an array of values, or a struct containing multiple field values
of the same type per observation. By default, we return the first
numeric column as a double. You can control what result is returned by supplying <code class="docutils literal notranslate"><span class="pre">result_type</span></code>
argument. The following values are supported:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">'int'</span></code> or <a class="reference external" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.types.IntegerType.html#pyspark.sql.types.IntegerType">IntegerType</a>: The leftmost integer that can fit in
<code class="docutils literal notranslate"><span class="pre">int32</span></code> result is returned or an exception is raised if there are none.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">'long'</span></code> or <a class="reference external" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.types.LongType.html#pyspark.sql.types.LongType">LongType</a>: The leftmost long integer that can fit in <code class="docutils literal notranslate"><span class="pre">int64</span></code>
result is returned or an exception is raised if there are none.</p></li>
<li><p><a class="reference external" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.types.ArrayType.html#pyspark.sql.types.ArrayType">ArrayType</a> (<a class="reference external" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.types.IntegerType.html#pyspark.sql.types.IntegerType">IntegerType</a> | <a class="reference external" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.types.LongType.html#pyspark.sql.types.LongType">LongType</a>): Return all integer columns that can fit
into the requested size.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">'float'</span></code> or <a class="reference external" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.types.FloatType.html#pyspark.sql.types.FloatType">FloatType</a>: The leftmost numeric result cast to
<code class="docutils literal notranslate"><span class="pre">float32</span></code> is returned or an exception is raised if there are no numeric columns.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">'double'</span></code> or <a class="reference external" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.types.DoubleType.html#pyspark.sql.types.DoubleType">DoubleType</a>: The leftmost numeric result cast to
<code class="docutils literal notranslate"><span class="pre">double</span></code> is returned or an exception is raised if there are no numeric columns.</p></li>
<li><p><a class="reference external" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.types.ArrayType.html#pyspark.sql.types.ArrayType">ArrayType</a> ( <a class="reference external" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.types.FloatType.html#pyspark.sql.types.FloatType">FloatType</a> | <a class="reference external" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.types.DoubleType.html#pyspark.sql.types.DoubleType">DoubleType</a> ): Return all numeric columns cast to the
requested type. An exception is raised if there are no numeric columns.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">'string'</span></code> or <a class="reference external" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.types.StringType.html#pyspark.sql.types.StringType">StringType</a>: Result is the leftmost column cast as string.</p></li>
<li><p><a class="reference external" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.types.ArrayType.html#pyspark.sql.types.ArrayType">ArrayType</a> ( <a class="reference external" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.types.StringType.html#pyspark.sql.types.StringType">StringType</a> ): Return all columns cast as string.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">'bool'</span></code> or <code class="docutils literal notranslate"><span class="pre">'boolean'</span></code> or <a class="reference external" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.types.BooleanType.html#pyspark.sql.types.BooleanType">BooleanType</a>: The leftmost column cast to <code class="docutils literal notranslate"><span class="pre">bool</span></code>
is returned or an exception is raised if the values cannot be coerced.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">'field1</span> <span class="pre">FIELD1_TYPE,</span> <span class="pre">field2</span> <span class="pre">FIELD2_TYPE,</span> <span class="pre">...'</span></code>: A struct type containing
multiple fields separated by comma, each field type must be one of types
listed above.</p></li>
</ul>
<p class="rubric">Example</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>

<span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
<span class="c1"># Suppose the PyFunc model `predict` method returns a dict like:</span>
<span class="c1"># `{&#39;prediction&#39;: 1-dim_array, &#39;probability&#39;: 2-dim_array}`</span>
<span class="c1"># You can supply result_type to be a struct type containing</span>
<span class="c1"># 2 fields &#39;prediction&#39; and &#39;probability&#39; like following.</span>
<span class="n">pyfunc_udf</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">pyfunc</span><span class="o">.</span><span class="n">spark_udf</span><span class="p">(</span>
    <span class="n">spark</span><span class="p">,</span> <span class="s2">&quot;&lt;path-to-model&gt;&quot;</span><span class="p">,</span> <span class="n">result_type</span><span class="o">=</span><span class="s2">&quot;prediction float, probability: array&lt;float&gt;&quot;</span>
<span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">spark_df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;prediction&quot;</span><span class="p">,</span> <span class="n">pyfunc_udf</span><span class="p">())</span>
</pre></div>
</div>
<p class="rubric">Example</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">ArrayType</span><span class="p">,</span> <span class="n">FloatType</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">struct</span>
<span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>

<span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
<span class="n">pyfunc_udf</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">pyfunc</span><span class="o">.</span><span class="n">spark_udf</span><span class="p">(</span>
    <span class="n">spark</span><span class="p">,</span> <span class="s2">&quot;path/to/model&quot;</span><span class="p">,</span> <span class="n">result_type</span><span class="o">=</span><span class="n">ArrayType</span><span class="p">(</span><span class="n">FloatType</span><span class="p">())</span>
<span class="p">)</span>
<span class="c1"># The prediction column will contain all the numeric columns returned by the model as floats</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">spark_df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;prediction&quot;</span><span class="p">,</span> <span class="n">pyfunc_udf</span><span class="p">(</span><span class="n">struct</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">)))</span>
</pre></div>
</div>
<p>If you want to use conda to restore the python environment that was used to train the model,
set the <cite>env_manager</cite> argument when calling <a class="reference internal" href="python_api/mlflow.pyfunc.html#mlflow.pyfunc.spark_udf" title="mlflow.pyfunc.spark_udf"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.pyfunc.spark_udf()</span></code></a>.</p>
<p class="rubric">Example</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">ArrayType</span><span class="p">,</span> <span class="n">FloatType</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">struct</span>
<span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>

<span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
<span class="n">pyfunc_udf</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">pyfunc</span><span class="o">.</span><span class="n">spark_udf</span><span class="p">(</span>
    <span class="n">spark</span><span class="p">,</span>
    <span class="s2">&quot;path/to/model&quot;</span><span class="p">,</span>
    <span class="n">result_type</span><span class="o">=</span><span class="n">ArrayType</span><span class="p">(</span><span class="n">FloatType</span><span class="p">()),</span>
    <span class="n">env_manager</span><span class="o">=</span><span class="s2">&quot;conda&quot;</span><span class="p">,</span>  <span class="c1"># Use conda to restore the environment used in training</span>
<span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">spark_df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;prediction&quot;</span><span class="p">,</span> <span class="n">pyfunc_udf</span><span class="p">(</span><span class="n">struct</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="deployment-to-custom-targets">
<span id="deployment-plugin"></span><h2><a class="toc-backref" href="#id30">Deployment to Custom Targets</a><a class="headerlink" href="#deployment-to-custom-targets" title="Permalink to this headline"> </a></h2>
<p>In addition to the built-in deployment tools, MLflow provides a pluggable
<a class="reference external" href="python_api/mlflow.deployments.html#mlflow.deployments">mlflow.deployments Python API</a> and
<a class="reference external" href="cli.html#mlflow-deployments">mlflow deployments CLI</a> for deploying
models to custom targets and environments. To deploy to a custom target, you must first install an
appropriate third-party Python plugin. See the list of known community-maintained plugins
<a class="reference external" href="plugins.html#deployment-plugins">here</a>.</p>
<div class="section" id="id18">
<h3>Commands<a class="headerlink" href="#id18" title="Permalink to this headline"> </a></h3>
<p>The <cite>mlflow deployments</cite> CLI contains the following commands, which can also be invoked programmatically
using the <a class="reference external" href="python_api/mlflow.deployments.html#mlflow.deployments">mlflow.deployments Python API</a>:</p>
<ul class="simple">
<li><p><a class="reference external" href="cli.html#mlflow-deployments-create">Create</a>: Deploy an MLflow model to a specified custom target</p></li>
<li><p><a class="reference external" href="cli.html#mlflow-deployments-delete">Delete</a>: Delete a deployment</p></li>
<li><p><a class="reference external" href="cli.html#mlflow-deployments-update">Update</a>: Update an existing deployment, for example to
deploy a new model version or change the deployment’s configuration (e.g. increase replica count)</p></li>
<li><p><a class="reference external" href="cli.html#mlflow-deployments-list">List</a>: List IDs of all deployments</p></li>
<li><p><a class="reference external" href="cli.html#mlflow-deployments-get">Get</a>: Print a detailed description of a particular deployment</p></li>
<li><p><a class="reference external" href="cli.html#mlflow-deployments-run-local">Run Local</a>: Deploy the model locally for testing</p></li>
<li><p><a class="reference external" href="cli.html#mlflow-deployments-help">Help</a>: Show the help string for the specified target</p></li>
</ul>
<p>For more info, see:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mlflow<span class="w"> </span>deployments<span class="w"> </span>--help
mlflow<span class="w"> </span>deployments<span class="w"> </span>create<span class="w"> </span>--help
mlflow<span class="w"> </span>deployments<span class="w"> </span>delete<span class="w"> </span>--help
mlflow<span class="w"> </span>deployments<span class="w"> </span>update<span class="w"> </span>--help
mlflow<span class="w"> </span>deployments<span class="w"> </span>list<span class="w"> </span>--help
mlflow<span class="w"> </span>deployments<span class="w"> </span>get<span class="w"> </span>--help
mlflow<span class="w"> </span>deployments<span class="w"> </span>run-local<span class="w"> </span>--help
mlflow<span class="w"> </span>deployments<span class="w"> </span><span class="nb">help</span><span class="w"> </span>--help
</pre></div>
</div>
</div>
</div>
<div class="section" id="community-model-flavors">
<h2><a class="toc-backref" href="#id31">Community Model Flavors</a><a class="headerlink" href="#community-model-flavors" title="Permalink to this headline"> </a></h2>
<p>Other useful MLflow flavors are developed and maintained by the
MLflow community, enabling you to use MLflow Models with an
even broader ecosystem of machine learning libraries. For more information,
check out the description of each community-developed flavor below.</p>
<div class="contents local topic" id="id20">
<ul class="simple">
<li><p><a class="reference internal" href="#mlflow-vizmod" id="id60">MLflow VizMod</a></p></li>
<li><p><a class="reference internal" href="#bigml-bigmlflow" id="id61">BigML (<code class="docutils literal notranslate"><span class="pre">bigmlflow</span></code>)</a></p></li>
<li><p><a class="reference internal" href="#sktime" id="id62">Sktime</a></p></li>
</ul>
</div>
<div class="section" id="mlflow-vizmod">
<h3><a class="toc-backref" href="#id60">MLflow VizMod</a><a class="headerlink" href="#mlflow-vizmod" title="Permalink to this headline"> </a></h3>
<p>The <a class="reference external" href="https://github.com/JHibbard/mlflow-vizmod/">mlflow-vizmod</a> project allows data scientists
to be more productive with their visualizations. We treat visualizations as models - just like ML
models - thus being able to use the same infrastructure as MLflow to track, create projects,
register, and deploy visualizations.</p>
<p>Installation:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pip<span class="w"> </span>install<span class="w"> </span>mlflow-vizmod
</pre></div>
</div>
<p>Example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">load_iris</span>
<span class="kn">import</span> <span class="nn">altair</span> <span class="k">as</span> <span class="nn">alt</span>
<span class="kn">import</span> <span class="nn">mlflow_vismod</span>

<span class="n">df_iris</span> <span class="o">=</span> <span class="n">load_iris</span><span class="p">(</span><span class="n">as_frame</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">viz_iris</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="n">df_iris</span><span class="p">)</span>
    <span class="o">.</span><span class="n">mark_circle</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
    <span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;z:N&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">properties</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="mi">375</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">575</span><span class="p">)</span>
    <span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">mlflow_vismod</span><span class="o">.</span><span class="n">log_model</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">viz_iris</span><span class="p">,</span>
    <span class="n">artifact_path</span><span class="o">=</span><span class="s2">&quot;viz&quot;</span><span class="p">,</span>
    <span class="n">style</span><span class="o">=</span><span class="s2">&quot;vegalite&quot;</span><span class="p">,</span>
    <span class="n">input_example</span><span class="o">=</span><span class="n">df_iris</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="bigml-bigmlflow">
<h3><a class="toc-backref" href="#id61">BigML (<code class="docutils literal notranslate"><span class="pre">bigmlflow</span></code>)</a><a class="headerlink" href="#bigml-bigmlflow" title="Permalink to this headline"> </a></h3>
<p>The <a class="reference external" href="https://github.com/bigmlcom/bigmlflow">bigmlflow</a> library implements
the <code class="docutils literal notranslate"><span class="pre">bigml</span></code> model flavor. It enables using
<a class="reference external" href="https://bigml.readthedocs.io/en/latest/local_resources.html">BigML supervised models</a>
and offers the <code class="docutils literal notranslate"><span class="pre">save_model()</span></code>, <code class="docutils literal notranslate"><span class="pre">log_model()</span></code> and <code class="docutils literal notranslate"><span class="pre">load_model()</span></code> methods.</p>
<div class="section" id="installing-bigmlflow">
<h4>Installing bigmlflow<a class="headerlink" href="#installing-bigmlflow" title="Permalink to this headline"> </a></h4>
<p>BigMLFlow can be installed from PyPI as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pip<span class="w"> </span>install<span class="w"> </span>bigmlflow
</pre></div>
</div>
</div>
<div class="section" id="bigmlflow-usage">
<h4>BigMLFlow usage<a class="headerlink" href="#bigmlflow-usage" title="Permalink to this headline"> </a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">bigmlflow</span></code> module defines the flavor that implements the
<code class="docutils literal notranslate"><span class="pre">save_model()</span></code> and <code class="docutils literal notranslate"><span class="pre">log_model()</span></code> methods. They can be used
to save BigML models and their related information in MLflow Model format.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">mlflow</span>
<span class="kn">import</span> <span class="nn">bigmlflow</span>

<span class="n">MODEL_FILE</span> <span class="o">=</span> <span class="s2">&quot;logistic_regression.json&quot;</span>
<span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">():</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">MODEL_FILE</span><span class="p">)</span> <span class="k">as</span> <span class="n">handler</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
        <span class="n">bigmlflow</span><span class="o">.</span><span class="n">log_model</span><span class="p">(</span>
            <span class="n">model</span><span class="p">,</span> <span class="n">artifact_path</span><span class="o">=</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">registered_model_name</span><span class="o">=</span><span class="s2">&quot;my_model&quot;</span>
        <span class="p">)</span>
</pre></div>
</div>
<p>These methods also add the <code class="docutils literal notranslate"><span class="pre">python_function</span></code> flavor to the MLflow Models
that they produce, allowing the models to be interpreted as generic Python
functions for inference via <a class="reference internal" href="python_api/mlflow.pyfunc.html#mlflow.pyfunc.load_model" title="mlflow.pyfunc.load_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.pyfunc.load_model()</span></code></a>.
This loaded PyFunc model can only be scored with DataFrame inputs.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># saving the model</span>
<span class="n">save_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">model_path</span><span class="p">)</span>
<span class="c1"># retrieving model</span>
<span class="n">pyfunc_model</span> <span class="o">=</span> <span class="n">pyfunc</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>
<span class="n">pyfunc_predictions</span> <span class="o">=</span> <span class="n">pyfunc_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">dataframe</span><span class="p">)</span>
</pre></div>
</div>
<p>You can also use the <code class="docutils literal notranslate"><span class="pre">bigmlflow.load_model()</span></code> method to load MLflow Models
with the <code class="docutils literal notranslate"><span class="pre">bigmlflow</span></code> model flavor as a BigML
<a class="reference external" href="https://bigml.readthedocs.io/en/latest/local_resources.html#local-supervised-model">SupervisedModel</a>.</p>
<p>For more information, see the
<a class="reference external" href="https://bigmlflow.readthedocs.io/en/latest/">BigMLFlow documentation</a>
and <a class="reference external" href="https://blog.bigml.com/2022/10/25/easily-operating-machine-learning-models/">BigML’s blog</a>.</p>
</div>
</div>
<div class="section" id="sktime">
<h3><a class="toc-backref" href="#id62">Sktime</a><a class="headerlink" href="#sktime" title="Permalink to this headline"> </a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">sktime</span></code> custom model flavor enables logging of <a class="reference external" href="https://github.com/sktime/sktime">sktime</a> models in MLflow
format via the <code class="docutils literal notranslate"><span class="pre">save_model()</span></code> and <code class="docutils literal notranslate"><span class="pre">log_model()</span></code> methods. These methods also add the <code class="docutils literal notranslate"><span class="pre">python_function</span></code> flavor to the MLflow Models that they produce, allowing the
model to be interpreted as generic Python functions for inference via <a class="reference internal" href="python_api/mlflow.pyfunc.html#mlflow.pyfunc.load_model" title="mlflow.pyfunc.load_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.pyfunc.load_model()</span></code></a>.
This loaded PyFunc model can only be scored with a DataFrame input.
You can also use the <code class="docutils literal notranslate"><span class="pre">load_model()</span></code> method to load MLflow Models with the <code class="docutils literal notranslate"><span class="pre">sktime</span></code>
model flavor in native sktime formats.</p>
<div class="section" id="installing-sktime">
<h4>Installing Sktime<a class="headerlink" href="#installing-sktime" title="Permalink to this headline"> </a></h4>
<p>Install sktime with mlflow dependency:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pip<span class="w"> </span>install<span class="w"> </span>sktime<span class="o">[</span>mlflow<span class="o">]</span>
</pre></div>
</div>
</div>
<div class="section" id="usage-example">
<h4>Usage example<a class="headerlink" href="#usage-example" title="Permalink to this headline"> </a></h4>
<p>Refer to the <a class="reference external" href="https://www.sktime.org/en/latest/api_reference/deployment.html">sktime mlflow documentation</a> for details on the interface for utilizing sktime models loaded as a pyfunc type and an <a class="reference external" href="https://github.com/sktime/sktime/blob/main/examples/mlflow.ipynb">example notebook</a> for extended code usage examples.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">sktime.datasets</span> <span class="kn">import</span> <span class="n">load_airline</span>
<span class="kn">from</span> <span class="nn">sktime.forecasting.arima</span> <span class="kn">import</span> <span class="n">AutoARIMA</span>
<span class="kn">from</span> <span class="nn">sktime.utils</span> <span class="kn">import</span> <span class="n">mlflow_sktime</span>

<span class="n">airline</span> <span class="o">=</span> <span class="n">load_airline</span><span class="p">()</span>
<span class="n">model_path</span> <span class="o">=</span> <span class="s2">&quot;model&quot;</span>


<span class="n">auto_arima_model</span> <span class="o">=</span> <span class="n">AutoARIMA</span><span class="p">(</span><span class="n">sp</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_p</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">max_q</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">suppress_warnings</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">airline</span><span class="p">,</span> <span class="n">fh</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">mlflow_sktime</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span>
    <span class="n">sktime_model</span><span class="o">=</span><span class="n">auto_arima_model</span><span class="p">,</span>
    <span class="n">path</span><span class="o">=</span><span class="n">model_path</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">loaded_model</span> <span class="o">=</span> <span class="n">mlflow_sktime</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span>
    <span class="n">model_uri</span><span class="o">=</span><span class="n">model_path</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">loaded_pyfunc</span> <span class="o">=</span> <span class="n">mlflow_sktime</span><span class="o">.</span><span class="n">pyfunc</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span>
    <span class="n">model_uri</span><span class="o">=</span><span class="n">model_path</span><span class="p">,</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">loaded_model</span><span class="o">.</span><span class="n">predict</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">loaded_pyfunc</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()))</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>


              </div>
            </div>
            <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="projects.html" class="btn btn-neutral" title="MLflow Projects" accesskey="p"><span class="db-icon db-icon-chevron-left"></span> Previous</a>
      
      
        <a href="model-registry.html" class="btn btn-neutral" title="MLflow Model Registry" accesskey="n">Next <span class="db-icon db-icon-chevron-right"></span></a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
      <p class="copyright">
          &copy; MLflow Project, a Series of LF Projects, LLC. All rights reserved.
      </p>

  </div> 

</footer>
          </div>
        </div>
      </section>
    </main>
  </page>

  


  
  <script type="text/javascript">
    var DOCUMENTATION_OPTIONS = {
      URL_ROOT:'./',
      VERSION:'2.2.2',
      COLLAPSE_INDEX:false,
      FILE_SUFFIX:'.html',
      LINK_SUFFIX: '.html',
      HAS_SOURCE:  true
    };
  </script>

  

  <script type="text/javascript" src="_static/js/clipboard.min.js"></script>
  <script type="text/javascript" src="_static/js/jquery.waypoints.min.js"></script>

  
  
  
  <script type="text/javascript">var CLIPPY_SVG_PATH = "_static/clippy.svg";</script>
  <script type="text/javascript" src="_static/js/custom.js"></script>
  

  
  
  <script type="text/javascript">
    jQuery(function () {
      SphinxRtdTheme.StickyNav.enable();
    });

  </script>
   
</body>
</html>